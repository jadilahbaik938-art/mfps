<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MFPS — Recording & Reporting</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap');
:root{
  --navy:#0A1F3F;--blue:#0058A3;--teal:#00838F;--red:#E21F26;--green:#0D8048;--gold:#B8860B;
  --bg:#F0F2F7;--card:#FFF;--txt:#1A1A2E;--txt2:#4B5563;--muted:#9CA3AF;--bdr:#E5E7EB;
  --r:12px;--r2:16px;--orange:#EA580C;--purple:#7C3AED;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden}

/* === STATUS BAR === */
.sbar{background:var(--navy);color:#fff;padding:6px 16px;font-size:10px;display:flex;justify-content:space-between;align-items:center}
.sbar-t{font-family:'JetBrains Mono',monospace;font-weight:600}

/* === HEADER === */
.hdr{background:#fff;padding:12px 16px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.hdr-l{display:flex;align-items:center;gap:10px}
.hdr-bk{width:34px;height:34px;border-radius:10px;border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--txt2);font-size:14px;background:#fff;text-decoration:none;transition:.15s}
.hdr-bk:hover{background:var(--bg);border-color:var(--navy);color:var(--navy)}
.hdr-tt{font-size:15px;font-weight:700}.hdr-sub{font-size:10px;color:var(--muted)}

/* === TABS === */
.tabs{display:flex;background:#fff;border-bottom:2px solid var(--bdr);overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab{flex:1;min-width:0;padding:12px 8px;text-align:center;font-size:11px;font-weight:600;color:var(--muted);cursor:pointer;border-bottom:2.5px solid transparent;transition:.2s;white-space:nowrap;display:flex;align-items:center;justify-content:center;gap:5px}
.tab.on{color:var(--navy);border-bottom-color:var(--blue);background:#F5F8FF}
.tab:hover{color:var(--navy);background:#FAFBFF}
.tab i{font-size:12px}

/* === MAIN CONTENT === */
.main{padding:16px;max-width:1400px;margin:0 auto}
.section{display:none;animation:fi .3s ease}.section.on{display:block}
@keyframes fi{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* === STAT CARDS === */
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
.stat{background:#fff;border-radius:var(--r2);padding:16px;border-left:4px solid transparent;box-shadow:0 1px 4px rgba(0,0,0,.04);position:relative;overflow:hidden}
.stat::after{content:'';position:absolute;top:-20px;right:-20px;width:60px;height:60px;border-radius:50%;opacity:.06}
.stat-num{font-size:28px;font-weight:900;letter-spacing:-1px;line-height:1}
.stat-label{font-size:10px;color:var(--txt2);margin-top:4px;font-weight:500}
.stat-trend{font-size:9px;font-weight:700;margin-top:6px;display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:20px}
.stat.s-out{border-left-color:var(--red)}.stat.s-out .stat-num{color:var(--red)}.stat.s-out::after{background:var(--red)}
.stat.s-in{border-left-color:var(--blue)}.stat.s-in .stat-num{color:var(--blue)}.stat.s-in::after{background:var(--blue)}
.stat.s-ok{border-left-color:var(--green)}.stat.s-ok .stat-num{color:var(--green)}.stat.s-ok::after{background:var(--green)}
.stat.s-exc{border-left-color:var(--orange)}.stat.s-exc .stat-num{color:var(--orange)}.stat.s-exc::after{background:var(--orange)}
.stat.s-rej{border-left-color:var(--red)}.stat.s-rej .stat-num{color:var(--red)}
.stat.s-pen{border-left-color:var(--gold)}.stat.s-pen .stat-num{color:var(--gold)}

/* === CARDS === */
.cd{background:#fff;border-radius:var(--r2);border:1.5px solid var(--bdr);overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.03)}
.cd-h{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bdr);background:#FAFBFC}
.cd-t{font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px}
.cd-t i{font-size:14px}
.cd-b{padding:14px 16px}
.cd-act{display:flex;gap:6px}

/* === CHART === */
.chart-wrap{position:relative;width:100%;height:220px;margin:8px 0}

/* === TABLE === */
.tbl-wrap{overflow-x:auto;border:1px solid var(--bdr);border-radius:10px;margin-top:8px}
table{width:100%;border-collapse:collapse;font-size:11px;min-width:700px}
th{background:#F3F4F6;padding:10px 12px;text-align:left;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--txt2);border-bottom:2px solid var(--bdr);position:sticky;top:0}
td{padding:9px 12px;border-bottom:1px solid #F3F4F6;vertical-align:top}
tr:hover td{background:#F8FAFF}

/* === BADGES === */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:.3px}
.b-green{background:#D1FAE5;color:#065F46}.b-red{background:#FEE2E2;color:#991B1B}
.b-blue{background:#DBEAFE;color:#1E40AF}.b-orange{background:#FFEDD5;color:#9A3412}
.b-gold{background:#FEF3C7;color:#92400E}.b-purple{background:#EDE9FE;color:#5B21B6}
.b-gray{background:#F3F4F6;color:#4B5563}

/* === AUDIT LOG === */
.log-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #F3F4F6;position:relative}
.log-item:last-child{border-bottom:none}
.log-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;flex-shrink:0}
.log-content{flex:1;min-width:0}
.log-title{font-size:12px;font-weight:600;margin-bottom:2px}
.log-meta{font-size:10px;color:var(--muted);line-height:1.5}
.log-time{font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--muted);flex-shrink:0;text-align:right}

/* === FILTER BAR === */
.fbar{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.fbar select,.fbar input{padding:8px 12px;border:1.5px solid var(--bdr);border-radius:8px;font-family:'Outfit',sans-serif;font-size:11px;background:#fff;color:var(--txt);outline:none;transition:.2s}
.fbar select:focus,.fbar input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,88,163,.1)}
.fbar input{flex:1;min-width:120px}

/* === BUTTONS === */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;cursor:pointer;border:none;transition:.2s}
.btn-primary{background:var(--navy);color:#fff}.btn-primary:hover{background:#0E2A4F}
.btn-export{background:#fff;color:var(--green);border:1.5px solid var(--green)}.btn-export:hover{background:#F0FDF4}
.btn-pdf{background:#fff;color:var(--red);border:1.5px solid var(--red)}.btn-pdf:hover{background:#FEF2F2}
.btn-sm{padding:6px 12px;font-size:10px;border-radius:6px}

/* === PAGINATION === */
.pagi{display:flex;align-items:center;justify-content:space-between;margin-top:12px;font-size:11px;color:var(--txt2)}
.pagi-btns{display:flex;gap:4px}
.pagi-btn{width:30px;height:30px;border-radius:6px;border:1px solid var(--bdr);background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;font-weight:600;transition:.15s}
.pagi-btn.on{background:var(--navy);color:#fff;border-color:var(--navy)}
.pagi-btn:hover:not(.on){background:var(--bg)}

/* === SUMMARY BOXES === */
.summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.summary-box{background:#fff;border-radius:var(--r);padding:14px;text-align:center;border:1px solid var(--bdr)}
.summary-box-num{font-size:22px;font-weight:800;line-height:1.1}
.summary-box-label{font-size:9px;color:var(--txt2);margin-top:4px;text-transform:uppercase;letter-spacing:.5px;font-weight:600}

/* === DONUT WRAPPER === */
.donut-wrap{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
.donut-chart{width:140px;height:140px;flex-shrink:0}
.donut-legend{flex:1;min-width:120px}
.donut-legend-item{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:11px}
.donut-legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

/* === RESPONSIVE DESKTOP === */
@media(min-width:768px){
  .stats{grid-template-columns:repeat(3,1fr)}
  .summary-grid{grid-template-columns:repeat(6,1fr)}
  .chart-wrap{height:300px}
  .main{padding:24px}
  .cd-b{padding:18px 20px}
  .hdr{padding:14px 24px}
  .tabs{justify-content:center}
  .tab{flex:none;padding:14px 24px;font-size:12px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px}
}
@media(min-width:1200px){
  .stats{grid-template-columns:repeat(6,1fr)}
  .stat-num{font-size:32px}
  .main{padding:28px 40px}
}
</style>
</head>
<body>

<!-- STATUS BAR -->
<div class="sbar">
  <span>MFPS Recording & Reporting</span>
  <span class="sbar-t" id="clock">--:--</span>
  <span>RU V Balikpapan</span>
</div>

<!-- HEADER -->
<div class="hdr">
  <div class="hdr-l">
    <a class="hdr-bk" href="index.html"><i class="fas fa-arrow-left"></i></a>
    <div>
      <div class="hdr-tt"><i class="fas fa-chart-line" style="color:var(--blue);margin-right:4px"></i> Recording & Reporting</div>
      <div class="hdr-sub">ISO 31000:2018 Compliance · Dashboard Analitik</div>
    </div>
  </div>
  <div style="display:flex;gap:6px">
    <button class="btn btn-sm btn-export" onclick="exportAllExcel()"><i class="fas fa-file-excel"></i> Excel</button>
    <button class="btn btn-sm btn-pdf" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <div class="tab on" onclick="showTab('dashboard',this)"><i class="fas fa-chart-pie"></i> Dashboard</div>
  <div class="tab" onclick="showTab('audit',this)"><i class="fas fa-clipboard-list"></i> Audit Trail</div>
  <div class="tab" onclick="showTab('records',this)"><i class="fas fa-database"></i> Data Record</div>
  <div class="tab" onclick="showTab('trends',this)"><i class="fas fa-chart-area"></i> Tren & Grafik</div>
</div>

<!-- ============== SECTION 1: DASHBOARD ============== -->
<div class="main">
<div class="section on" id="sec-dashboard">

  <!-- Summary Stats -->
  <div class="stats" id="statCards">
    <div class="stat s-out">
      <div class="stat-num" id="totalOut">247</div>
      <div class="stat-label">Barang Keluar (MRA)</div>
      <div class="stat-trend" style="background:#FEE2E2;color:var(--red)"><i class="fas fa-arrow-up"></i> +12 hari ini</div>
    </div>
    <div class="stat s-in">
      <div class="stat-num" id="totalIn">183</div>
      <div class="stat-label">Barang Masuk (DO)</div>
      <div class="stat-trend" style="background:#DBEAFE;color:var(--blue)"><i class="fas fa-arrow-up"></i> +8 hari ini</div>
    </div>
    <div class="stat s-ok">
      <div class="stat-num" id="totalApproved">389</div>
      <div class="stat-label">Approved</div>
      <div class="stat-trend" style="background:#D1FAE5;color:var(--green)"><i class="fas fa-check"></i> 90.5%</div>
    </div>
    <div class="stat s-exc">
      <div class="stat-num" id="totalException">23</div>
      <div class="stat-label">Exception/Urgent</div>
      <div class="stat-trend" style="background:#FFEDD5;color:var(--orange)"><i class="fas fa-exclamation-triangle"></i> 5.3%</div>
    </div>
    <div class="stat s-rej">
      <div class="stat-num" id="totalRejected">11</div>
      <div class="stat-label">Rejected</div>
      <div class="stat-trend" style="background:#FEE2E2;color:var(--red)"><i class="fas fa-times"></i> 2.6%</div>
    </div>
    <div class="stat s-pen">
      <div class="stat-num" id="totalPending">7</div>
      <div class="stat-label">Pending Review</div>
      <div class="stat-trend" style="background:#FEF3C7;color:var(--gold)"><i class="fas fa-clock"></i> 1.6%</div>
    </div>
  </div>

  <div class="two-col">
    <!-- Chart: Daily Movement -->
    <div class="cd">
      <div class="cd-h">
        <div class="cd-t"><i class="fas fa-chart-bar" style="color:var(--blue)"></i> Pergerakan Harian (7 Hari)</div>
        <select id="chartPeriod" onchange="updateDailyChart()" style="padding:4px 8px;border:1px solid var(--bdr);border-radius:6px;font-size:10px;font-family:'Outfit',sans-serif">
          <option value="7">7 Hari</option>
          <option value="14">14 Hari</option>
          <option value="30">30 Hari</option>
        </select>
      </div>
      <div class="cd-b">
        <div class="chart-wrap"><canvas id="chartDaily"></canvas></div>
      </div>
    </div>

    <!-- Chart: Approval Status -->
    <div class="cd">
      <div class="cd-h">
        <div class="cd-t"><i class="fas fa-chart-pie" style="color:var(--green)"></i> Status Approval</div>
      </div>
      <div class="cd-b">
        <div class="donut-wrap">
          <div class="donut-chart"><canvas id="chartDonut"></canvas></div>
          <div class="donut-legend" id="donutLegend"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Vendors & Gate Stats -->
  <div class="two-col">
    <div class="cd">
      <div class="cd-h">
        <div class="cd-t"><i class="fas fa-building" style="color:var(--teal)"></i> Top 5 Vendor / Perusahaan</div>
      </div>
      <div class="cd-b">
        <div id="topVendors"></div>
      </div>
    </div>
    <div class="cd">
      <div class="cd-h">
        <div class="cd-t"><i class="fas fa-door-open" style="color:var(--navy)"></i> Distribusi per Gate</div>
      </div>
      <div class="cd-b">
        <div class="chart-wrap" style="height:180px"><canvas id="chartGate"></canvas></div>
      </div>
    </div>
  </div>

</div>

<!-- ============== SECTION 2: AUDIT TRAIL ============== -->
<div class="section" id="sec-audit">
  <div class="fbar">
    <select id="auditFilter" onchange="renderAudit()">
      <option value="">Semua Aktivitas</option>
      <option value="submit">MRA Submit</option>
      <option value="approve">Approved</option>
      <option value="reject">Rejected</option>
      <option value="verify">Verified</option>
      <option value="stamp">Stamp Applied</option>
      <option value="exception">Exception</option>
      <option value="gate_pass">Gate Pass</option>
    </select>
    <select id="auditRole" onchange="renderAudit()">
      <option value="">Semua Role</option>
      <option value="Creator">Creator</option>
      <option value="Function Head">Function Head</option>
      <option value="Legality Officer">Legality Officer</option>
      <option value="Gate Inspector">Gate Inspector</option>
      <option value="SSH">Security Section Head</option>
    </select>
    <input type="date" id="auditDate" onchange="renderAudit()">
    <input type="text" id="auditSearch" placeholder="Cari MRA ID, nama, vendor..." oninput="renderAudit()">
  </div>
  <div class="cd">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-clipboard-list" style="color:var(--purple)"></i> Audit Trail Log</div>
      <span class="badge b-purple" id="auditCount">0 record</span>
    </div>
    <div class="cd-b" id="auditList" style="max-height:600px;overflow-y:auto">
    </div>
    <div class="pagi" id="auditPagi"></div>
  </div>
</div>

<!-- ============== SECTION 3: DATA RECORDS ============== -->
<div class="section" id="sec-records">
  <div class="fbar">
    <select id="recType" onchange="renderRecords()">
      <option value="">Semua Tipe</option>
      <option value="keluar">Barang Keluar</option>
      <option value="masuk">Barang Masuk</option>
    </select>
    <select id="recStatus" onchange="renderRecords()">
      <option value="">Semua Status</option>
      <option value="Completed">Completed</option>
      <option value="Approved">Approved</option>
      <option value="Pending">Pending</option>
      <option value="Rejected">Rejected</option>
      <option value="Exception">Exception</option>
    </select>
    <input type="text" id="recSearch" placeholder="Cari No. MRA, vendor, material..." oninput="renderRecords()">
    <button class="btn btn-sm btn-export" onclick="exportRecordsCSV()"><i class="fas fa-download"></i> Export CSV</button>
  </div>
  <div class="cd">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-database" style="color:var(--blue)"></i> Data Pergerakan Barang</div>
      <span class="badge b-blue" id="recCount">0 record</span>
    </div>
    <div class="cd-b" style="padding:0">
      <div class="tbl-wrap" style="max-height:500px;overflow-y:auto">
        <table>
          <thead>
            <tr>
              <th>No</th>
              <th>Tanggal</th>
              <th>No. MRA/DO</th>
              <th>Tipe</th>
              <th>Vendor / Perusahaan</th>
              <th>Material</th>
              <th>Qty</th>
              <th>Gate</th>
              <th>No. Polisi</th>
              <th>Status</th>
              <th>Physical Check</th>
            </tr>
          </thead>
          <tbody id="recTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="pagi" id="recPagi" style="padding:10px 16px"></div>
  </div>
</div>

<!-- ============== SECTION 4: TRENDS ============== -->
<div class="section" id="sec-trends">
  <div class="summary-grid">
    <div class="summary-box"><div class="summary-box-num" style="color:var(--navy)">430</div><div class="summary-box-label">Total Transaksi</div></div>
    <div class="summary-box"><div class="summary-box-num" style="color:var(--red)">247</div><div class="summary-box-label">Outbound</div></div>
    <div class="summary-box"><div class="summary-box-num" style="color:var(--blue)">183</div><div class="summary-box-label">Inbound</div></div>
    <div class="summary-box"><div class="summary-box-num" style="color:var(--green)">90.5%</div><div class="summary-box-label">Approval Rate</div></div>
    <div class="summary-box"><div class="summary-box-num" style="color:var(--orange)">2.3 jam</div><div class="summary-box-label">Avg Process</div></div>
    <div class="summary-box"><div class="summary-box-num" style="color:var(--purple)">15</div><div class="summary-box-label">Unique Vendors</div></div>
  </div>

  <div class="two-col">
    <div class="cd">
      <div class="cd-h">
        <div class="cd-t"><i class="fas fa-chart-area" style="color:var(--teal)"></i> Tren Bulanan (6 Bulan)</div>
      </div>
      <div class="cd-b">
        <div class="chart-wrap"><canvas id="chartMonthly"></canvas></div>
      </div>
    </div>
    <div class="cd">
      <div class="cd-h">
        <div class="cd-t"><i class="fas fa-chart-line" style="color:var(--red)"></i> Rejection Rate Trend</div>
      </div>
      <div class="cd-b">
        <div class="chart-wrap"><canvas id="chartRejection"></canvas></div>
      </div>
    </div>
  </div>

  <div class="cd">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-clock" style="color:var(--gold)"></i> Average Processing Time per Step</div>
    </div>
    <div class="cd-b">
      <div class="chart-wrap" style="height:200px"><canvas id="chartProcessTime"></canvas></div>
    </div>
  </div>

  <div class="cd">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-boxes-stacked" style="color:var(--orange)"></i> Top Material Categories</div>
    </div>
    <div class="cd-b">
      <div class="chart-wrap"><canvas id="chartMaterial"></canvas></div>
    </div>
  </div>
</div>

</div><!-- /main -->

<script>
// ===== CLOCK =====
function uc(){const t=new Date().toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',timeZone:'Asia/Makassar'})+' WITA';document.getElementById('clock').textContent=t}uc();setInterval(uc,30000);

// ===== TABS =====
function showTab(id,el){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.getElementById('sec-'+id).classList.add('on');
  el.classList.add('on');
}

// ===== REALISTIC DATA GENERATION =====
const vendors=['PT. PM CONTROL SYSTEMS','PT. BELANI MURA','PT. AMAN NIAGA','PT. BMKP','PT. CONTROL SYSTEMS','PT. STRIVECHEN INDONESIA','PT. FITRIAWAN PUTRA','PT. RAMON JAYA ABADI WISESA','CV. TRISURYA GEMILANG','PT. JOHN CRANE','PT. MALEWA','PT. PAR TEKNIK','PT. KRAKATAU STEEL','CV. BORNEO SUPPLY','PT. WIKA KONSTRUKSI'];
const materials=['Material','Overhaul Governor','Besi Holo','Catridge Masker','Chemical','Paving Blok','Sampah Non Metal','Limbah Logam','MOV T904','Check Valve','Plat Ex Used Pit Stop','Tabung Gas Kosong','GM-3-11 C','G-201-13 A','Pipa Schedule 40','Gasket Spiral Wound','Bolt & Nut Set'];
const gates=['Gate Utama','Gate Selatan','Gate Dermaga','Gate Workshop'];
const roles=['Creator','Function Head','Legality Officer','Gate Inspector'];
const creators=['Rizky Pratama','Hendra Wijaya','Sardi','Hafis','Fendy','Robinson','Nasir','Afandi','Aditya','Bayu','Wahyu','Bili','Sumardin','M. Nur','Darwis','Emanuel','Haris','Fredy','Yuyun','Hery'];

function rnd(arr){return arr[Math.floor(Math.random()*arr.length)]}
function rndInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}

// Generate transaction records
const records=[];
const auditLogs=[];
const baseDate=new Date(2026,1,25); // Feb 25, 2026

for(let i=0;i<430;i++){
  const daysAgo=Math.floor(i/14);
  const d=new Date(baseDate);d.setDate(d.getDate()-daysAgo);
  const h=rndInt(6,17),m=rndInt(0,59);
  d.setHours(h,m,0,0);

  const isOut=i<247;
  const statusArr=['Completed','Completed','Completed','Completed','Completed','Completed','Completed','Approved','Approved','Pending','Rejected','Exception'];
  const status=i<400?statusArr[i%statusArr.length]:(i<411?'Rejected':(i<423?'Exception':'Pending'));
  const vendor=rnd(vendors);
  const mat=rnd(materials);
  const gate=rnd(gates);
  const creator=rnd(creators);
  const nopol='KT '+rndInt(1000,9999)+' '+['YQ','ZU','CO','YY','ZI','VG','KU','FVD','HE','ZK','YO','ZG','YZ','ZJ'][rndInt(0,13)];
  const mraId=(isOut?'MRA':'DO')+'-2026-'+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0')+'-'+String(i+1).padStart(3,'0');
  const qty=rndInt(1,800);
  const unit=['Unit','Item','Batang','Set','Pcs','Ret','Kg','Lot','Cyl'][rndInt(0,8)];

  records.push({
    id:mraId, date:d, type:isOut?'keluar':'masuk', vendor, material:mat, qty, unit,
    gate, nopol, driver:creator, status, physCheck:status==='Completed'?'OK':(status==='Rejected'?'FAIL':'—')
  });

  // Generate audit logs for each record (multi-step)
  const steps=['submit','approve','verify','stamp','gate_pass'];
  const stepLabels=['MRA Submitted','Approved by Function Head','Verified by Legality Officer','Digital Stamp Applied','Gate Pass Released'];
  const stepRoles=['Creator','Function Head','Legality Officer','Legality Officer','Gate Inspector'];
  const stepColors=['var(--blue)','var(--green)','var(--purple)','var(--gold)','var(--teal)'];

  const numSteps=status==='Completed'?5:(status==='Approved'?2:(status==='Rejected'?2:(status==='Pending'?1:3)));
  for(let s=0;s<numSteps;s++){
    const logTime=new Date(d);logTime.setMinutes(logTime.getMinutes()+s*rndInt(15,90));
    auditLogs.push({
      action:steps[s],
      label:status==='Rejected'&&s===1?'Rejected by Function Head':stepLabels[s],
      role:stepRoles[s],
      person:rnd(creators),
      mraId,
      vendor,
      time:logTime,
      color:status==='Rejected'&&s===1?'var(--red)':stepColors[s]
    });
  }
  if(status==='Exception'){
    auditLogs.push({action:'exception',label:'Exception Approved by SSH',role:'SSH',person:'Andri Yulianto',mraId,vendor,time:new Date(d.getTime()+rndInt(30,120)*60000),color:'var(--orange)'});
  }
}

// Sort audit logs by time descending
auditLogs.sort((a,b)=>b.time-a.time);
records.sort((a,b)=>b.date-a.date);

// ===== DASHBOARD CHARTS =====
let dailyChart,donutChart,gateChart,monthlyChart,rejectionChart,processChart,materialChart;

function initDashboard(){
  updateDailyChart();
  initDonutChart();
  renderTopVendors();
  initGateChart();
}

function updateDailyChart(){
  const days=parseInt(document.getElementById('chartPeriod').value)||7;
  const labels=[],outData=[],inData=[];

  for(let i=days-1;i>=0;i--){
    const d=new Date(baseDate);d.setDate(d.getDate()-i);
    const ds=d.toLocaleDateString('id-ID',{day:'2-digit',month:'short'});
    labels.push(ds);
    const dayRecs=records.filter(r=>r.date.toDateString()===d.toDateString());
    outData.push(dayRecs.filter(r=>r.type==='keluar').length);
    inData.push(dayRecs.filter(r=>r.type==='masuk').length);
  }

  if(dailyChart)dailyChart.destroy();
  dailyChart=new Chart(document.getElementById('chartDaily'),{
    type:'bar',
    data:{
      labels,
      datasets:[
        {label:'Barang Keluar',data:outData,backgroundColor:'rgba(226,31,38,.75)',borderRadius:4,barPercentage:.4},
        {label:'Barang Masuk',data:inData,backgroundColor:'rgba(0,88,163,.75)',borderRadius:4,barPercentage:.4}
      ]
    },
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:10,family:'Outfit'}}}},scales:{y:{beginAtZero:true,ticks:{font:{size:10}}},x:{ticks:{font:{size:9}}}}}
  });
}

function initDonutChart(){
  const data=[389,23,11,7];
  const labels=['Approved','Exception','Rejected','Pending'];
  const colors=['#0D8048','#EA580C','#E21F26','#B8860B'];

  donutChart=new Chart(document.getElementById('chartDonut'),{
    type:'doughnut',
    data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:2,borderColor:'#fff'}]},
    options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{display:false}}}
  });

  const legend=document.getElementById('donutLegend');
  legend.innerHTML=labels.map((l,i)=>`<div class="donut-legend-item"><div class="donut-legend-dot" style="background:${colors[i]}"></div><span><b>${data[i]}</b> ${l} (${(data[i]/430*100).toFixed(1)}%)</span></div>`).join('');
}

function renderTopVendors(){
  const counts={};
  records.forEach(r=>{counts[r.vendor]=(counts[r.vendor]||0)+1});
  const sorted=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const max=sorted[0][1];

  document.getElementById('topVendors').innerHTML=sorted.map(([v,c],i)=>{
    const pct=Math.round(c/max*100);
    const colors=['var(--blue)','var(--teal)','var(--green)','var(--orange)','var(--purple)'];
    return `<div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px"><span style="font-weight:600">${i+1}. ${v}</span><span style="font-weight:700;color:${colors[i]}">${c} transaksi</span></div>
      <div style="height:6px;background:#F3F4F6;border-radius:3px;overflow:hidden"><div style="height:100%;width:${pct}%;background:${colors[i]};border-radius:3px;transition:width .5s"></div></div>
    </div>`;
  }).join('');
}

function initGateChart(){
  const counts={};
  records.forEach(r=>{counts[r.gate]=(counts[r.gate]||0)+1});
  const labels=Object.keys(counts),data=Object.values(counts);

  gateChart=new Chart(document.getElementById('chartGate'),{
    type:'bar',
    data:{labels,datasets:[{data,backgroundColor:['#0A1F3F','#0058A3','#00838F','#0D8048'],borderRadius:6,barPercentage:.5}]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,ticks:{font:{size:10}}},y:{ticks:{font:{size:10,family:'Outfit'}}}}}
  });
}

// ===== AUDIT TRAIL =====
let auditPage=1;
const AUDIT_PER_PAGE=20;

function renderAudit(){
  const filter=document.getElementById('auditFilter').value;
  const role=document.getElementById('auditRole').value;
  const date=document.getElementById('auditDate').value;
  const search=(document.getElementById('auditSearch').value||'').toLowerCase();

  let filtered=auditLogs.filter(l=>{
    if(filter&&l.action!==filter)return false;
    if(role&&l.role!==role)return false;
    if(date&&l.time.toISOString().split('T')[0]!==date)return false;
    if(search&&!(l.mraId.toLowerCase().includes(search)||l.person.toLowerCase().includes(search)||l.vendor.toLowerCase().includes(search)||l.label.toLowerCase().includes(search)))return false;
    return true;
  });

  document.getElementById('auditCount').textContent=filtered.length+' record';
  const totalPages=Math.ceil(filtered.length/AUDIT_PER_PAGE)||1;
  if(auditPage>totalPages)auditPage=1;
  const start=(auditPage-1)*AUDIT_PER_PAGE;
  const page=filtered.slice(start,start+AUDIT_PER_PAGE);

  const icons={submit:'fa-paper-plane',approve:'fa-check-circle',reject:'fa-times-circle',verify:'fa-user-shield',stamp:'fa-stamp',exception:'fa-exclamation-triangle',gate_pass:'fa-door-open'};

  document.getElementById('auditList').innerHTML=page.map(l=>`
    <div class="log-item">
      <div class="log-icon" style="background:${l.color}"><i class="fas ${icons[l.action]||'fa-circle'}"></i></div>
      <div class="log-content">
        <div class="log-title">${l.label}</div>
        <div class="log-meta">
          <span style="color:var(--navy);font-weight:600">${l.mraId}</span> · ${l.vendor}<br>
          <i class="fas fa-user" style="font-size:8px"></i> ${l.person} · <span class="badge b-gray">${l.role}</span>
        </div>
      </div>
      <div class="log-time">${l.time.toLocaleDateString('id-ID',{day:'2-digit',month:'short'})}<br>${l.time.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',hour12:false})}</div>
    </div>
  `).join('');

  // Pagination
  let pHtml=`<span>Halaman ${auditPage} dari ${totalPages} (${filtered.length} record)</span><div class="pagi-btns">`;
  if(auditPage>1)pHtml+=`<div class="pagi-btn" onclick="auditPage--;renderAudit()"><i class="fas fa-chevron-left"></i></div>`;
  for(let p=Math.max(1,auditPage-2);p<=Math.min(totalPages,auditPage+2);p++){
    pHtml+=`<div class="pagi-btn ${p===auditPage?'on':''}" onclick="auditPage=${p};renderAudit()">${p}</div>`;
  }
  if(auditPage<totalPages)pHtml+=`<div class="pagi-btn" onclick="auditPage++;renderAudit()"><i class="fas fa-chevron-right"></i></div>`;
  pHtml+='</div>';
  document.getElementById('auditPagi').innerHTML=pHtml;
}

// ===== DATA RECORDS =====
let recPage=1;
const REC_PER_PAGE=15;

function renderRecords(){
  const type=document.getElementById('recType').value;
  const status=document.getElementById('recStatus').value;
  const search=(document.getElementById('recSearch').value||'').toLowerCase();

  let filtered=records.filter(r=>{
    if(type&&r.type!==type)return false;
    if(status&&r.status!==status)return false;
    if(search&&!(r.id.toLowerCase().includes(search)||r.vendor.toLowerCase().includes(search)||r.material.toLowerCase().includes(search)||r.nopol.toLowerCase().includes(search)))return false;
    return true;
  });

  document.getElementById('recCount').textContent=filtered.length+' record';
  const totalPages=Math.ceil(filtered.length/REC_PER_PAGE)||1;
  if(recPage>totalPages)recPage=1;
  const start=(recPage-1)*REC_PER_PAGE;
  const page=filtered.slice(start,start+REC_PER_PAGE);

  const statusBadge={Completed:'b-green',Approved:'b-green',Pending:'b-gold',Rejected:'b-red',Exception:'b-orange'};

  document.getElementById('recTableBody').innerHTML=page.map((r,i)=>`<tr>
    <td>${start+i+1}</td>
    <td style="white-space:nowrap;font-family:'JetBrains Mono',monospace;font-size:10px">${r.date.toLocaleDateString('id-ID',{day:'2-digit',month:'2-digit',year:'numeric'})}</td>
    <td><span style="font-weight:700;color:var(--navy);font-size:10px">${r.id}</span></td>
    <td><span class="badge ${r.type==='keluar'?'b-red':'b-blue'}">${r.type==='keluar'?'KELUAR':'MASUK'}</span></td>
    <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${r.vendor}</td>
    <td>${r.material}</td>
    <td style="text-align:right;font-weight:600">${r.qty} ${r.unit}</td>
    <td>${r.gate}</td>
    <td style="font-family:'JetBrains Mono',monospace;font-size:10px">${r.nopol}</td>
    <td><span class="badge ${statusBadge[r.status]||'b-gray'}">${r.status}</span></td>
    <td style="text-align:center"><span style="font-weight:700;color:${r.physCheck==='OK'?'var(--green)':(r.physCheck==='FAIL'?'var(--red)':'var(--muted)')}">${r.physCheck}</span></td>
  </tr>`).join('');

  let pHtml=`<span>Halaman ${recPage} dari ${totalPages} (${filtered.length} record)</span><div class="pagi-btns">`;
  if(recPage>1)pHtml+=`<div class="pagi-btn" onclick="recPage--;renderRecords()"><i class="fas fa-chevron-left"></i></div>`;
  for(let p=Math.max(1,recPage-2);p<=Math.min(totalPages,recPage+2);p++){
    pHtml+=`<div class="pagi-btn ${p===recPage?'on':''}" onclick="recPage=${p};renderRecords()">${p}</div>`;
  }
  if(recPage<totalPages)pHtml+=`<div class="pagi-btn" onclick="recPage++;renderRecords()"><i class="fas fa-chevron-right"></i></div>`;
  pHtml+='</div>';
  document.getElementById('recPagi').innerHTML=pHtml;
}

// ===== TRENDS CHARTS =====
function initTrends(){
  // Monthly trend
  const months=['Sep','Oct','Nov','Dec','Jan','Feb'];
  const outM=[38,42,45,51,58,63],inM=[28,31,35,38,42,49];

  monthlyChart=new Chart(document.getElementById('chartMonthly'),{
    type:'line',
    data:{labels:months,datasets:[
      {label:'Barang Keluar',data:outM,borderColor:'#E21F26',backgroundColor:'rgba(226,31,38,.08)',fill:true,tension:.4,pointRadius:4,pointBackgroundColor:'#E21F26'},
      {label:'Barang Masuk',data:inM,borderColor:'#0058A3',backgroundColor:'rgba(0,88,163,.08)',fill:true,tension:.4,pointRadius:4,pointBackgroundColor:'#0058A3'}
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:10,family:'Outfit'}}}},scales:{y:{beginAtZero:true}}}
  });

  // Rejection rate trend
  const rejData=[4.2,3.8,3.1,2.9,2.8,2.6];
  rejectionChart=new Chart(document.getElementById('chartRejection'),{
    type:'line',
    data:{labels:months,datasets:[{label:'Rejection Rate %',data:rejData,borderColor:'#E21F26',backgroundColor:'rgba(226,31,38,.1)',fill:true,tension:.4,pointRadius:5,pointBackgroundColor:'#E21F26',borderWidth:2}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v+'%'}}}}
  });

  // Processing time per step
  processChart=new Chart(document.getElementById('chartProcessTime'),{
    type:'bar',
    data:{
      labels:['Step 1: Creator Submit','Step 2: FH Approval','Step 3: Legality Verify','Step 4: Gate Inspect'],
      datasets:[{data:[15,45,30,20],backgroundColor:['#0058A3','#0D8048','#7C3AED','#00838F'],borderRadius:6,barPercentage:.5}]
    },
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>ctx.raw+' menit avg'}}},scales:{x:{beginAtZero:true,ticks:{callback:v=>v+' min',font:{size:10}}},y:{ticks:{font:{size:10,family:'Outfit'}}}}}
  });

  // Material categories
  const matCounts={};
  records.forEach(r=>{matCounts[r.material]=(matCounts[r.material]||0)+1});
  const sorted=Object.entries(matCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const matColors=['#0A1F3F','#0058A3','#00838F','#0D8048','#B8860B','#EA580C','#E21F26','#7C3AED'];

  materialChart=new Chart(document.getElementById('chartMaterial'),{
    type:'bar',
    data:{labels:sorted.map(s=>s[0]),datasets:[{data:sorted.map(s=>s[1]),backgroundColor:matColors,borderRadius:4,barPercentage:.6}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true},x:{ticks:{font:{size:9},maxRotation:45}}}}
  });
}

// ===== EXPORT FUNCTIONS =====
function exportRecordsCSV(){
  const type=document.getElementById('recType').value;
  const status=document.getElementById('recStatus').value;
  const search=(document.getElementById('recSearch').value||'').toLowerCase();

  let filtered=records.filter(r=>{
    if(type&&r.type!==type)return false;
    if(status&&r.status!==status)return false;
    if(search&&!(r.id.toLowerCase().includes(search)||r.vendor.toLowerCase().includes(search)||r.material.toLowerCase().includes(search)))return false;
    return true;
  });

  let csv='\uFEFFNo,Tanggal,No MRA/DO,Tipe,Vendor,Material,Qty,Unit,Gate,No Polisi,Driver,Status,Physical Check\n';
  filtered.forEach((r,i)=>{
    csv+=`${i+1},${r.date.toLocaleDateString('id-ID')},${r.id},${r.type==='keluar'?'Keluar':'Masuk'},"${r.vendor}","${r.material}",${r.qty},${r.unit},${r.gate},${r.nopol},${r.driver},${r.status},${r.physCheck}\n`;
  });

  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='MFPS_Records_'+new Date().toISOString().split('T')[0]+'.csv';a.click();
  URL.revokeObjectURL(url);
  alert('✅ CSV berhasil di-export! ('+filtered.length+' record)');
}

function exportAllExcel(){
  // Generate comprehensive CSV with all data
  let csv='\uFEFF=== MFPS RECORDING & REPORTING ===\n';
  csv+='Generated: '+new Date().toLocaleString('id-ID',{timeZone:'Asia/Makassar'})+' WITA\n';
  csv+='Ref: TKO B07-009/KPI48540/2025-S9\n\n';

  csv+='=== RINGKASAN ===\n';
  csv+='Total Transaksi,430\nBarang Keluar,247\nBarang Masuk,183\nApproved,389\nException,23\nRejected,11\nPending,7\n\n';

  csv+='=== DATA PERGERAKAN BARANG ===\n';
  csv+='No,Tanggal,No MRA/DO,Tipe,Vendor,Material,Qty,Unit,Gate,No Polisi,Driver,Status,Physical Check\n';
  records.forEach((r,i)=>{
    csv+=`${i+1},${r.date.toLocaleDateString('id-ID')},${r.id},${r.type==='keluar'?'Keluar':'Masuk'},"${r.vendor}","${r.material}",${r.qty},${r.unit},${r.gate},${r.nopol},${r.driver},${r.status},${r.physCheck}\n`;
  });

  const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='MFPS_Full_Report_'+new Date().toISOString().split('T')[0]+'.csv';a.click();
  URL.revokeObjectURL(url);
  alert('✅ Full Report berhasil di-export!');
}

function exportPDF(){
  // Generate printable HTML and open print dialog
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><title>MFPS Report</title><style>
    body{font-family:Arial,sans-serif;padding:30px;color:#1a1a2e;font-size:12px}
    h1{color:#0A1F3F;font-size:22px;margin-bottom:4px}
    h2{color:#0058A3;font-size:14px;margin:20px 0 8px;border-bottom:2px solid #0058A3;padding-bottom:4px}
    .meta{color:#666;font-size:11px;margin-bottom:20px}
    .stats{display:flex;gap:16px;margin-bottom:20px}
    .stat-box{flex:1;border:1px solid #ddd;border-radius:8px;padding:12px;text-align:center}
    .stat-box b{display:block;font-size:24px;margin-bottom:4px}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:10px}
    th{background:#F3F4F6;padding:6px 8px;text-align:left;border:1px solid #ddd;font-weight:bold}
    td{padding:5px 8px;border:1px solid #eee}
    tr:nth-child(even) td{background:#FAFBFC}
    .footer{margin-top:30px;text-align:center;font-size:10px;color:#999;border-top:1px solid #ddd;padding-top:10px}
    @media print{body{padding:15px}}
  </style></head><body>
    <h1>MFPS — Recording & Reporting</h1>
    <div class="meta">
      Material Flow Protection System · PT. Pertamina Patra Niaga — RU V Balikpapan<br>
      Ref: TKO B07-009/KPI48540/2025-S9 · Generated: ${new Date().toLocaleString('id-ID',{timeZone:'Asia/Makassar'})} WITA
    </div>

    <h2>Ringkasan Statistik</h2>
    <div class="stats">
      <div class="stat-box"><b style="color:#E21F26">247</b>Barang Keluar</div>
      <div class="stat-box"><b style="color:#0058A3">183</b>Barang Masuk</div>
      <div class="stat-box"><b style="color:#0D8048">389</b>Approved (90.5%)</div>
      <div class="stat-box"><b style="color:#EA580C">23</b>Exception (5.3%)</div>
      <div class="stat-box"><b style="color:#E21F26">11</b>Rejected (2.6%)</div>
      <div class="stat-box"><b style="color:#B8860B">7</b>Pending (1.6%)</div>
    </div>

    <h2>Data Pergerakan Barang (Last 50)</h2>
    <table><thead><tr><th>No</th><th>Tanggal</th><th>No. MRA/DO</th><th>Tipe</th><th>Vendor</th><th>Material</th><th>Qty</th><th>Gate</th><th>Status</th><th>Phys Check</th></tr></thead><tbody>
    ${records.slice(0,50).map((r,i)=>`<tr>
      <td>${i+1}</td>
      <td>${r.date.toLocaleDateString('id-ID')}</td>
      <td><b>${r.id}</b></td>
      <td>${r.type==='keluar'?'Keluar':'Masuk'}</td>
      <td>${r.vendor}</td>
      <td>${r.material}</td>
      <td>${r.qty} ${r.unit}</td>
      <td>${r.gate}</td>
      <td>${r.status}</td>
      <td>${r.physCheck}</td>
    </tr>`).join('')}
    </tbody></table>

    <div class="footer">
      MFPS v4.1 · Material Flow Protection System · © 2026 Legality HSSE — RU V Balikpapan<br>
      Dokumen ini digenerate secara otomatis oleh sistem MFPS Recording & Reporting
    </div>
  </body></html>`);
  w.document.close();
  setTimeout(()=>w.print(),500);
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded',()=>{
  initDashboard();
  renderAudit();
  renderRecords();
  initTrends();
});
</script>
</body>
</html>
