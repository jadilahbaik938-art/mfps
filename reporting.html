<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MFPS â€” Recording & Reporting</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap');
:root{
  --navy:#0A1F3F;--blue:#0058A3;--teal:#00838F;--red:#E21F26;--green:#0D8048;--gold:#B8860B;
  --bg:#F0F2F7;--card:#FFF;--txt:#1A1A2E;--txt2:#4B5563;--muted:#9CA3AF;--bdr:#E5E7EB;
  --r:12px;--r2:16px;--orange:#EA580C;--purple:#7C3AED;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden}
.sbar{background:var(--navy);color:#fff;padding:6px 16px;font-size:10px;display:flex;justify-content:space-between;align-items:center}
.sbar-t{font-family:'JetBrains Mono',monospace;font-weight:600}
.hdr{background:#fff;padding:12px 16px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.hdr-l{display:flex;align-items:center;gap:10px}
.hdr-bk{width:34px;height:34px;border-radius:10px;border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--txt2);font-size:14px;background:#fff;text-decoration:none;transition:.15s}
.hdr-bk:hover{background:var(--bg);border-color:var(--navy);color:var(--navy)}
.hdr-tt{font-size:15px;font-weight:700}.hdr-sub{font-size:10px;color:var(--muted)}
.tabs{display:flex;background:#fff;border-bottom:2px solid var(--bdr);overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab{flex:1;min-width:0;padding:12px 8px;text-align:center;font-size:11px;font-weight:600;color:var(--muted);cursor:pointer;border-bottom:2.5px solid transparent;transition:.2s;white-space:nowrap;display:flex;align-items:center;justify-content:center;gap:5px}
.tab.on{color:var(--navy);border-bottom-color:var(--blue);background:#F5F8FF}
.tab:hover{color:var(--navy);background:#FAFBFF}
.tab i{font-size:12px}
.main{padding:16px;max-width:1400px;margin:0 auto}
.section{display:none;animation:fi .3s ease}.section.on{display:block}
@keyframes fi{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
.stat{background:#fff;border-radius:var(--r2);padding:16px;border-left:4px solid transparent;box-shadow:0 1px 4px rgba(0,0,0,.04);position:relative;overflow:hidden}
.stat::after{content:'';position:absolute;top:-20px;right:-20px;width:60px;height:60px;border-radius:50%;opacity:.06}
.stat-num{font-size:28px;font-weight:900;letter-spacing:-1px;line-height:1}
.stat-label{font-size:10px;color:var(--txt2);margin-top:4px;font-weight:500}
.stat-trend{font-size:9px;font-weight:700;margin-top:6px;display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:20px}
.stat.s-out{border-left-color:var(--red)}.stat.s-out .stat-num{color:var(--red)}.stat.s-out::after{background:var(--red)}
.stat.s-in{border-left-color:var(--blue)}.stat.s-in .stat-num{color:var(--blue)}.stat.s-in::after{background:var(--blue)}
.stat.s-tot{border-left-color:var(--navy)}.stat.s-tot .stat-num{color:var(--navy)}.stat.s-tot::after{background:var(--navy)}
.stat.s-vnd{border-left-color:var(--teal)}.stat.s-vnd .stat-num{color:var(--teal)}.stat.s-vnd::after{background:var(--teal)}
.cd{background:#fff;border-radius:var(--r2);border:1.5px solid var(--bdr);overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.03)}
.cd-h{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bdr);background:#FAFBFC}
.cd-t{font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px}
.cd-t i{font-size:14px}
.cd-b{padding:14px 16px}
.chart-wrap{position:relative;width:100%;height:220px;margin:8px 0}
.tbl-wrap{overflow-x:auto;border:1px solid var(--bdr);border-radius:10px;margin-top:8px}
table{width:100%;border-collapse:collapse;font-size:11px;min-width:600px}
th{background:#F3F4F6;padding:10px 12px;text-align:left;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--txt2);border-bottom:2px solid var(--bdr);position:sticky;top:0}
td{padding:9px 12px;border-bottom:1px solid #F3F4F6;vertical-align:top}
tr:hover td{background:#F8FAFF}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:.3px}
.b-green{background:#D1FAE5;color:#065F46}.b-red{background:#FEE2E2;color:#991B1B}
.b-blue{background:#DBEAFE;color:#1E40AF}.b-orange{background:#FFEDD5;color:#9A3412}
.b-gold{background:#FEF3C7;color:#92400E}.b-purple{background:#EDE9FE;color:#5B21B6}
.b-gray{background:#F3F4F6;color:#4B5563}.b-teal{background:#CCFBF1;color:#0F766E}
.log-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #F3F4F6}
.log-item:last-child{border-bottom:none}
.log-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;flex-shrink:0}
.log-content{flex:1;min-width:0}
.log-title{font-size:12px;font-weight:600;margin-bottom:2px}
.log-meta{font-size:10px;color:var(--muted);line-height:1.5}
.log-time{font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--muted);flex-shrink:0;text-align:right}
.fbar{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.fbar select,.fbar input{padding:8px 12px;border:1.5px solid var(--bdr);border-radius:8px;font-family:'Outfit',sans-serif;font-size:11px;background:#fff;color:var(--txt);outline:none;transition:.2s}
.fbar select:focus,.fbar input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,88,163,.1)}
.fbar input{flex:1;min-width:120px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;cursor:pointer;border:none;transition:.2s}
.btn-export{background:#fff;color:var(--green);border:1.5px solid var(--green)}.btn-export:hover{background:#F0FDF4}
.btn-pdf{background:#fff;color:var(--red);border:1.5px solid var(--red)}.btn-pdf:hover{background:#FEF2F2}
.btn-sm{padding:6px 12px;font-size:10px;border-radius:6px}
.btn-danger{background:#fff;color:var(--red);border:1.5px solid #FECACA}.btn-danger:hover{background:#FEF2F2}
.pagi{display:flex;align-items:center;justify-content:space-between;margin-top:12px;font-size:11px;color:var(--txt2)}
.pagi-btns{display:flex;gap:4px}
.pagi-btn{width:30px;height:30px;border-radius:6px;border:1px solid var(--bdr);background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;font-weight:600;transition:.15s}
.pagi-btn.on{background:var(--navy);color:#fff;border-color:var(--navy)}
.pagi-btn:hover:not(.on){background:var(--bg)}
.summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.summary-box{background:#fff;border-radius:var(--r);padding:14px;text-align:center;border:1px solid var(--bdr)}
.summary-box-num{font-size:22px;font-weight:800;line-height:1.1}
.summary-box-label{font-size:9px;color:var(--txt2);margin-top:4px;text-transform:uppercase;letter-spacing:.5px;font-weight:600}
/* Upload styles */
.upload-pair{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}
.upload-box{border:2.5px dashed var(--bdr);border-radius:var(--r2);padding:24px 14px;text-align:center;cursor:pointer;transition:.2s;background:#FAFBFC;position:relative}
.upload-box:hover,.upload-box.drag{border-color:var(--blue);background:#F0F7FF}
.upload-box input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-box-icon{font-size:28px;margin-bottom:8px}
.upload-box-title{font-size:12px;font-weight:700;margin-bottom:3px}
.upload-box-sub{font-size:10px;color:var(--muted)}
.upload-box.done{border-color:var(--green);background:#F0FDF4}
.upload-status{display:flex;gap:10px;padding:10px 14px;background:#F8FAFF;border-radius:var(--r);margin-bottom:6px;align-items:center;border:1px solid var(--bdr)}
.dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;background:var(--muted)}
.dot.ok{background:var(--green)}
.process-btn{width:100%;padding:14px;background:var(--navy);color:#fff;border:none;border-radius:var(--r);font-family:'Outfit',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:10px}
.process-btn:hover:not(:disabled){background:#0E2A4F}
.process-btn:disabled{background:var(--muted);cursor:not-allowed}
.hist-item{background:#fff;border:1.5px solid var(--bdr);border-radius:var(--r);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:10px;cursor:pointer;transition:.2s}
.hist-item:hover{border-color:var(--blue);box-shadow:0 2px 8px rgba(0,88,163,.08)}
.hist-item.active{border-color:var(--blue);background:#F0F7FF}
.hist-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--blue),var(--teal));display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;flex-shrink:0}
.hist-info{flex:1;min-width:0}
.hist-title{font-size:13px;font-weight:700}
.hist-meta{font-size:10px;color:var(--muted);margin-top:2px}
.hist-chips{display:flex;gap:5px;margin-top:6px;flex-wrap:wrap}
.chip{font-size:9px;font-weight:700;padding:2px 8px;border-radius:20px}
.empty-state{text-align:center;padding:36px 20px;color:var(--muted)}
.empty-state i{font-size:36px;margin-bottom:10px;display:block}
.empty-state p{font-size:13px;font-weight:600;color:var(--txt2);margin-bottom:4px}
.empty-state span{font-size:11px}
.info-banner{border-radius:var(--r);padding:10px 14px;margin-bottom:14px;font-size:11px;display:flex;gap:8px;align-items:center}
.info-warn{background:#FEF3C7;border:1px solid #FDE68A;color:#92400E}
.info-ok{background:#D1FAE5;border:1px solid #6EE7B7;color:#065F46}
/* MODE TOGGLE */
.mode-toggle{display:flex;background:#F3F4F6;border-radius:10px;padding:3px;gap:2px;margin-bottom:16px;width:fit-content}
.mode-btn{padding:7px 16px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;border:none;background:transparent;color:var(--muted);transition:.2s;display:flex;align-items:center;gap:5px}
.mode-btn.on{background:#fff;color:var(--navy);box-shadow:0 1px 4px rgba(0,0,0,.1)}
/* HEALTH SCORE */
.health-row{display:grid;grid-template-columns:auto 1fr;gap:14px;align-items:center;margin-bottom:16px}
.health-ring{position:relative;width:110px;height:110px;flex-shrink:0}
.health-ring svg{transform:rotate(-90deg)}
.health-ring-num{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:28px;font-weight:900;line-height:1}
.health-ring-label{font-size:9px;font-weight:600;color:var(--muted);margin-top:2px}
.health-bars{display:flex;flex-direction:column;gap:8px;flex:1}
.health-bar-item{display:flex;align-items:center;gap:8px;font-size:11px}
.health-bar-item span:first-child{width:110px;font-weight:600;color:var(--txt2);font-size:10px;flex-shrink:0}
.health-bar-track{flex:1;height:8px;background:#F3F4F6;border-radius:4px;overflow:hidden}
.health-bar-fill{height:100%;border-radius:4px;transition:width .8s ease}
.health-bar-pct{width:32px;text-align:right;font-size:10px;font-weight:700;flex-shrink:0}
/* NL SUMMARY */
.nl-box{background:linear-gradient(135deg,#0A1F3F,#0058A3);color:#fff;border-radius:var(--r2);padding:18px 20px;margin-bottom:14px;position:relative;overflow:hidden}
.nl-box::before{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.05)}
.nl-icon{font-size:20px;margin-bottom:8px;opacity:.9}
.nl-title{font-size:10px;font-weight:700;opacity:.7;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
.nl-text{font-size:13px;font-weight:500;line-height:1.6;opacity:.95}
.nl-chips{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.nl-chip{font-size:9px;font-weight:700;padding:3px 10px;border-radius:20px;background:rgba(255,255,255,.15);color:#fff}
.nl-chip.up{background:rgba(13,128,72,.35)}
.nl-chip.down{background:rgba(226,31,38,.35)}
.nl-chip.warn{background:rgba(234,88,12,.35)}
/* ANOMALY */
.anomaly-list{display:flex;flex-direction:column;gap:8px}
.anomaly-item{display:flex;gap:12px;align-items:flex-start;padding:10px 14px;border-radius:10px;border:1px solid var(--bdr)}
.anomaly-item.high{border-color:#FECACA;background:#FFF5F5}
.anomaly-item.med{border-color:#FDE68A;background:#FFFDF0}
.anomaly-item.low{border-color:#BBF7D0;background:#F0FDF4}
.anomaly-dot{width:8px;height:8px;border-radius:50%;margin-top:4px;flex-shrink:0}
.anomaly-dot.high{background:var(--red)}
.anomaly-dot.med{background:var(--gold)}
.anomaly-dot.low{background:var(--green)}
.anomaly-title{font-size:12px;font-weight:700;margin-bottom:2px}
.anomaly-desc{font-size:10px;color:var(--txt2);line-height:1.5}
/* DRILL DOWN */
.drill-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:none;align-items:center;justify-content:center;padding:16px}
.drill-overlay.on{display:flex}
.drill-panel{background:#fff;border-radius:var(--r2);width:100%;max-width:600px;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.drill-hdr{padding:16px 20px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:#fff;z-index:1}
.drill-body{padding:20px}
.drill-kpi{font-size:48px;font-weight:900;letter-spacing:-2px;margin-bottom:4px}
.drill-sub{font-size:12px;color:var(--muted);margin-bottom:16px}
.drill-breakdown{display:flex;flex-direction:column;gap:8px}
.drill-row{display:flex;align-items:center;gap:10px;padding:10px 14px;background:#F8FAFF;border-radius:8px}
.drill-row-label{flex:1;font-size:12px;font-weight:600}
.drill-row-val{font-size:14px;font-weight:800;min-width:50px;text-align:right}
.drill-row-bar{flex:2;height:6px;background:#E5E7EB;border-radius:4px;overflow:hidden}
.drill-row-fill{height:100%;border-radius:4px}
/* EXEC MODE */
.exec-only{display:none}
.ops-only{display:block}
body.exec-mode .exec-only{display:block}
body.exec-mode .ops-only{display:none}
@media(min-width:768px){
  .stats{grid-template-columns:repeat(4,1fr)}
  .summary-grid{grid-template-columns:repeat(6,1fr)}
  .chart-wrap{height:280px}
  .main{padding:24px}
  .cd-b{padding:18px 20px}
  .hdr{padding:14px 24px}
  .tabs{justify-content:center}
  .tab{flex:none;padding:14px 20px;font-size:12px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px}
}
@media(min-width:1200px){.main{padding:28px 40px}}
@media(max-width:480px){.upload-pair{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="sbar">
  <span>MFPS Recording & Reporting</span>
  <span class="sbar-t" id="clock">--:--</span>
  <span>RU V Balikpapan</span>
</div>

<div class="hdr">
  <div class="hdr-l">
    <a class="hdr-bk" href="index.html"><i class="fas fa-arrow-left"></i></a>
    <div>
      <div class="hdr-tt"><i class="fas fa-chart-line" style="color:var(--blue);margin-right:4px"></i> Recording & Reporting</div>
      <div class="hdr-sub">ISO 31000:2018 Compliance Â· Analytics Dashboard</div>
    </div>
  </div>
  <div style="display:flex;gap:6px">
    <button class="btn btn-sm btn-export" onclick="exportCSV()"><i class="fas fa-download"></i> Export CSV</button>
    <button class="btn btn-sm btn-pdf" onclick="alert('PDF export tersedia di versi enterprise')"><i class="fas fa-file-pdf"></i> PDF</button>
  </div>
</div>

<div class="tabs">
  <div class="tab on" onclick="showTab('dashboard',this)"><i class="fas fa-chart-pie"></i> Dashboard</div>
  <div class="tab" onclick="showTab('audit',this)"><i class="fas fa-clipboard-list"></i> Audit Trail</div>
  <div class="tab" onclick="showTab('records',this)"><i class="fas fa-database"></i> Data Record</div>
  <div class="tab" onclick="showTab('trends',this)"><i class="fas fa-chart-area"></i> Trend & Analytics</div>
  <div class="tab" onclick="showTab('monthly',this)"><i class="fas fa-calendar-alt"></i> Monthly Report</div>
</div>

<div class="main">

<!-- ============ DASHBOARD ============ -->
<div class="section on" id="sec-dashboard">

  <!-- Mode Toggle -->
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px">
    <div class="mode-toggle">
      <button class="mode-btn on" id="btnOps" onclick="setMode('ops')"><i class="fas fa-cogs"></i> Operational</button>
      <button class="mode-btn" id="btnExec" onclick="setMode('exec')"><i class="fas fa-briefcase"></i> Executive</button>
    </div>
    <div id="dashOK" class="info-banner info-ok" style="display:none;margin-bottom:0;padding:6px 12px">
      <i class="fas fa-check-circle"></i><span id="dashOKText">â€”</span>
    </div>
  </div>

  <div id="dashWarn" class="info-banner info-warn" style="display:none">
    <i class="fas fa-exclamation-circle"></i>
    <span>No data available. Upload Excel files in the <b>Monthly Report</b> tab to load real data.</span>
  </div>

  <!-- â‘  NL SUMMARY â€” tampil di kedua mode -->
  <div class="nl-box" id="nlBox" style="display:none">
    <div class="nl-icon"><i class="fas fa-robot"></i></div>
    <div class="nl-title">Auto Summary</div>
    <div class="nl-text" id="nlText">â€”</div>
    <div class="nl-chips" id="nlChips"></div>
  </div>

  <!-- â‘¡ HEALTH SCORE + KPI â€” tampil di kedua mode -->
  <div class="two-col" style="margin-bottom:0">
    <div class="cd">
      <div class="cd-h"><div class="cd-t"><i class="fas fa-heartbeat" style="color:var(--red)"></i> Operational Health Score</div></div>
      <div class="cd-b">
        <div class="health-row">
          <div class="health-ring">
            <svg width="110" height="110" viewBox="0 0 110 110">
              <circle cx="55" cy="55" r="46" fill="none" stroke="#F3F4F6" stroke-width="10"/>
              <circle id="healthArc" cx="55" cy="55" r="46" fill="none" stroke="#0D8048" stroke-width="10"
                stroke-dasharray="289 289" stroke-dashoffset="289" stroke-linecap="round" style="transition:stroke-dashoffset 1s ease"/>
            </svg>
            <div class="health-ring-num">
              <span id="healthNum" style="color:var(--green)">â€”</span>
              <span class="health-ring-label" id="healthLabel">â€”</span>
            </div>
          </div>
          <div class="health-bars" id="healthBars">
            <div style="color:var(--muted);font-size:11px;text-align:center;padding:20px">Upload data to proceed</div>
          </div>
        </div>
      </div>
    </div>
    <div class="cd">
      <div class="cd-h"><div class="cd-t"><i class="fas fa-th-large" style="color:var(--navy)"></i> Key Performance Indicators</div><span style="font-size:10px;color:var(--muted)">click for details</span></div>
      <div class="cd-b" style="padding:10px">
        <div class="stats" style="margin-bottom:0;gap:8px">
          <div class="stat s-out" style="cursor:pointer" onclick="openDrill('keluar')">
            <div class="stat-num" id="dOut">â€”</div><div class="stat-label">Outbound (MRA)</div>
            <div class="stat-trend" id="dOutT" style="background:#FEE2E2;color:var(--red)"><i class="fas fa-mouse-pointer"></i> click for details</div>
          </div>
          <div class="stat s-in" style="cursor:pointer" onclick="openDrill('masuk')">
            <div class="stat-num" id="dIn">â€”</div><div class="stat-label">Inbound (DO)</div>
            <div class="stat-trend" id="dInT" style="background:#DBEAFE;color:var(--blue)"><i class="fas fa-mouse-pointer"></i> click for details</div>
          </div>
          <div class="stat s-tot" style="cursor:pointer" onclick="openDrill('total')">
            <div class="stat-num" id="dTot">â€”</div><div class="stat-label">Total Transaction</div>
            <div class="stat-trend" id="dTotT" style="background:#E0E7FF;color:var(--navy)"><i class="fas fa-mouse-pointer"></i> click for details</div>
          </div>
          <div class="stat s-vnd" style="cursor:pointer" onclick="openDrill('vendor')">
            <div class="stat-num" id="dVnd">â€”</div><div class="stat-label">Unique Vendor</div>
            <div class="stat-trend" id="dVndT" style="background:#CCFBF1;color:var(--teal)"><i class="fas fa-mouse-pointer"></i> click for details</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- â‘¢ ANOMALY ALERT -->
  <div class="cd" id="anomalyCard" style="display:none;margin-top:14px">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-triangle-exclamation" style="color:var(--orange)"></i> Anomaly Alert</div>
      <span class="badge b-orange" id="anomalyCnt">0 anomali</span>
    </div>
    <div class="cd-b"><div class="anomaly-list" id="anomalyList"></div></div>
  </div>

  <!-- GRAFIK â€” Ops mode saja -->
  <div class="ops-only">
    <div class="two-col" style="margin-top:14px">
      <div class="cd">
        <div class="cd-h"><div class="cd-t"><i class="fas fa-chart-bar" style="color:var(--blue)"></i> Monthly Traffic</div></div>
        <div class="cd-b"><div class="chart-wrap"><canvas id="cDailyBar"></canvas></div></div>
      </div>
      <div class="cd">
        <div class="cd-h"><div class="cd-t"><i class="fas fa-chart-area" style="color:var(--teal)"></i> Monthly Trend</div></div>
        <div class="cd-b"><div class="chart-wrap"><canvas id="cTrendLine"></canvas></div></div>
      </div>
    </div>
    <div class="two-col">
      <div class="cd">
        <div class="cd-h"><div class="cd-t"><i class="fas fa-building" style="color:var(--teal)"></i> Top Vendor</div></div>
        <div class="cd-b"><div id="dVendorBars"><div class="empty-state" style="padding:20px"><i class="fas fa-building" style="font-size:24px"></i><p style="font-size:11px">Upload data to proceed</p></div></div></div>
      </div>
      <div class="cd">
        <div class="cd-h"><div class="cd-t"><i class="fas fa-boxes-stacked" style="color:var(--orange)"></i> Top Material</div></div>
        <div class="cd-b"><div class="chart-wrap" style="height:200px"><canvas id="cBarang"></canvas></div></div>
      </div>
    </div>
  </div>

  <!-- EXEC MODE: ringkasan milestone -->
  <div class="exec-only" style="margin-top:14px">
    <div class="cd">
      <div class="cd-h"><div class="cd-t"><i class="fas fa-flag-checkered" style="color:var(--purple)"></i> Monthly Progress</div></div>
      <div class="cd-b"><div id="execProgress"><div class="empty-state" style="padding:20px"><p style="font-size:11px">Upload data to view progress</p></div></div></div>
    </div>
  </div>

</div>

<!-- DRILL DOWN OVERLAY -->
<div class="drill-overlay" id="drillOverlay" onclick="if(event.target===this)closeDrill()">
  <div class="drill-panel">
    <div class="drill-hdr">
      <div style="font-size:14px;font-weight:800" id="drillTitle">Detail</div>
      <button onclick="closeDrill()" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted)"><i class="fas fa-times"></i></button>
    </div>
    <div class="drill-body">
      <div class="drill-kpi" id="drillKPI">â€”</div>
      <div class="drill-sub" id="drillSub">â€”</div>
      <div class="drill-breakdown" id="drillBreakdown"></div>
    </div>
  </div>
</div>

<!-- ============ AUDIT TRAIL ============ -->
<div class="section" id="sec-audit">
  <div class="fbar">
    <select id="auditFilt" onchange="renderAudit()">
      <option value="">All Types</option>
      <option value="masuk">Inbound (DO)</option>
      <option value="keluar">Outbound (MRA)</option>
    </select>
    <input type="date" id="auditDate" onchange="renderAudit()">
    <input type="text" id="auditSrch" placeholder="Search vendor, material..." oninput="renderAudit()">
  </div>
  <div class="cd">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-clipboard-list" style="color:var(--purple)"></i> Activity Log</div>
      <span class="badge b-purple" id="auditCnt">0 records</span>
    </div>
    <div class="cd-b" id="auditList" style="max-height:600px;overflow-y:auto"></div>
    <div class="pagi" id="auditPagi" style="padding:10px 16px"></div>
  </div>
</div>

<!-- ============ DATA RECORDS ============ -->
<div class="section" id="sec-records">
  <div class="fbar">
    <select id="recTipe" onchange="renderRecords()">
      <option value="">All Types</option>
      <option value="keluar">Outbound (MRA)</option>
      <option value="masuk">Inbound (DO)</option>
    </select>
    <input type="text" id="recSrch" placeholder="Search vendor, material..." oninput="renderRecords()">
    <button class="btn btn-sm btn-export" onclick="exportCSV()"><i class="fas fa-download"></i> CSV</button>
  </div>
  <div class="cd">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-database" style="color:var(--blue)"></i> Material Movement</div>
      <span class="badge b-blue" id="recCnt">0 records</span>
    </div>
    <div class="cd-b" style="padding:0">
      <div class="tbl-wrap" style="max-height:500px;overflow-y:auto">
        <table><thead><tr><th>#</th><th>Type</th><th>Date</th><th>Inbound</th><th>Outbound</th><th>Total</th><th>Vendor</th><th>Material Type</th><th>Period</th></tr></thead>
        <tbody id="recBody"></tbody></table>
      </div>
    </div>
    <div class="pagi" id="recPagi" style="padding:10px 16px"></div>
  </div>
</div>

<!-- ============ TREN & GRAFIK ============ -->
<div class="section" id="sec-trends">
  <div class="summary-grid">
    <div class="summary-box"><div class="summary-box-num" id="tTotal" style="color:var(--navy)">â€”</div><div class="summary-box-label">Total Transaction</div></div>
    <div class="summary-box"><div class="summary-box-num" id="tOutbound" style="color:var(--red)">â€”</div><div class="summary-box-label">Outbound</div></div>
    <div class="summary-box"><div class="summary-box-num" id="tInbound" style="color:var(--blue)">â€”</div><div class="summary-box-label">Inbound</div></div>
    <div class="summary-box"><div class="summary-box-num" id="tBulan" style="color:var(--green)">â€”</div><div class="summary-box-label">Monthly Data</div></div>
    <div class="summary-box"><div class="summary-box-num" id="tVendor" style="color:var(--orange)">â€”</div><div class="summary-box-label">Unique Vendor</div></div>
    <div class="summary-box"><div class="summary-box-num" id="tBarang" style="color:var(--purple)">â€”</div><div class="summary-box-label">Material Type</div></div>
  </div>
  <div class="two-col">
    <div class="cd">
      <div class="cd-h"><div class="cd-t"><i class="fas fa-chart-area" style="color:var(--teal)"></i> Monthly Trend</div></div>
      <div class="cd-b"><div class="chart-wrap"><canvas id="cTrendM"></canvas></div></div>
    </div>
    <div class="cd">
      <div class="cd-h"><div class="cd-t"><i class="fas fa-chart-bar" style="color:var(--orange)"></i> Top 10 Material Type</div></div>
      <div class="cd-b"><div class="chart-wrap"><canvas id="cTrendB"></canvas></div></div>
    </div>
  </div>
  <div class="cd">
    <div class="cd-h"><div class="cd-t"><i class="fas fa-building" style="color:var(--blue)"></i> Top 10 Vendors</div></div>
    <div class="cd-b"><div class="chart-wrap" style="height:280px"><canvas id="cTrendV"></canvas></div></div>
  </div>
</div>

<!-- ============ MONTHLY REPORT ============ -->
<div class="section" id="sec-monthly">
  <div class="cd">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-file-arrow-up" style="color:var(--teal)"></i> Upload Monthly Report</div>
      <span class="badge b-teal" id="periodeLabel">Select period</span>
    </div>
    <div class="cd-b">
      <!-- Step 1: Select Period -->
      <div style="background:#F0F7FF;border:1.5px solid var(--blue);border-radius:10px;padding:12px 14px;margin-bottom:14px">
        <div style="font-size:10px;font-weight:700;color:var(--blue);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px"><i class="fas fa-calendar-alt"></i> Step 1 â€” Select Report Period</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <select id="selBulan" style="padding:9px 12px;border:1.5px solid var(--blue);border-radius:8px;font-family:'Outfit',sans-serif;font-size:12px;background:#fff;outline:none;flex:1;font-weight:600" onchange="onPeriodeChange()">
            <option value="">â€” Select Month â€”</option>
            <option>Januari</option><option>Februari</option><option>Maret</option><option>April</option>
            <option>Mei</option><option>Juni</option><option>Juli</option><option>Agustus</option>
            <option>September</option><option>Oktober</option><option>November</option><option>Desember</option>
          </select>
          <select id="selTahun" style="padding:9px 12px;border:1.5px solid var(--blue);border-radius:8px;font-family:'Outfit',sans-serif;font-size:12px;background:#fff;outline:none;flex:1;font-weight:600" onchange="onPeriodeChange()">
            <option value="">â€” Select Year â€”</option>
            <option>2024</option><option>2025</option><option>2026</option><option>2027</option>
          </select>
        </div>
      </div>

      <!-- Step 2: Upload File -->
      <div style="font-size:10px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px"><i class="fas fa-file-arrow-up"></i> Step 2 â€” Upload Excel Files</div>
      <!-- 2 Zona Upload -->
      <div class="upload-pair">
        <div class="upload-box" id="zoneMasuk"
          ondragover="dragZone(event,'zoneMasuk',1)"
          ondragleave="dragZone(event,'zoneMasuk',0)"
          ondrop="dropZone(event,'masuk')">
          <input type="file" accept=".xlsx,.xls" onchange="onFileSelect(this,'masuk')">
          <div class="upload-box-icon"><i class="fas fa-arrow-down" style="color:var(--blue)"></i></div>
          <div class="upload-box-title" id="titleM">ðŸ“¥ Inbound (DO)</div>
          <div class="upload-box-sub" id="subM">Drag & drop or click Â· .xlsx / .xls</div>
        </div>
        <div class="upload-box" id="zoneKeluar"
          ondragover="dragZone(event,'zoneKeluar',1)"
          ondragleave="dragZone(event,'zoneKeluar',0)"
          ondrop="dropZone(event,'keluar')">
          <input type="file" accept=".xlsx,.xls" onchange="onFileSelect(this,'keluar')">
          <div class="upload-box-icon"><i class="fas fa-arrow-up" style="color:var(--red)"></i></div>
          <div class="upload-box-title" id="titleK">ðŸ“¤ Outbound (MRA)</div>
          <div class="upload-box-sub" id="subK">Drag & drop or click Â· .xlsx / .xls</div>
        </div>
      </div>

      <!-- Status -->
      <div class="upload-status"><div class="dot" id="dotM"></div><span id="statM" style="font-size:11px;color:var(--muted)">Inbound (DO) â€” not uploaded</span></div>
      <div class="upload-status"><div class="dot" id="dotK"></div><span id="statK" style="font-size:11px;color:var(--muted)">Outbound (MRA) â€” not uploaded</span></div>

      <!-- Hint error -->
      <div id="prosesHint" style="display:none;background:#FEF3C7;border:1px solid #FDE68A;border-radius:8px;padding:10px 14px;margin-top:10px;font-size:11px;color:#92400E">
        <i class="fas fa-exclamation-circle"></i> <span id="prosesHintText">Please select Month & Year first.</span>
      </div>

      <!-- Step 3: Proses -->
      <div style="font-size:10px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.5px;margin:12px 0 6px"><i class="fas fa-bolt"></i> Step 3 â€” Process</div>
      <button class="process-btn" id="btnProses" onclick="prosesLaporan()">
        <i class="fas fa-bolt"></i> Process & Save Report
      </button>
    </div>
  </div>

  <!-- Riwayat -->
  <div class="cd">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-history" style="color:var(--navy)"></i> Report History</div>
      <span class="badge b-blue" id="histCnt">0 reports</span>
    </div>
    <div class="cd-b" id="histList">
      <div class="empty-state"><i class="fas fa-folder-open"></i><p>Belum ada reports</p><span>Upload Inbound & Outbound files then click Process</span></div>
    </div>
  </div>

  <!-- Detail Panel -->
  <div id="detPanel" style="display:none">
    <div class="cd">
      <div class="cd-h">
        <div class="cd-t"><i class="fas fa-chart-bar" style="color:var(--blue)"></i><span id="detTitle">Detail</span></div>
        <button class="btn btn-sm btn-danger" onclick="closeDetail()"><i class="fas fa-times"></i> Close</button>
      </div>
      <div class="cd-b">
        <div class="stats" id="detKPI"></div>
      </div>
    </div>
    <div class="two-col">
      <div class="cd">
        <div class="cd-h"><div class="cd-t"><i class="fas fa-chart-bar" style="color:var(--blue)"></i> Daily Traffic</div></div>
        <div class="cd-b"><div class="chart-wrap"><canvas id="cDetHarian"></canvas></div></div>
      </div>
      <div class="cd">
        <div class="cd-h"><div class="cd-t"><i class="fas fa-building" style="color:var(--teal)"></i> Top Vendors This Period</div></div>
        <div class="cd-b"><div id="detVendors"></div></div>
      </div>
    </div>
    <div class="cd">
      <div class="cd-h"><div class="cd-t"><i class="fas fa-table" style="color:var(--navy)"></i> Daily Recap</div></div>
      <div class="cd-b" style="padding:0">
        <div class="tbl-wrap">
          <table><thead><tr><th>Date</th><th>Inbound</th><th>Outbound</th><th>Total</th><th># Vendor</th><th># Material Type</th></tr></thead>
          <tbody id="detTblBody"></tbody></table>
        </div>
      </div>
    </div>
  </div>
</div>

</div><!-- /main -->

<script>
// ===== CLOCK =====
function uc(){document.getElementById('clock').textContent=new Date().toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',timeZone:'Asia/Makassar'})+' WITA';}
uc();setInterval(uc,30000);

// ===== STORAGE =====
const KEY='mfps_reports_v3';
function load(){try{return JSON.parse(localStorage.getItem(KEY)||'[]');}catch{return[];}}
function save(d){localStorage.setItem(KEY,JSON.stringify(d));}

// Temp per sesi
let tmpM=null,tmpK=null;

// ===== TABS =====
function showTab(id,el){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.getElementById('sec-'+id).classList.add('on');
  el.classList.add('on');
  if(id==='dashboard')renderDash();
  if(id==='audit')renderAudit();
  if(id==='records')renderRecords();
  if(id==='trends')renderTrends();
  if(id==='monthly')renderHist();
}

// ===== PARSE EXCEL =====
function parseFile(file,tipe){
  return new Promise((res,rej)=>{
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const wb=XLSX.read(e.target.result,{type:'array'});
        // Select relevant sheet
        let sn=wb.SheetNames[0];
        const found=wb.SheetNames.find(s=>{
          const sl=s.toLowerCase();
          return tipe==='masuk'?sl.includes('masuk'):(sl.includes('keluar')||sl.includes('out'));
        });
        if(found)sn=found;
        const ws=wb.Sheets[sn];

        // Deteksi rows header (scan 0â€“12)
        let hRow=0;
        for(let r=0;r<13;r++){
          const test=XLSX.utils.sheet_to_json(ws,{range:r,header:1,defval:''});
          if(!test.length)continue;
          const rowStr=(test[0]||[]).join(' ').toLowerCase();
          if((rowStr.includes('no')&&rowStr.includes('barang'))||(rowStr.includes('no')&&rowStr.includes('hari'))||(rowStr.includes('manifest')||rowStr.includes('kontrak'))){
            hRow=r;break;
          }
        }
        const rows=XLSX.utils.sheet_to_json(ws,{range:hRow,defval:'',raw:false});
        // Normalisasi keys
        const norm=rows.map(r=>{
          const o={};
          Object.keys(r).forEach(k=>{
            const nk=k.toLowerCase().trim()
              .replace(/\s+/g,'_')
              .replace(/[./()]/g,'')
              .replace(/__+/g,'_');
            o[nk]=r[k];
          });
          return o;
        }).filter(r=>Object.values(r).join('').trim().length>2);
        res({rows:norm,file:file.name,count:norm.length});
      }catch(err){rej(err);}
    };
    reader.readAsArrayBuffer(file);
  });
}

// Ambil value fleksibel
function gv(r,keys){
  for(const k of keys){
    const v=r[k]||r[k.replace(/_/g,' ')]||'';
    if(v&&String(v).trim())return String(v).trim();
  }
  return '';
}

function parseTgl(s){
  if(!s)return null;
  const m=String(s).match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if(m)return{d:+m[1],b:+m[2],y:+m[3],key:`${m[3]}-${m[2].padStart(2,'0')}-${m[1].padStart(2,'0')}`};
  return null;
}

// ===== UPLOAD ZONE =====
function dragZone(e,id,on){e.preventDefault();document.getElementById(id).classList.toggle('drag',!!on);}
function dropZone(e,tipe){
  e.preventDefault();
  dragZone(e,tipe==='masuk'?'zoneMasuk':'zoneKeluar',0);
  if(e.dataTransfer.files[0])processUpload(e.dataTransfer.files[0],tipe);
}
function onFileSelect(el,tipe){if(el.files[0])processUpload(el.files[0],tipe);}

async function processUpload(file,tipe){
  if(!file.name.match(/\.(xlsx|xls)$/i)){alert('âš  Please use .xlsx or .xls file format');return;}
  const iM=tipe==='masuk';
  const subId=iM?'subM':'subK';
  document.getElementById(subId).textContent='â³ Reading file...';
  try{
    const data=await parseFile(file,tipe);
    if(iM)tmpM=data; else tmpK=data;
    // Update zona
    document.getElementById(iM?'zoneMasuk':'zoneKeluar').classList.add('done');
    document.getElementById(iM?'titleM':'titleK').textContent=(iM?'ðŸ“¥ ':'ðŸ“¤ ')+file.name;
    document.getElementById(subId).textContent='âœ… '+data.count+' transactions found';
    document.getElementById(iM?'dotM':'dotK').classList.add('ok');
    document.getElementById(iM?'statM':'statK').textContent=(iM?'Inbound (DO)':'Outbound (MRA)')+' â€” '+file.name+' ('+data.count+' rows)';
    document.getElementById(iM?'statM':'statK').style.color='var(--green)';
    cekBtnProses();
  }catch(err){
    document.getElementById(subId).textContent='âš  Failed: '+err.message;
    alert('âš  Failed to read file:\n'+err.message);
  }
}

function onPeriodeChange(){
  const b=document.getElementById('selBulan').value;
  const t=document.getElementById('selTahun').value;
  document.getElementById('periodeLabel').textContent=b&&t?b+' '+t:'Select period';
  cekBtnProses();
}

function cekBtnProses(){
  // Tombol selalu aktif - validasi dilakukan saat klik
  const b=document.getElementById('selBulan').value;
  const t=document.getElementById('selTahun').value;
  const hint=document.getElementById('prosesHint');
  const hintText=document.getElementById('prosesHintText');
  if(!b||!t){
    hint.style.display='block';
    hintText.textContent='â¬† Please select Month & Year in Step 1 first.';
  } else if(!tmpM&&!tmpK){
    hint.style.display='block';
    hintText.textContent='â¬† Please upload at least 1 Excel file in Step 2.';
  } else {
    hint.style.display='none';
  }
}

// ===== PROSES =====
function prosesLaporan(){
  const bulan=document.getElementById('selBulan').value;
  const tahun=document.getElementById('selTahun').value;
  const hint=document.getElementById('prosesHint');
  const hintText=document.getElementById('prosesHintText');
  if(!bulan||!tahun){
    hint.style.display='block';
    hintText.textContent='â¬† Please select Month & Year in Step 1 first, then click Process again.';
    document.getElementById('selBulan').style.borderColor='var(--red)';
    document.getElementById('selTahun').style.borderColor='var(--red)';
    document.getElementById('selBulan').scrollIntoView({behavior:'smooth',block:'center'});
    return;
  }
  if(!tmpM&&!tmpK){
    hint.style.display='block';
    hintText.textContent='â¬† Please upload at least 1 Excel file in Step 2 first.';
    return;
  }
  hint.style.display='none';
  document.getElementById('selBulan').style.borderColor='var(--blue)';
  document.getElementById('selTahun').style.borderColor='var(--blue)';

  const byDate={};
  const allV={},allB={};

  function aggRows(rows,tipe){
    rows.forEach(r=>{
      const tglRaw=gv(r,['hari_tanggal','hari__tanggal','tanggal','hari','_hari___tanggal','hari_tanggal_']);
      const p=parseTgl(tglRaw);
      if(!p)return;
      if(!byDate[p.key])byDate[p.key]={masuk:0,keluar:0,vendors:new Set(),barangs:new Set()};
      if(tipe==='masuk')byDate[p.key].masuk++; else byDate[p.key].keluar++;
      const v=gv(r,['perusahaan','vendor','nama_perusahaan','vendor_','perusahaan_']);
      const b=gv(r,['nama_barang','barang','material','nama_barang_','barang_']);
      if(v){byDate[p.key].vendors.add(v);allV[v]=(allV[v]||0)+1;}
      if(b){byDate[p.key].barangs.add(b);allB[b]=(allB[b]||0)+1;}
    });
  }

  if(tmpM)aggRows(tmpM.rows,'masuk');
  if(tmpK)aggRows(tmpK.rows,'keluar');

  let totM=0,totK=0;
  Object.values(byDate).forEach(d=>{totM+=d.masuk;totK+=d.keluar;});

  const report={
    id:'RPT-'+Date.now(),
    bulan,tahun,
    createdAt:new Date().toISOString(),
    fileInbound:tmpM?.file||null,
    fileOutbound:tmpK?.file||null,
    byDate:Object.fromEntries(Object.entries(byDate).map(([k,v])=>([k,{masuk:v.masuk,keluar:v.keluar,vendors:[...v.vendors],barangs:[...v.barangs]}]))),
    allVendors:allV,allBarangs:allB,
    summary:{totInbound:totM,totOutbound:totK,total:totM+totK,vendors:Object.keys(allV).length,barangs:Object.keys(allB).length}
  };

  const reps=load();
  const idx=reps.findIndex(r=>r.bulan===bulan&&r.tahun===tahun);
  if(idx>=0){if(!confirm(`Report ${bulan} ${tahun} already exists. Overwrite?`))return;reps.splice(idx,1);}
  reps.unshift(report);
  if(reps.length>36)reps.pop();
  save(reps);

  tmpM=null;tmpK=null;
  resetZones();
  renderHist();
  showDetail(report);
  renderDash();
  alert(`âœ… Report ${bulan} ${tahun} saved!\n\nInbound: ${totM}  |  Outbound: ${totK}  |  Total: ${report.summary.total}\nVendor: ${report.summary.vendors}  |  Material Type: ${report.summary.barangs}`);
}

function resetZones(){
  ['zoneMasuk','zoneKeluar'].forEach(id=>document.getElementById(id).classList.remove('done','drag'));
  document.getElementById('titleM').textContent='ðŸ“¥ Inbound (DO)';
  document.getElementById('subM').textContent='Drag & drop or click Â· .xlsx / .xls';
  document.getElementById('titleK').textContent='ðŸ“¤ Outbound (MRA)';
  document.getElementById('subK').textContent='Drag & drop or click Â· .xlsx / .xls';
  ['dotM','dotK'].forEach(id=>{document.getElementById(id).className='dot';});
  document.getElementById('statM').textContent='Inbound (DO) â€” not uploaded';
  document.getElementById('statM').style.color='var(--muted)';
  document.getElementById('statK').textContent='Outbound (MRA) â€” not uploaded';
  document.getElementById('statK').style.color='var(--muted)';
  document.getElementById('selBulan').value='';
  document.getElementById('selTahun').value='';
  document.getElementById('selBulan').style.borderColor='var(--blue)';
  document.getElementById('selTahun').style.borderColor='var(--blue)';
  document.getElementById('prosesHint').style.display='none';
  document.getElementById('periodeLabel').textContent='Select period';
  // btn always active
}

// ===== RIWAYAT =====
function renderHist(){
  const reps=load();
  document.getElementById('histCnt').textContent=reps.length+' reports';
  if(!reps.length){document.getElementById('histList').innerHTML='<div class="empty-state"><i class="fas fa-folder-open"></i><p>Belum ada reports</p><span>Upload Inbound & Outbound files then click Process</span></div>';return;}
  document.getElementById('histList').innerHTML=reps.map(r=>`
    <div class="hist-item" id="hi-${r.id}" onclick="showDetailById('${r.id}')">
      <div class="hist-icon"><i class="fas fa-calendar-check"></i></div>
      <div class="hist-info">
        <div class="hist-title">${r.bulan} ${r.tahun}</div>
        <div class="hist-meta">${new Date(r.createdAt).toLocaleString('id-ID')} Â· ${Object.keys(r.byDate).length} active days</div>
        <div class="hist-chips">
          <span class="chip" style="background:#FEE2E2;color:#991B1B">â†‘ ${r.summary.totOutbound} Outbound</span>
          <span class="chip" style="background:#DBEAFE;color:#1E40AF">â†“ ${r.summary.totInbound} Inbound</span>
          <span class="chip" style="background:#D1FAE5;color:#065F46">âˆ‘ ${r.summary.total}</span>
          <span class="chip" style="background:#CCFBF1;color:#0F766E">${r.summary.vendors} Vendors</span>
        </div>
      </div>
      <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();delReport('${r.id}')"><i class="fas fa-trash"></i></button>
    </div>`).join('');
}

function delReport(id){
  if(!confirm('Hapus reports ini?'))return;
  save(load().filter(r=>r.id!==id));
  closeDetail();renderHist();renderDash();
}

function showDetailById(id){
  const r=load().find(r=>r.id===id);
  if(r)showDetail(r);
}

let dCharts={};
function dDes(id){if(dCharts[id]){dCharts[id].destroy();delete dCharts[id];}}

function showDetail(report){
  document.querySelectorAll('.hist-item').forEach(e=>e.classList.remove('active'));
  const el=document.getElementById('hi-'+report.id);
  if(el)el.classList.add('active');
  document.getElementById('detPanel').style.display='block';
  document.getElementById('detTitle').textContent=` ${report.bulan} ${report.tahun}`;
  const s=report.summary;
  document.getElementById('detKPI').innerHTML=`
    <div class="stat s-out"><div class="stat-num">${s.totOutbound}</div><div class="stat-label">Outbound (MRA)</div></div>
    <div class="stat s-in"><div class="stat-num">${s.totInbound}</div><div class="stat-label">Inbound (DO)</div></div>
    <div class="stat s-tot"><div class="stat-num">${s.total}</div><div class="stat-label">Total Transaction</div></div>
    <div class="stat s-vnd"><div class="stat-num">${s.vendors}</div><div class="stat-label">Unique Vendor</div></div>`;

  const dates=Object.keys(report.byDate).sort();
  const lbls=dates.map(d=>{const p=d.split('-');return p[2]+'/'+p[1];});
  const dM=dates.map(d=>report.byDate[d].masuk);
  const dK=dates.map(d=>report.byDate[d].keluar);

  setTimeout(()=>{
    dDes('har');
    const ctx=document.getElementById('cDetHarian').getContext('2d');
    dCharts['har']=new Chart(ctx,{type:'bar',data:{labels:lbls,datasets:[
      {label:'Outbound',data:dK,backgroundColor:'rgba(226,31,38,.75)',borderRadius:3},
      {label:'Inbound',data:dM,backgroundColor:'rgba(0,88,163,.75)',borderRadius:3}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10}}}},scales:{x:{ticks:{font:{size:8},maxRotation:60}},y:{ticks:{font:{size:9}}}}}});
  },100);

  const topV=Object.entries(report.allVendors).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const mx=topV[0]?.[1]||1;
  const vc=['#E21F26','#0058A3','#0D8048','#EA580C','#7C3AED','#00838F','#B8860B','#9CA3AF'];
  document.getElementById('detVendors').innerHTML=topV.map((v,i)=>`
    <div style="margin-bottom:9px">
      <div style="display:flex;justify-content:space-between;font-size:11px;font-weight:600;margin-bottom:3px">
        <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:78%">${v[0]}</span><span>${v[1]}</span>
      </div>
      <div style="height:5px;background:#F3F4F6;border-radius:4px">
        <div style="width:${(v[1]/mx*100).toFixed(1)}%;height:100%;background:${vc[i%8]};border-radius:4px"></div>
      </div>
    </div>`).join('')||'<div style="color:var(--muted);font-size:11px;text-align:center;padding:20px">No vendor data available</div>';

  document.getElementById('detTblBody').innerHTML=dates.map(d=>{
    const row=report.byDate[d];
    const p=d.split('-');
    return`<tr>
      <td><b>${p[2]}/${p[1]}/${p[0]}</b></td>
      <td style="text-align:center;color:var(--blue);font-weight:700">${row.masuk}</td>
      <td style="text-align:center;color:var(--red);font-weight:700">${row.keluar}</td>
      <td style="text-align:center;font-weight:800">${row.masuk+row.keluar}</td>
      <td style="text-align:center">${row.vendors.length}</td>
      <td style="text-align:center">${row.barangs.length}</td>
    </tr>`;
  }).join('');
  document.getElementById('detPanel').scrollIntoView({behavior:'smooth',block:'start'});
}

function closeDetail(){
  document.getElementById('detPanel').style.display='none';
  document.querySelectorAll('.hist-item').forEach(e=>e.classList.remove('active'));
}

// ===== MODE TOGGLE =====
let currentMode='ops';
function setMode(m){
  currentMode=m;
  document.getElementById('btnOps').classList.toggle('on',m==='ops');
  document.getElementById('btnExec').classList.toggle('on',m==='exec');
  if(m==='exec')document.body.classList.add('exec-mode');
  else document.body.classList.remove('exec-mode');
  renderDash();
}

// ===== HEALTH SCORE =====
function calcHealth(reps){
  if(!reps.length)return{score:0,label:'No Data',color:'#9CA3AF',scores:{}};
  // Komponen 1: Konsistensi volume harian (40%)
  let allDailyTotals=[];
  reps.forEach(r=>Object.values(r.byDate).forEach(d=>allDailyTotals.push(d.masuk+d.keluar)));
  let consistScore=100;
  if(allDailyTotals.length>1){
    const avg=allDailyTotals.reduce((a,b)=>a+b,0)/allDailyTotals.length;
    const std=Math.sqrt(allDailyTotals.map(v=>Math.pow(v-avg,2)).reduce((a,b)=>a+b,0)/allDailyTotals.length);
    const cv=avg>0?std/avg:0; // coefficient of variation
    consistScore=Math.max(0,Math.round(100-cv*60));
  }
  // Komponen 2: Rasio Outbound vs Inbound (30%) â€” ideal 40:60 sampai 60:40
  const totK=reps.reduce((a,r)=>a+r.summary.totOutbound,0);
  const totM=reps.reduce((a,r)=>a+r.summary.totInbound,0);
  const tot=totK+totM;
  let ratioScore=100;
  if(tot>0){
    const ratio=totK/tot; // 0-1
    const distFrom50=Math.abs(ratio-0.5);
    ratioScore=Math.max(0,Math.round(100-distFrom50*160));
  }
  // Komponen 3: Vendor Activity (30%) â€” lebih banyak vendor aktif = lebih baik (max benchmark 20)
  const uniqueV=Object.keys(reps.reduce((a,r)=>{Object.keys(r.allVendors||{}).forEach(k=>a[k]=1);return a;},{})).length;
  const vendorScore=Math.min(100,Math.round(uniqueV/20*100));

  const total=Math.round(consistScore*0.4+ratioScore*0.3+vendorScore*0.3);
  let label,color;
  if(total>=80){label='Excellent';color='#0D8048';}
  else if(total>=65){label='Good';color='#059669';}
  else if(total>=50){label='Fair';color='#B8860B';}
  else if(total>=35){label='Needs Attention';color='#EA580C';}
  else{label='Critical';color='#E21F26';}
  return{score:total,label,color,scores:{konsistensi:consistScore,rasio:ratioScore,vendor:vendorScore}};
}

function renderHealthScore(health){
  const el=document.getElementById('healthNum');
  const arc=document.getElementById('healthArc');
  const circumference=2*Math.PI*46;
  el.textContent=health.score;
  el.style.color=health.color;
  document.getElementById('healthLabel').textContent=health.label;
  document.getElementById('healthLabel').style.color=health.color;
  arc.style.stroke=health.color;
  const offset=circumference*(1-health.score/100);
  setTimeout(()=>arc.style.strokeDashoffset=offset,100);

  const s=health.scores;
  const bars=[
    {label:'Volume Consistency',val:s.konsistensi,color:'#0058A3'},
    {label:'Inbound/Outbound Ratio',val:s.rasio,color:'#0D8048'},
    {label:'Vendor Activity',val:s.vendor,color:'#EA580C'},
  ];
  document.getElementById('healthBars').innerHTML=bars.map(b=>`
    <div class="health-bar-item">
      <span>${b.label}</span>
      <div class="health-bar-track"><div class="health-bar-fill" style="width:${b.val}%;background:${b.color}" data-w="${b.val}"></div></div>
      <span class="health-bar-pct" style="color:${b.color}">${b.val}</span>
    </div>`).join('');
}

// ===== NATURAL LANGUAGE SUMMARY =====
function buildNLSummary(reps,health){
  if(!reps.length)return;
  const totK=reps.reduce((a,r)=>a+r.summary.totOutbound,0);
  const totM=reps.reduce((a,r)=>a+r.summary.totInbound,0);
  const tot=totK+totM;
  const latest=reps[0];
  const prev=reps[1];

  let trend='',chips=[];
  if(prev){
    const diffK=latest.summary.totOutbound-prev.summary.totOutbound;
    const diffM=latest.summary.totInbound-prev.summary.totInbound;
    const pctK=prev.summary.totOutbound>0?Math.round(diffK/prev.summary.totOutbound*100):0;
    const pctM=prev.summary.totInbound>0?Math.round(diffM/prev.summary.totInbound*100):0;
    const kDir=diffK>=0?'up':'down';
    const mDir=diffM>=0?'up':'down';
    trend=`Compared to ${prev.bulan} ${prev.tahun}, Outbound <b>${kDir} ${Math.abs(pctK)}%</b> dan Inbound <b>${mDir} ${Math.abs(pctM)}%</b>. `;
    if(pctK>0)chips.push({text:`â†‘ Outbound +${pctK}%`,cls:'up'});
    else chips.push({text:`â†“ Outbound ${pctK}%`,cls:'down'});
    if(pctM>0)chips.push({text:`â†‘ Inbound +${pctM}%`,cls:'up'});
    else chips.push({text:`â†“ Inbound ${pctM}%`,cls:'down'});
  }

  const topVendor=Object.entries(reps.reduce((a,r)=>{Object.entries(r.allVendors||{}).forEach(([k,v])=>a[k]=(a[k]||0)+v);return a;},{})).sort((a,b)=>b[1]-a[1])[0];
  const vendorNote=topVendor?`Top vendor: <b>${topVendor[0]}</b> (${topVendor[1]} transactions). `:'';

  let healthNote='';
  if(health.score>=80)healthNote=`Operational status <b>excellent</b> dengan Health Score ${health.score}/100.`;
  else if(health.score>=65)healthNote=`Operational status <b>good</b>, Health Score ${health.score}/100.`;
  else if(health.score>=50)healthNote=`Operational status <b>fair</b>, perlu monitoring Health Score ${health.score}/100.`;
  else healthNote=`âš  Operational status <b>needs attention</b>, Health Score hanya ${health.score}/100.`;

  const text=`Total <b>${tot.toLocaleString('id-ID')} transactions</b> of <b>${reps.length} reports</b> (${reps[reps.length-1].bulan}â€“${reps[0].bulan} ${reps[0].tahun}). ${trend}${vendorNote}${healthNote}`;

  document.getElementById('nlText').innerHTML=text;
  chips.push({text:`${reps.length} Monthly Data`,cls:''});
  if(health.score<50)chips.push({text:'âš  Needs Attention',cls:'warn'});
  document.getElementById('nlChips').innerHTML=chips.map(c=>`<span class="nl-chip ${c.cls}">${c.text}</span>`).join('');
  document.getElementById('nlBox').style.display='block';
}

// ===== ANOMALY DETECTION =====
function detectAnomalies(reps){
  const anomalies=[];
  reps.forEach(r=>{
    const dailies=Object.entries(r.byDate);
    if(dailies.length<3)return;
    const totals=dailies.map(([,d])=>d.masuk+d.keluar);
    const avg=totals.reduce((a,b)=>a+b,0)/totals.length;
    const std=Math.sqrt(totals.map(v=>Math.pow(v-avg,2)).reduce((a,b)=>a+b,0)/totals.length);

    dailies.forEach(([dk,d])=>{
      const tot=d.masuk+d.keluar;
      const z=std>0?(tot-avg)/std:0;
      if(Math.abs(z)>2){
        const p=dk.split('-');const tgl=`${p[2]}/${p[1]}/${p[0]}`;
        const level=Math.abs(z)>3?'high':Math.abs(z)>2.5?'med':'low';
        const dir=tot>avg?'spike':'drop';
        const pct=Math.round(Math.abs((tot-avg)/avg*100));
        anomalies.push({level,tgl,dir,pct,tot,avg:Math.round(avg),periode:`${r.bulan} ${r.tahun}`,z:Math.abs(z).toFixed(1)});
      }
    });
  });
  anomalies.sort((a,b)=>parseFloat(b.z)-parseFloat(a.z));
  return anomalies.slice(0,6);
}

function renderAnomalies(reps){
  const anomalies=detectAnomalies(reps);
  const card=document.getElementById('anomalyCard');
  if(!anomalies.length){card.style.display='none';return;}
  card.style.display='block';
  document.getElementById('anomalyCnt').textContent=anomalies.length+' anomali';
  const lvlLabel={high:'High',med:'Medium',low:'Low'};
  document.getElementById('anomalyList').innerHTML=anomalies.map(a=>`
    <div class="anomaly-item ${a.level}">
      <div class="anomaly-dot ${a.level}"></div>
      <div>
        <div class="anomaly-title">${a.dir==='spike'?'ðŸ“ˆ':'ðŸ“‰'} ${a.dir.charAt(0).toUpperCase()+a.dir.slice(1)} ${a.pct}% â€” ${a.tgl}</div>
        <div class="anomaly-desc">${a.periode} Â· Volume: ${a.tot} transactions (normal average: ${a.avg}) Â· Anomaly level: <b>${lvlLabel[a.level]}</b> (z-score ${a.z}Ïƒ)</div>
      </div>
    </div>`).join('');
}

// ===== EXEC PROGRESS =====
function renderExecProgress(reps){
  if(!reps.length){document.getElementById('execProgress').innerHTML='<div class="empty-state" style="padding:20px"><p style="font-size:11px">Upload data to view progress</p></div>';return;}
  const html=reps.map((r,i)=>{
    const prev=reps[i+1];
    const diffK=prev?r.summary.totOutbound-prev.summary.totOutbound:0;
    const diffM=prev?r.summary.totInbound-prev.summary.totInbound:0;
    const maxTot=Math.max(...reps.map(x=>x.summary.total));
    const pct=maxTot>0?Math.round(r.summary.total/maxTot*100):0;
    const kColor=diffK>=0?'var(--green)':'var(--red)';
    const mColor=diffM>=0?'var(--green)':'var(--red)';
    return`<div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
        <span style="font-size:13px;font-weight:700">${r.bulan} ${r.tahun}</span>
        <div style="display:flex;gap:8px;align-items:center">
          ${prev?`<span style="font-size:10px;font-weight:700;color:${kColor}">${diffK>=0?'+':''}${diffK} K</span>
          <span style="font-size:10px;font-weight:700;color:${mColor}">${diffM>=0?'+':''}${diffM} M</span>`:'<span style="font-size:9px;color:var(--muted)">baseline</span>'}
          <span style="font-size:14px;font-weight:900;color:var(--navy);min-width:40px;text-align:right">${r.summary.total}</span>
        </div>
      </div>
      <div style="height:10px;background:#F3F4F6;border-radius:6px;overflow:hidden">
        <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,var(--blue),var(--teal));border-radius:6px;transition:width .8s ease"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:3px;font-size:9px;color:var(--muted)">
        <span>â†‘ ${r.summary.totOutbound} Outbound Â· â†“ ${r.summary.totInbound} Inbound</span>
        <span>${pct}% of tertinggi</span>
      </div>
    </div>`;
  }).join('');
  document.getElementById('execProgress').innerHTML=html;
}

// ===== DRILL DOWN =====
function openDrill(type){
  const reps=load();if(!reps.length)return;
  const totK=reps.reduce((a,r)=>a+r.summary.totOutbound,0);
  const totM=reps.reduce((a,r)=>a+r.summary.totInbound,0);
  const allV=reps.reduce((a,r)=>{Object.entries(r.allVendors||{}).forEach(([k,v])=>a[k]=(a[k]||0)+v);return a;},{});
  const vc=['#E21F26','#0058A3','#0D8048','#EA580C','#7C3AED','#00838F','#B8860B','#9CA3AF'];
  let title,kpi,sub,breakdown=[];

  if(type==='keluar'){
    title='Outbound (MRA) â€” Detail';kpi=totK.toLocaleString('id-ID');sub='Total transactions keluar of semua periode';
    breakdown=reps.map((r,i)=>({label:`${r.bulan} ${r.tahun}`,val:r.summary.totOutbound,color:vc[i%8],max:totK}));
  }else if(type==='masuk'){
    title='Inbound (DO) â€” Detail';kpi=totM.toLocaleString('id-ID');sub='Total transactions masuk of semua periode';
    breakdown=reps.map((r,i)=>({label:`${r.bulan} ${r.tahun}`,val:r.summary.totInbound,color:vc[i%8],max:totM}));
  }else if(type==='total'){
    title='Total Transaction â€” Detail';kpi=(totK+totM).toLocaleString('id-ID');sub='Total material movement across all periods';
    breakdown=reps.map((r,i)=>({label:`${r.bulan} ${r.tahun}`,val:r.summary.total,color:vc[i%8],max:Math.max(...reps.map(x=>x.summary.total))}));
  }else if(type==='vendor'){
    const uV=Object.keys(allV).length;
    title='Active Vendors â€” Detail';kpi=uV;sub='Unique vendor/perusahaan yang bertransactions';
    breakdown=Object.entries(allV).sort((a,b)=>b[1]-a[1]).slice(0,10).map((v,i)=>({label:v[0],val:v[1],color:vc[i%8],max:Object.values(allV)[0]||1}));
  }

  document.getElementById('drillTitle').textContent=title;
  document.getElementById('drillKPI').textContent=typeof kpi==='number'?kpi.toLocaleString('id-ID'):kpi;
  document.getElementById('drillSub').textContent=sub;
  const maxVal=Math.max(...breakdown.map(b=>b.val))||1;
  document.getElementById('drillBreakdown').innerHTML=breakdown.map(b=>`
    <div class="drill-row">
      <div class="drill-row-label">${b.label}</div>
      <div class="drill-row-bar"><div class="drill-row-fill" style="width:${Math.round(b.val/maxVal*100)}%;background:${b.color}"></div></div>
      <div class="drill-row-val" style="color:${b.color}">${b.val.toLocaleString('id-ID')}</div>
    </div>`).join('');
  document.getElementById('drillOverlay').classList.add('on');
}
function closeDrill(){document.getElementById('drillOverlay').classList.remove('on');}

// ===== DASHBOARD =====
let dc={};
function ddc(id){if(dc[id]){dc[id].destroy();delete dc[id];}}

function renderDash(){
  const reps=load();
  if(!reps.length){
    document.getElementById('dashWarn').style.display='flex';
    document.getElementById('dashOK').style.display='none';
    document.getElementById('nlBox').style.display='none';
    document.getElementById('anomalyCard').style.display='none';
    ['dOut','dIn','dTot','dVnd'].forEach(id=>document.getElementById(id).textContent='â€”');
    document.getElementById('dVendorBars').innerHTML='<div class="empty-state" style="padding:20px"><i class="fas fa-building" style="font-size:24px"></i><p style="font-size:11px">Upload data in Monthly Report tab</p></div>';
    renderHealthScore({score:0,label:'No Data',color:'#9CA3AF',scores:{konsistensi:0,rasio:0,vendor:0}});
    return;
  }
  document.getElementById('dashWarn').style.display='none';
  document.getElementById('dashOK').style.display='flex';

  // Health Score
  const health=calcHealth(reps);
  renderHealthScore(health);

  // NL Summary
  buildNLSummary(reps,health);

  // Anomaly Detection
  renderAnomalies(reps);

  // Exec Progress
  renderExecProgress(reps);

  let totK=0,totM=0;
  const allV={},allB={};
  const byMonth=[];

  reps.forEach(r=>{
    totK+=r.summary.totOutbound;totM+=r.summary.totInbound;
    byMonth.push({label:`${r.bulan.substr(0,3)} ${r.tahun}`,masuk:r.summary.totInbound,keluar:r.summary.totOutbound});
    Object.entries(r.allVendors||{}).forEach(([k,v])=>allV[k]=(allV[k]||0)+v);
    Object.entries(r.allBarangs||{}).forEach(([k,v])=>allB[k]=(allB[k]||0)+v);
  });
  byMonth.reverse();

  document.getElementById('dashOKText').textContent=`Data real of ${reps.length} reports Â· Terbaru: ${reps[0].bulan} ${reps[0].tahun} Â· Total ${(totK+totM).toLocaleString('id-ID')} transactions`;
  document.getElementById('dOut').textContent=totK.toLocaleString('id-ID');
  document.getElementById('dIn').textContent=totM.toLocaleString('id-ID');
  document.getElementById('dTot').textContent=(totK+totM).toLocaleString('id-ID');
  document.getElementById('dVnd').textContent=Object.keys(allV).length;
  document.getElementById('dOutT').innerHTML=`<i class="fas fa-calendar"></i> ${reps.length} reports`;
  document.getElementById('dInT').innerHTML=`<i class="fas fa-calendar"></i> ${reps.length} reports`;
  document.getElementById('dTotT').innerHTML=`<i class="fas fa-layer-group"></i> ${reps.length} bulan`;
  document.getElementById('dVndT').innerHTML=`<i class="fas fa-check"></i> data real`;

  const mLabels=byMonth.map(m=>m.label);
  const mK=byMonth.map(m=>m.keluar);
  const mM=byMonth.map(m=>m.masuk);
  const topV=Object.entries(allV).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const topB=Object.entries(allB).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const mx=topV[0]?.[1]||1;
  const vc=['#E21F26','#0058A3','#0D8048','#EA580C','#7C3AED','#00838F','#B8860B','#9CA3AF'];

  document.getElementById('dVendorBars').innerHTML=topV.map((v,i)=>`
    <div style="margin-bottom:10px">
      <div style="display:flex;justify-content:space-between;font-size:11px;font-weight:600;margin-bottom:3px">
        <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:80%">${v[0]}</span><span>${v[1]}</span>
      </div>
      <div style="height:6px;background:#F3F4F6;border-radius:4px">
        <div style="width:${(v[1]/mx*100).toFixed(1)}%;height:100%;background:${vc[i%8]};border-radius:4px"></div>
      </div>
    </div>`).join('');

  setTimeout(()=>{
    ddc('bar');
    const c1=document.getElementById('cDailyBar').getContext('2d');
    dc['bar']=new Chart(c1,{type:'bar',data:{labels:mLabels,datasets:[
      {label:'Outbound',data:mK,backgroundColor:'rgba(226,31,38,.75)',borderRadius:4},
      {label:'Inbound',data:mM,backgroundColor:'rgba(0,88,163,.75)',borderRadius:4}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10}}}},scales:{x:{ticks:{font:{size:9},maxRotation:30}},y:{ticks:{font:{size:9}}}}}});

    ddc('line');
    const c2=document.getElementById('cTrendLine').getContext('2d');
    dc['line']=new Chart(c2,{type:'line',data:{labels:mLabels,datasets:[
      {label:'Outbound',data:mK,borderColor:'#E21F26',backgroundColor:'rgba(226,31,38,.08)',fill:true,tension:.4},
      {label:'Inbound',data:mM,borderColor:'#0058A3',backgroundColor:'rgba(0,88,163,.08)',fill:true,tension:.4}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10}}}},scales:{x:{ticks:{font:{size:9},maxRotation:30}},y:{ticks:{font:{size:9}}}}}});

    ddc('bar2');
    const c3=document.getElementById('cBarang').getContext('2d');
    dc['bar2']=new Chart(c3,{type:'bar',data:{
      labels:topB.map(b=>b[0].length>18?b[0].substr(0,16)+'â€¦':b[0]),
      datasets:[{label:'Qty',data:topB.map(b=>b[1]),backgroundColor:'rgba(0,131,143,.7)',borderRadius:4}]
    },options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:9}}},y:{ticks:{font:{size:8}}}}}});
  },150);
}

// ===== AUDIT =====
let auditPg=1;
const PER=12;

function renderAudit(){
  const reps=load();
  if(!reps.length){
    document.getElementById('auditCnt').textContent='0 records';
    document.getElementById('auditList').innerHTML='<div class="empty-state"><i class="fas fa-folder-open"></i><p>No data available</p><span>Upload reports di Monthly Report</span></div>';
    return;
  }
  const filt=document.getElementById('auditFilt').value;
  const date=document.getElementById('auditDate').value;
  const srch=document.getElementById('auditSrch').value.toLowerCase();

  let items=[];
  reps.forEach(r=>{
    Object.entries(r.byDate).forEach(([dk,d])=>{
      if((!filt||filt==='masuk')&&d.masuk>0)
        items.push({dk,tipe:'masuk',qty:d.masuk,vendors:d.vendors,barangs:d.barangs,periode:`${r.bulan} ${r.tahun}`});
      if((!filt||filt==='keluar')&&d.keluar>0)
        items.push({dk,tipe:'keluar',qty:d.keluar,vendors:d.vendors,barangs:d.barangs,periode:`${r.bulan} ${r.tahun}`});
    });
  });
  items.sort((a,b)=>b.dk.localeCompare(a.dk));
  if(date)items=items.filter(i=>i.dk===date);
  if(srch)items=items.filter(i=>[...i.vendors,...i.barangs].some(x=>x.toLowerCase().includes(srch)));

  document.getElementById('auditCnt').textContent=items.length+' record';
  const page=items.slice((auditPg-1)*PER,auditPg*PER);
  document.getElementById('auditList').innerHTML=page.map(i=>{
    const p=i.dk.split('-');const tgl=`${p[2]}/${p[1]}/${p[0]}`;
    const col=i.tipe==='masuk'?'#0058A3':'#E21F26';
    const ico=i.tipe==='masuk'?'fa-arrow-down':'fa-arrow-up';
    return`<div class="log-item">
      <div class="log-icon" style="background:${col}"><i class="fas ${ico}"></i></div>
      <div class="log-content">
        <div class="log-title">${i.tipe==='masuk'?'Inbound (DO)':'Outbound (MRA)'} â€” ${tgl}</div>
        <div class="log-meta">${i.qty} transactions Â· ${i.periode}<br>${i.vendors.slice(0,3).join(', ')}${i.vendors.length>3?' â€¦':''}</div>
      </div>
      <div class="log-time">${tgl}</div>
    </div>`;
  }).join('')||'<div class="empty-state" style="padding:20px"><i class="fas fa-search" style="font-size:24px"></i><p style="font-size:11px">Tidak ada data</p></div>';
  renderPagi('auditPagi',items.length,auditPg,p=>{auditPg=p;renderAudit();});
}

// ===== RECORDS =====
let recPg=1;
function renderRecords(){
  const reps=load();
  if(!reps.length){
    document.getElementById('recCnt').textContent='0 records';
    document.getElementById('recBody').innerHTML='<tr><td colspan="9" style="text-align:center;padding:24px;color:var(--muted)">Upload reports di Monthly Report</td></tr>';
    return;
  }
  const tipe=document.getElementById('recTipe').value;
  const srch=document.getElementById('recSrch').value.toLowerCase();

  let rows=[];
  reps.forEach(r=>{
    Object.entries(r.byDate).forEach(([dk,d])=>{
      const p=dk.split('-');const tgl=`${p[2]}/${p[1]}/${p[0]}`;
      if(!tipe||tipe==='masuk')rows.push({tgl,tipe:'masuk',masuk:d.masuk,keluar:0,total:d.masuk,vendors:d.vendors,barangs:d.barangs,periode:`${r.bulan} ${r.tahun}`});
      if(!tipe||tipe==='keluar')rows.push({tgl,tipe:'keluar',masuk:0,keluar:d.keluar,total:d.keluar,vendors:d.vendors,barangs:d.barangs,periode:`${r.bulan} ${r.tahun}`});
    });
  });
  rows.sort((a,b)=>b.tgl.localeCompare(a.tgl));
  if(srch)rows=rows.filter(r=>r.vendors.some(v=>v.toLowerCase().includes(srch))||r.barangs.some(b=>b.toLowerCase().includes(srch)));

  document.getElementById('recCnt').textContent=rows.length+' record';
  const page=rows.slice((recPg-1)*PER,recPg*PER);
  document.getElementById('recBody').innerHTML=page.map((r,i)=>`
    <tr>
      <td>${(recPg-1)*PER+i+1}</td>
      <td><span class="badge ${r.tipe==='keluar'?'b-red':'b-blue'}">${r.tipe.toUpperCase()}</span></td>
      <td style="white-space:nowrap">${r.tgl}</td>
      <td style="text-align:center;color:var(--blue);font-weight:700">${r.masuk||'-'}</td>
      <td style="text-align:center;color:var(--red);font-weight:700">${r.keluar||'-'}</td>
      <td style="text-align:center;font-weight:800">${r.total}</td>
      <td style="font-size:10px">${r.vendors.slice(0,2).join(', ')}${r.vendors.length>2?' â€¦':''}</td>
      <td style="font-size:10px">${r.barangs.slice(0,2).join(', ')}${r.barangs.length>2?' â€¦':''}</td>
      <td><span class="badge b-teal">${r.periode}</span></td>
    </tr>`).join('');
  renderPagi('recPagi',rows.length,recPg,p=>{recPg=p;renderRecords();});
}

// ===== TREN =====
let tc={};
function dtc(id){if(tc[id]){tc[id].destroy();delete tc[id];}}

function renderTrends(){
  const reps=load();
  const ids=['tTotal','tOutbound','tInbound','tBulan','tVendor','tBarang'];
  if(!reps.length){ids.forEach(id=>document.getElementById(id).textContent='â€”');return;}
  let totK=0,totM=0;const allV={},allB={};
  reps.forEach(r=>{
    totK+=r.summary.totOutbound;totM+=r.summary.totInbound;
    Object.entries(r.allVendors||{}).forEach(([k,v])=>allV[k]=(allV[k]||0)+v);
    Object.entries(r.allBarangs||{}).forEach(([k,v])=>allB[k]=(allB[k]||0)+v);
  });
  document.getElementById('tTotal').textContent=(totK+totM).toLocaleString('id-ID');
  document.getElementById('tOutbound').textContent=totK.toLocaleString('id-ID');
  document.getElementById('tInbound').textContent=totM.toLocaleString('id-ID');
  document.getElementById('tBulan').textContent=reps.length;
  document.getElementById('tVendor').textContent=Object.keys(allV).length;
  document.getElementById('tBarang').textContent=Object.keys(allB).length;

  const mLabels=[...reps].reverse().map(r=>r.bulan.substr(0,3)+' '+r.tahun);
  const mK=[...reps].reverse().map(r=>r.summary.totOutbound);
  const mM=[...reps].reverse().map(r=>r.summary.totInbound);
  const topV=Object.entries(allV).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const topB=Object.entries(allB).sort((a,b)=>b[1]-a[1]).slice(0,10);

  setTimeout(()=>{
    dtc('m');
    const c1=document.getElementById('cTrendM').getContext('2d');
    tc['m']=new Chart(c1,{type:'line',data:{labels:mLabels,datasets:[
      {label:'Outbound',data:mK,borderColor:'#E21F26',backgroundColor:'rgba(226,31,38,.08)',fill:true,tension:.4},
      {label:'Inbound',data:mM,borderColor:'#0058A3',backgroundColor:'rgba(0,88,163,.08)',fill:true,tension:.4}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10}}}},scales:{x:{ticks:{font:{size:9}}},y:{ticks:{font:{size:9}}}}}});

    dtc('b');
    const c2=document.getElementById('cTrendB').getContext('2d');
    tc['b']=new Chart(c2,{type:'bar',data:{
      labels:topB.map(b=>b[0].length>18?b[0].substr(0,16)+'â€¦':b[0]),
      datasets:[{data:topB.map(b=>b[1]),backgroundColor:'rgba(234,88,12,.7)',borderRadius:4}]
    },options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:9}}},y:{ticks:{font:{size:8}}}}}});

    dtc('v');
    const c3=document.getElementById('cTrendV').getContext('2d');
    tc['v']=new Chart(c3,{type:'bar',data:{
      labels:topV.map(v=>v[0].length>25?v[0].substr(0,23)+'â€¦':v[0]),
      datasets:[{data:topV.map(v=>v[1]),backgroundColor:'rgba(0,88,163,.7)',borderRadius:4}]
    },options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:9}}},y:{ticks:{font:{size:8}}}}}});
  },150);
}

// ===== PAGINATION =====
function renderPagi(id,total,cur,cb){
  const pages=Math.ceil(total/PER);
  if(pages<=1){document.getElementById(id).innerHTML='';return;}
  let h=`<span>${(cur-1)*PER+1}â€“${Math.min(cur*PER,total)} of ${total}</span><div class="pagi-btns">`;
  for(let i=1;i<=pages;i++)h+=`<div class="pagi-btn${i===cur?' on':''}" onclick="(${cb})(${i})">${i}</div>`;
  h+='</div>';
  document.getElementById(id).innerHTML=h;
}

// ===== EXPORT CSV =====
function exportCSV(){
  const reps=load();
  if(!reps.length){alert('No data available');return;}
  let csv='Periode,Date,Inbound,Outbound,Total,Vendor,Material Type\n';
  reps.forEach(r=>{
    Object.entries(r.byDate).sort().forEach(([dk,d])=>{
      const p=dk.split('-');
      csv+=`"${r.bulan} ${r.tahun}","${p[2]}/${p[1]}/${p[0]}",${d.masuk},${d.keluar},${d.masuk+d.keluar},${d.vendors.length},${d.barangs.length}\n`;
    });
  });
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,\uFEFF'+encodeURIComponent(csv);
  a.download='MFPS_Export_'+new Date().toISOString().substr(0,10)+'.csv';
  a.click();
}

// Init
renderDash();
</script>
</body>
</html>
