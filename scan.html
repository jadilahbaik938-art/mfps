<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MFPS â€” Scan to Data</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap');
:root{
  --navy:#0A1F3F;--blue:#0058A3;--teal:#00838F;--red:#E21F26;--green:#0D8048;--gold:#B8860B;
  --bg:#F5F6FA;--card:#FFF;--txt:#1A1A2E;--txt2:#4B5563;--muted:#9CA3AF;--bdr:#E5E7EB;
  --r:12px;--r2:16px;--extreme:#DC2626;--high:#EA580C;--medium:#D97706;--low:#16A34A;
  --p-lime:#A8B400;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--txt);max-width:430px;margin:0 auto;min-height:100vh;position:relative;overflow-x:hidden}

.sbar{background:var(--navy);color:#fff;padding:6px 16px;font-size:10px;display:flex;justify-content:space-between}
.sbar-t{font-family:'JetBrains Mono',monospace;font-weight:600}

.hdr{background:#fff;padding:12px 16px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.hdr-l{display:flex;align-items:center;gap:10px}
.hdr-bk{width:32px;height:32px;border-radius:8px;border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--txt2);font-size:14px;background:#fff}
.hdr-tt{font-size:15px;font-weight:700}.hdr-sub{font-size:10px;color:var(--muted)}
.hdr-r{display:flex;gap:6px}
.hdr-btn{width:32px;height:32px;border-radius:8px;border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--txt2);font-size:13px;background:#fff;position:relative}
.hdr-dot{position:absolute;top:4px;right:4px;width:7px;height:7px;border-radius:50%;background:var(--red);border:1.5px solid #fff}

.off-ban{display:none;background:var(--extreme);color:#fff;padding:8px 16px;font-size:11px;text-align:center;font-weight:600}
.off-ban.show{display:block}

.scr{display:none;animation:fi .25s ease}.scr.on{display:block}
@keyframes fi{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* LOGIN */
.lg{display:flex;flex-direction:column;align-items:center;padding:20px 20px 30px;min-height:100vh;background:linear-gradient(180deg,#F4F6FA,#E8ECF4)}
.lg-logos{display:flex;align-items:center;gap:14px;margin-bottom:6px}
.lg-shield{width:72px;height:84px;background:linear-gradient(180deg,#1B3A6B 0%,#0A1F3F 100%);display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff;font-size:14px;clip-path:polygon(50% 0%,100% 12%,100% 75%,50% 100%,0% 75%,0% 12%);box-shadow:0 4px 18px rgba(10,31,63,.35);position:relative;border:none}
.lg-shield::before{content:'';position:absolute;inset:3px;clip-path:polygon(50% 0%,100% 12%,100% 75%,50% 100%,0% 75%,0% 12%);border:2px solid rgba(184,134,11,.5);background:transparent;z-index:1;pointer-events:none}
.lg-shield-txt{font-size:7px;font-weight:800;letter-spacing:1.8px;color:var(--gold);text-transform:uppercase;margin-top:2px;position:relative;z-index:2}
.lg-shield i{font-size:20px;color:#C9A84C;position:relative;z-index:2;text-shadow:0 1px 3px rgba(0,0,0,.3)}
.lg-brand{text-align:center;margin-bottom:20px}
.lg-brand h1{font-size:22px;font-weight:900;color:var(--navy);letter-spacing:-.5px}
.lg-brand p{font-size:10.5px;color:var(--txt2);margin-top:2px}
.lg-sec{font-size:8.5px;font-weight:700;text-transform:uppercase;letter-spacing:1.4px;color:var(--muted);margin:10px 0 8px;padding-left:2px;width:100%}
.lg-roles{width:100%}

.rc{display:flex;align-items:center;gap:11px;padding:12px 14px;background:#fff;border-radius:var(--r);border:1.5px solid var(--bdr);margin-bottom:7px;cursor:pointer;transition:all .15s}
.rc:hover{border-color:var(--blue);background:#F0F7FF}
.rc.sel{border-color:var(--red);background:#FEF2F2;box-shadow:0 0 0 3px rgba(226,31,38,.1)}
.rc-i{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;color:#fff;flex-shrink:0}
.rc-info{flex:1}.rc-n{font-size:12px;font-weight:700}.rc-d{font-size:9.5px;color:var(--txt2)}
.rc-step{font-size:8px;font-weight:700;color:var(--muted);font-family:'JetBrains Mono',monospace;flex-shrink:0}

.lg-btn{width:100%;padding:13px;border-radius:var(--r);background:var(--red);color:#fff;font-size:14px;font-weight:700;font-family:inherit;border:none;cursor:pointer;margin-top:10px;transition:background .15s}
.lg-btn:hover{background:#B91A20}
.lg-btn:disabled{background:var(--bdr);color:var(--muted);cursor:not-allowed}
.lg-foot{margin-top:14px;font-size:9px;color:var(--muted);text-align:center;display:flex;align-items:center;gap:5px}
.lg-dot{width:6px;height:6px;border-radius:50%;background:var(--green)}

/* DEST SELECT */
.dest-hd{font-size:11px;font-weight:700;color:var(--blue);margin-bottom:10px;display:flex;align-items:center;gap:6px}
.dest-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.dc{padding:16px 10px;border-radius:var(--r);border:1.5px solid var(--bdr);cursor:pointer;text-align:center;background:#fff;transition:all .15s}
.dc:hover{border-color:var(--blue);background:#F0F7FF}
.dc.sel{border-color:var(--red);background:#FEF2F2;box-shadow:0 0 0 3px rgba(226,31,38,.1)}
.dc i{font-size:22px;color:var(--blue);display:block;margin-bottom:6px}
.dc b{font-size:12px;display:block}.dc small{font-size:9px;color:var(--txt2)}

/* CARDS */
.cd{background:#fff;border-radius:var(--r2);border:1px solid var(--bdr);overflow:hidden;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.cd-h{padding:11px 14px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between}
.cd-t{font-size:12.5px;font-weight:700;display:flex;align-items:center;gap:6px}
.cd-t i{font-size:13px;color:var(--blue)}
.cd-b{padding:14px}
.badge{font-size:8px;font-weight:700;padding:3px 8px;border-radius:10px;text-transform:uppercase;letter-spacing:.3px}
.b-r{background:#FEE2E2;color:var(--extreme)}.b-g{background:#DCFCE7;color:var(--low)}.b-b{background:#DBEAFE;color:#2563EB}.b-o{background:#FED7AA;color:var(--high)}.b-n{background:#E0E7FF;color:#3730A3}.b-gd{background:#FEF3C7;color:#92400E}

/* FORM */
.fs{margin-bottom:14px}
.fs h3{font-size:11px;font-weight:700;color:var(--blue);margin-bottom:8px;display:flex;align-items:center;gap:6px;padding-bottom:5px;border-bottom:2px solid var(--blue)}
.fs h3 i{font-size:12px}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.fr.f1{grid-template-columns:1fr}
.fg{display:flex;flex-direction:column}
.fg label{font-size:9px;font-weight:700;color:var(--txt2);margin-bottom:3px;text-transform:uppercase;letter-spacing:.4px}
.fg input,.fg select,.fg textarea{padding:10px 12px;border:1.5px solid var(--bdr);border-radius:var(--r);font-size:13px;font-family:inherit;transition:all .15s;background:#fff;-webkit-appearance:none}
.fg input:focus,.fg select:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,88,163,.08)}
.fg select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239CA3AF' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}

/* STEPS */
.steps{display:flex;gap:0;margin-bottom:14px;padding:0 2px}
.stp{flex:1;display:flex;flex-direction:column;align-items:center;position:relative}
.stp-dot{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;z-index:2;box-shadow:0 2px 6px rgba(0,0,0,.1)}
.stp-dot.dn{background:var(--green)}.stp-dot.cr{background:var(--blue);animation:sp 2s infinite}.stp-dot.wt{background:var(--bdr);color:var(--muted)}
@keyframes sp{0%,100%{box-shadow:0 0 0 0 rgba(0,88,163,.3)}50%{box-shadow:0 0 0 8px rgba(0,88,163,0)}}
.stp-ln{position:absolute;top:13px;left:50%;width:100%;height:2px;background:var(--bdr);z-index:1}
.stp-ln.dn{background:var(--green)}
.stp:last-child .stp-ln{display:none}
.stp-lb{font-size:7.5px;font-weight:600;color:var(--txt2);margin-top:3px;text-align:center;max-width:52px;line-height:1.2}

/* QUEUE */
.qi{padding:11px 14px;border-bottom:1px solid var(--bdr);display:flex;gap:10px;align-items:flex-start;cursor:pointer;transition:background .15s}
.qi:hover{background:#F8FAFC}.qi:last-child{border-bottom:none}
.qi-i{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:13px;color:#fff;flex-shrink:0}
.qi-inf{flex:1;min-width:0}.qi-tt{font-size:11.5px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.qi-m{font-size:10px;color:var(--txt2);margin-top:1px;line-height:1.4}
.qi-r{text-align:right;flex-shrink:0}.qi-tm{font-size:9px;color:var(--muted);font-family:'JetBrains Mono',monospace}

/* CHECK */
.ck{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--bdr)}
.ck:last-child{border-bottom:none}
.ck-bx{width:26px;height:26px;border-radius:7px;border:2px solid var(--bdr);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;color:transparent;transition:all .15s;flex-shrink:0}
.ck-bx.ok{background:var(--green);border-color:var(--green);color:#fff}
.ck-bx.fl{background:var(--extreme);border-color:var(--extreme);color:#fff}
.ck-lb{font-size:11.5px;flex:1}.ck-st{font-size:8.5px;font-weight:700}

/* BUTTONS */
.btn{width:100%;padding:13px;border-radius:var(--r);font-size:13px;font-weight:700;font-family:inherit;cursor:pointer;border:none;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:6px}
.btn-bl{background:var(--blue);color:#fff}.btn-rd{background:var(--red);color:#fff}
.btn-gn{background:var(--green);color:#fff}.btn-gd{background:linear-gradient(135deg,var(--gold),#D4A017);color:#fff}
.btn-ol{background:#fff;border:1.5px solid var(--bdr);color:var(--txt2)}
.btn-sm{width:auto;padding:8px 14px;font-size:11px}
.btn-rw{display:flex;gap:8px}.btn-rw .btn{flex:1}

/* ALERT */
.al{padding:10px 12px;border-radius:var(--r);margin-bottom:10px;font-size:10.5px;line-height:1.5;border-left:3px solid;display:flex;gap:8px;align-items:flex-start}
.al i{margin-top:1px;flex-shrink:0;font-size:12px}
.al-r{background:#FEF2F2;border-color:var(--extreme);color:#7F1D1D}
.al-g{background:#F0FDF4;border-color:var(--green);color:#14532D}
.al-b{background:#EFF6FF;border-color:#2563EB;color:#1E3A5F}
.al-y{background:#FFFBEB;border-color:var(--medium);color:#78350F}
.al-o{background:#FFF7ED;border-color:var(--high);color:#7C2D12}

.mono{font-family:'JetBrains Mono',monospace;font-size:10.5px}
.sr{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--bdr);font-size:11px}
.sr:last-child{border-bottom:none}
.sr-l{color:var(--txt2)}.sr-v{font-weight:700}

.stamp{display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border-radius:var(--r);font-size:10px;font-weight:700;border:2px dashed}
.st-g{border-color:var(--green);color:var(--green);background:#F0FDF4}
.st-gd{border-color:var(--gold);color:#92400E;background:#FEF3C7}
.st-r{border-color:var(--extreme);color:var(--extreme);background:#FEF2F2}

/* ===== DESKTOP 768px+ ===== */
@media(min-width:768px){
  body{background:linear-gradient(135deg,#0A1F3F 0%,#102A4C 40%,#0E3B69 100%);max-width:none;padding:0;display:block}
  .desk-back{display:flex;align-items:center;justify-content:center;padding:12px;font-size:12px;background:rgba(0,0,0,.2)}
  .desk-back a{color:rgba(255,255,255,.7);text-decoration:none;font-weight:600}
  .desk-back a:hover{color:#fff}
  .scr{display:none;max-width:900px;margin:30px auto;background:#fff;border-radius:20px;box-shadow:0 16px 48px rgba(0,0,0,.25);overflow:hidden;min-height:auto;padding-bottom:20px}
  .scr.on{display:block}
  /* Login screen: transparent wrapper, let .lg handle styling */
  #s-login{background:transparent !important;box-shadow:none !important;padding-bottom:0 !important;overflow:visible !important}
  .lg{border-radius:20px;min-height:auto;padding:40px 60px 40px;background:linear-gradient(135deg,#0F2847,#163A6A,#0F2847) !important;max-width:900px;margin:0 auto;box-shadow:0 16px 48px rgba(0,0,0,.25)}
  .lg-brand{margin-bottom:24px}
  .lg-brand h1{font-size:34px;color:#FFFFFF !important;text-shadow:0 2px 8px rgba(0,0,0,.3);letter-spacing:-1px}
  .lg-brand p{color:rgba(255,255,255,.75) !important;font-size:13px !important}
  .lg-brand div{color:rgba(255,255,255,.6) !important}
  .lg-sec{color:var(--gold) !important}
  .lg-roles{max-width:100%}
  .rc{padding:14px 18px;background:#fff !important}
  .rc-info .rc-n{font-size:14px;color:var(--txt) !important}
  .rc-info .rc-d{font-size:11px;color:var(--txt2) !important}
  .lg-btn{max-width:400px;margin:16px auto 0}
  .lg-foot{margin-top:16px}
  .lg-foot a,.lg-foot span{color:rgba(255,255,255,.5) !important}
  /* Other screens */
  .hdr{border-radius:20px 20px 0 0;padding:14px 24px}
  .hdr-tt{font-size:17px}
  .sbar{border-radius:20px 20px 0 0;padding:8px 24px}
  .steps{padding:0 20px}
  .fs{margin:0 8px}
  .cd{margin-left:8px;margin-right:8px}
  .al{margin-left:8px;margin-right:8px}
  .fr{gap:12px}
  .fg label{font-size:11px}
  .fg input,.fg select,.fg textarea{font-size:12px;padding:10px 14px}
  .dest-grid{grid-template-columns:repeat(4,1fr)}
}
@media(max-width:767px){
  .desk-back{display:none}
}

</style>
</head>
<body>

<div class="desk-back"><a href="index.html"><i class="fas fa-arrow-left"></i> Kembali ke MFPS Launcher</a></div>

<div class="scr on" id="s-scan">
<div class="sbar"><span class="sbar-t"></span><span><i class="fas fa-signal"></i> <i class="fas fa-battery-three-quarters"></i></span></div>
<div class="hdr" style="border-bottom-color:var(--blue)"><div class="hdr-l"><div class="hdr-bk" onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i></div><div><div class="hdr-tt" style="color:var(--blue)"><i class="fas fa-camera"></i> Scan to Data</div><div class="hdr-sub">AI Document Scanner â†’ Database</div></div></div></div>
<div style="padding:14px 16px 80px">

  <div style="background:#DBEAFE;padding:10px 14px;border-radius:12px;display:flex;gap:10px;align-items:flex-start;margin-bottom:12px;font-size:11px;line-height:1.5;color:var(--blue)"><i class="fas fa-magic" style="margin-top:2px"></i><div><b>AI Document Scanner</b> â€” Foto Surat Jalan / Delivery Order / Bon Bintang â†’ Claude AI baca termasuk tulisan tangan â†’ data otomatis masuk Database.</div></div>

  <!-- API KEY -->
  <div class="cd" style="border-color:var(--navy)">
    <div class="cd-h" style="background:#F0F4FF"><div class="cd-t"><i class="fas fa-key" style="color:var(--navy)"></i> API Key</div><span class="badge" style="background:#E0E7FF;color:var(--navy)">1x SETUP</span></div>
    <div class="cd-b">
      <div class="fg"><label>Anthropic API Key</label><input id="scanApiKey" type="password" placeholder="sk-ant-api03-..."></div>
      <div style="font-size:9px;color:var(--muted);margin-bottom:8px"><i class="fas fa-lock"></i> Tersimpan di perangkat. Hanya digunakan untuk koneksi ke Anthropic.</div>
      <button class="btn btn-sm" style="background:var(--navy);color:#fff;width:100%;justify-content:center" onclick="localStorage.setItem('mfps_api_key',document.getElementById('scanApiKey').value);alert('âœ“ API Key tersimpan!')"><i class="fas fa-save"></i> Simpan</button>
    </div>
  </div>

  <!-- SCAN -->
  <div class="cd" style="border-color:var(--blue)">
    <div class="cd-h" style="background:#EFF6FF"><div class="cd-t"><i class="fas fa-camera" style="color:var(--blue)"></i> Scan Dokumen</div></div>
    <div class="cd-b">
      <div class="fg"><label>Tipe Dokumen</label><select id="scanDocType"><option value="masuk">ðŸ“¥ Barang MASUK (Surat Jalan / Delivery Order)</option><option value="keluar">ðŸ“¤ Barang KELUAR (Bon Bintang / Manifest)</option></select></div>
      <input type="file" id="scanFileInput" accept="image/*,application/pdf" capture="environment" style="display:none" onchange="handleScanFile(this)">
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm" style="flex:1;justify-content:center;background:var(--blue);color:#fff" onclick="document.getElementById('scanFileInput').setAttribute('capture','environment');document.getElementById('scanFileInput').click()"><i class="fas fa-camera"></i> Ambil Foto</button>
        <button class="btn btn-sm" style="flex:1;justify-content:center;background:transparent;color:var(--blue);border:1.5px solid var(--blue)" onclick="document.getElementById('scanFileInput').removeAttribute('capture');document.getElementById('scanFileInput').click()"><i class="fas fa-file-image"></i> Pilih File</button>
      </div>
      <div id="scanPreview" style="display:none;margin-top:12px">
        <div style="font-size:10px;font-weight:700;color:var(--txt2);margin-bottom:6px"><i class="fas fa-image"></i> PREVIEW</div>
        <img id="scanPrevImg" style="width:100%;border-radius:8px;border:1px solid var(--bdr)">
        <button class="btn btn-sm" style="margin-top:8px;width:100%;justify-content:center;background:var(--green);color:#fff" onclick="runAIScan()"><i class="fas fa-wand-magic-sparkles"></i> Proses dengan Claude AI</button>
      </div>
    </div>
  </div>

  <!-- PROCESSING -->
  <div id="scanLoading" style="display:none">
    <div class="cd" style="border-color:var(--gold)"><div class="cd-b" style="text-align:center;padding:30px">
      <i class="fas fa-spinner fa-spin" style="font-size:32px;color:var(--gold)"></i>
      <div style="font-size:14px;font-weight:700;color:var(--gold);margin-top:10px">Membaca Dokumen...</div>
      <div style="font-size:10px;color:var(--muted)">Claude AI sedang extract data termasuk tulisan tangan</div>
    </div></div>
  </div>

  <!-- RESULT -->
  <div id="scanResultArea" style="display:none"></div>

  <!-- SCAN HISTORY / DATABASE -->
  <div class="cd" style="border-color:var(--blue)">
    <div class="cd-h" style="background:#EFF6FF"><div class="cd-t"><i class="fas fa-database" style="color:var(--blue)"></i> Database Hasil Scan</div><span class="badge b-b" id="scanDbCount">0 data</span></div>
    <div class="cd-b">
      <div class="fg"><label>Cari PO / Vendor / Material / No. Kendaraan</label><input id="scanDbSearch" placeholder="Ketik..." oninput="filterScanDb()"></div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <div class="fg" style="flex:1"><label>Filter</label><select id="scanDbFilter" onchange="filterScanDb()"><option value="">Semua</option><option value="masuk">Barang Masuk</option><option value="keluar">Barang Keluar</option></select></div>
      </div>
      <div id="scanDbList" style="max-height:300px;overflow-y:auto;border:1px solid var(--bdr);border-radius:8px">
        <div style="padding:20px;text-align:center;color:var(--muted);font-size:11px"><i class="fas fa-camera-retro" style="font-size:24px;display:block;margin-bottom:8px;opacity:.4"></i>Belum ada data. Scan dokumen pertama Anda.</div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn btn-sm" style="flex:1;justify-content:center;background:transparent;color:var(--blue);border:1.5px solid var(--blue)" onclick="exportScanCSV()"><i class="fas fa-file-export"></i> Export CSV</button>
        <button class="btn btn-sm" style="flex:1;justify-content:center;background:transparent;color:var(--red);border:1.5px solid var(--red)" onclick="if(confirm('Hapus semua data scan?')){localStorage.removeItem('mfps_scan_db');renderScanDb()}"><i class="fas fa-trash"></i> Reset</button>
      </div>
    </div>
  </div>
</div>
</div>


<script>

function uc(){const t=new Date().toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',timeZone:'Asia/Makassar'})+' WITA';document.querySelectorAll('.sbar-t').forEach(e=>e.textContent=t)}uc();setInterval(uc,30000);

// ===== SCAN TO DATA =====
(function(){const k=localStorage.getItem('mfps_api_key');if(k){const el=document.getElementById('scanApiKey');if(el)el.value=k}renderScanDb()})();

let scanImgB64='';
function handleScanFile(inp){
  const f=inp.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=function(e){scanImgB64=e.target.result;document.getElementById('scanPrevImg').src=scanImgB64;document.getElementById('scanPreview').style.display='block'};
  r.readAsDataURL(f);
}

async function runAIScan(){
  const apiKey=localStorage.getItem('mfps_api_key');
  if(!apiKey){alert('âš  Set API Key dulu');return}
  if(!scanImgB64){alert('âš  Pilih foto dulu');return}

  const docType=document.getElementById('scanDocType').value;
  document.getElementById('scanLoading').style.display='block';
  document.getElementById('scanResultArea').style.display='none';

  const mType=scanImgB64.includes('image/png')?'image/png':scanImgB64.includes('application/pdf')?'application/pdf':'image/jpeg';
  const b64=scanImgB64.split(',')[1];
  const srcType=mType==='application/pdf'?'document':'image';

  const prompt=docType==='masuk'?
    'Baca Surat Jalan/Delivery Order barang MASUK ini (termasuk tulisan tangan). Kembalikan HANYA JSON tanpa backtick: {"tipe":"masuk","no_po":"","no_do":"","vendor":"","tanggal":"","no_polisi":"","nama_supir":"","items":[{"no":1,"qty":"","unit":"","material":"","remarks":""}],"total_items":0,"catatan":""}':
    'Baca Bon Bintang/Permintaan Pengangkutan Barang KELUAR ini (termasuk tulisan tangan). Kembalikan HANYA JSON tanpa backtick: {"tipe":"keluar","no_bon":"","tanggal":"","dari":"","tujuan":"","area":"","items":[{"jumlah":"","kesatuan":"","keterangan":"","berat":""}],"no_kendaraan":"","nama_supir":"","pemohon":"","pengirim":"","penerima":"","catatan":""}';

  try{
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:2000,messages:[{role:'user',content:[{type:srcType,source:{type:'base64',media_type:mType,data:b64}},{type:'text',text:prompt}]}]})
    });
    const data=await resp.json();
    document.getElementById('scanLoading').style.display='none';

    if(data.error){showScanError(data.error.message||JSON.stringify(data.error));return}

    const txt=data.content.map(c=>c.text||'').join('').replace(/```json|```/g,'').trim();
    let parsed;try{parsed=JSON.parse(txt)}catch(e){showScanError('Gagal parse: '+txt.substring(0,200));return}

    showScanResult(parsed);
    saveScanToDb(parsed);
    renderScanDb();

  }catch(err){
    document.getElementById('scanLoading').style.display='none';
    showScanError('Koneksi gagal: '+err.message);
  }
}

function showScanError(msg){
  document.getElementById('scanResultArea').style.display='block';
  document.getElementById('scanResultArea').innerHTML='<div style="background:#FEE2E2;padding:10px 14px;border-radius:12px;color:var(--red);font-size:11px;margin-bottom:12px"><i class="fas fa-exclamation-circle"></i> <b>Error:</b> '+msg+'</div>';
}

function showScanResult(d){
  document.getElementById('scanResultArea').style.display='block';
  let h='<div class="cd" style="border-color:var(--green)"><div class="cd-h" style="background:#F0FDF4"><div class="cd-t"><i class="fas fa-check-circle" style="color:var(--green)"></i> Data Berhasil Diekstrak</div><span class="badge '+(d.tipe==='masuk'?'b-b':'b-o')+'">'+(d.tipe==='masuk'?'MASUK':'KELUAR')+'</span></div><div class="cd-b">';

  if(d.tipe==='masuk'){
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px;margin-bottom:8px">';
    h+='<div><span style="color:var(--muted)">No. PO:</span> <b>'+(d.no_po||'-')+'</b></div>';
    h+='<div><span style="color:var(--muted)">No. DO:</span> <b>'+(d.no_do||'-')+'</b></div>';
    h+='<div><span style="color:var(--muted)">Vendor:</span> <b>'+(d.vendor||'-')+'</b></div>';
    h+='<div><span style="color:var(--muted)">Tanggal:</span> <b>'+(d.tanggal||'-')+'</b></div>';
    h+='<div><span style="color:var(--muted)">No. Polisi:</span> <b>'+(d.no_polisi||'-')+'</b></div>';
    h+='<div><span style="color:var(--muted)">Supir:</span> <b>'+(d.nama_supir||'-')+'</b></div>';
    h+='</div>';
    if(d.items&&d.items.length){
      h+='<div style="font-size:10px;font-weight:700;color:var(--navy);margin-bottom:4px"><i class="fas fa-list"></i> '+d.items.length+' ITEM MATERIAL</div>';
      h+='<div style="max-height:180px;overflow-y:auto;border:1px solid var(--bdr);border-radius:8px;font-size:10px"><table style="width:100%;border-collapse:collapse"><tr style="background:#F3F4F6"><th style="padding:5px;text-align:left;border-bottom:1px solid var(--bdr)">#</th><th style="padding:5px;text-align:left;border-bottom:1px solid var(--bdr)">Qty</th><th style="padding:5px;text-align:left;border-bottom:1px solid var(--bdr)">Unit</th><th style="padding:5px;text-align:left;border-bottom:1px solid var(--bdr)">Material</th></tr>';
      d.items.forEach(i=>{h+='<tr style="border-bottom:1px solid var(--bdr)"><td style="padding:5px">'+(i.no||'')+'</td><td style="padding:5px">'+(i.qty||'')+'</td><td style="padding:5px">'+(i.unit||'')+'</td><td style="padding:5px">'+(i.material||'')+'</td></tr>'});
      h+='</table></div>';
    }
  } else {
    h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;font-size:11px;margin-bottom:8px">';
    h+='<div><span style="color:var(--muted)">No. Bon:</span> <b>'+(d.no_bon||'-')+'</b></div>';
    h+='<div><span style="color:var(--muted)">Tanggal:</span> <b>'+(d.tanggal||'-')+'</b></div>';
    h+='<div><span style="color:var(--muted)">Dari:</span> <b>'+(d.dari||'-')+'</b></div>';
    h+='<div><span style="color:var(--muted)">Tujuan:</span> <b>'+(d.tujuan||'-')+'</b></div>';
    h+='<div><span style="color:var(--muted)">Area:</span> <b>'+(d.area||'-')+'</b></div>';
    h+='<div><span style="color:var(--muted)">Kendaraan:</span> <b>'+(d.no_kendaraan||'-')+'</b></div>';
    h+='<div><span style="color:var(--muted)">Supir:</span> <b>'+(d.nama_supir||'-')+'</b></div>';
    h+='</div>';
    if(d.items&&d.items.length){
      h+='<div style="border:1px solid var(--bdr);border-radius:8px;font-size:10px"><table style="width:100%;border-collapse:collapse"><tr style="background:#F3F4F6"><th style="padding:5px;text-align:left;border-bottom:1px solid var(--bdr)">Jumlah</th><th style="padding:5px;text-align:left;border-bottom:1px solid var(--bdr)">Satuan</th><th style="padding:5px;text-align:left;border-bottom:1px solid var(--bdr)">Keterangan</th><th style="padding:5px;text-align:left;border-bottom:1px solid var(--bdr)">Berat</th></tr>';
      d.items.forEach(i=>{h+='<tr><td style="padding:5px">'+(i.jumlah||'')+'</td><td style="padding:5px">'+(i.kesatuan||'')+'</td><td style="padding:5px">'+(i.keterangan||'')+'</td><td style="padding:5px">'+(i.berat||'-')+'</td></tr>'});
      h+='</table></div>';
    }
    if(d.pemohon||d.pengirim||d.penerima){
      h+='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;font-size:10px;margin-top:8px;background:#F9FAFB;padding:8px;border-radius:6px">';
      h+='<div><span style="color:var(--muted)">Pemohon:</span><br><b>'+(d.pemohon||'-')+'</b></div>';
      h+='<div><span style="color:var(--muted)">Pengirim:</span><br><b>'+(d.pengirim||'-')+'</b></div>';
      h+='<div><span style="color:var(--muted)">Penerima:</span><br><b>'+(d.penerima||'-')+'</b></div></div>';
    }
  }
  h+='<div style="background:#D1FAE5;padding:8px 12px;border-radius:8px;margin-top:10px;font-size:11px;color:var(--green);text-align:center"><i class="fas fa-database"></i> <b>Data otomatis tersimpan ke Database</b></div>';
  h+='</div></div>';
  document.getElementById('scanResultArea').innerHTML=h;
}

// ===== SCAN DATABASE =====
function loadScanDb(){try{return JSON.parse(localStorage.getItem('mfps_scan_db'))||[]}catch(e){return[]}}
function saveScanToDb(d){
  const db=loadScanDb();
  d._id='SCN-'+Date.now();d._scannedAt=new Date().toISOString();d._scannedBy='Legality Officer';
  db.unshift(d);if(db.length>500)db.pop();
  localStorage.setItem('mfps_scan_db',JSON.stringify(db));
}

function renderScanDb(){
  filterScanDb();
}

function filterScanDb(){
  const db=loadScanDb();
  const q=(document.getElementById('scanDbSearch')?.value||'').toLowerCase();
  const ft=document.getElementById('scanDbFilter')?.value||'';
  const filtered=db.filter(d=>{
    const matchType=!ft||d.tipe===ft;
    const txt=JSON.stringify(d).toLowerCase();
    const matchQ=!q||txt.includes(q);
    return matchType&&matchQ;
  });

  const countEl=document.getElementById('scanDbCount');
  if(countEl)countEl.textContent=filtered.length+' dari '+db.length+' data';

  const list=document.getElementById('scanDbList');if(!list)return;
  if(!filtered.length){list.innerHTML='<div style="padding:20px;text-align:center;color:var(--muted);font-size:11px"><i class="fas fa-camera-retro" style="font-size:24px;display:block;margin-bottom:8px;opacity:.4"></i>Tidak ada data</div>';return}

  let h='';
  filtered.forEach(d=>{
    const isMasuk=d.tipe==='masuk';
    const color=isMasuk?'var(--blue)':'var(--orange)';
    const icon=isMasuk?'truck-ramp-box':'truck-arrow-right';
    const label=isMasuk?(d.no_po||d.no_do||'-'):(d.no_bon||'-');
    const vendor=isMasuk?(d.vendor||'-'):(d.dari||'-');
    const itemCount=d.items?d.items.length:0;
    const time=d._scannedAt?new Date(d._scannedAt).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',hour12:false}):'';
    const date=d._scannedAt?new Date(d._scannedAt).toLocaleDateString('id-ID',{day:'2-digit',month:'short'}):'';
    h+='<div class="qi" style="border-bottom:1px solid var(--bdr)"><div class="qi-i" style="background:'+color+';width:28px;height:28px;border-radius:6px;font-size:10px"><i class="fas fa-'+icon+'"></i></div><div class="qi-inf"><div class="qi-tt" style="font-size:10.5px">'+label+' Â· '+vendor+'</div><div class="qi-m" style="font-size:9px">'+(isMasuk?'Masuk':'Keluar')+' â€” '+itemCount+' item Â· '+(d.tanggal||'-')+'<br><span style="color:'+color+'">Scanned '+date+' '+time+'</span></div></div></div>';
  });
  list.innerHTML=h;
}

function exportScanCSV(){
  const db=loadScanDb();if(!db.length){alert('Tidak ada data');return}
  let csv='Tipe,No Dokumen,Vendor/Dari,Tanggal,Item Count,No Kendaraan,Supir,Scanned At\n';
  db.forEach(d=>{
    const label=d.tipe==='masuk'?(d.no_po||d.no_do):(d.no_bon||'-');
    const vendor=d.tipe==='masuk'?(d.vendor||'-'):(d.dari||'-');
    const nopol=d.tipe==='masuk'?(d.no_polisi||'-'):(d.no_kendaraan||'-');
    const supir=d.nama_supir||'-';
    csv+=d.tipe+','+label+','+vendor+','+(d.tanggal||'-')+','+(d.items?d.items.length:0)+','+nopol+','+supir+','+(d._scannedAt||'')+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='MFPS_ScanData_'+new Date().toISOString().split('T')[0]+'.csv';a.click();
  alert('âœ“ CSV exported!');
}
</script>
</body>
</html>