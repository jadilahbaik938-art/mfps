<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MFPS — Recording & Reporting</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap');
:root{
  --navy:#0A1F3F;--blue:#0058A3;--teal:#00838F;--red:#E21F26;--green:#0D8048;--gold:#B8860B;
  --bg:#F0F2F7;--card:#FFF;--txt:#1A1A2E;--txt2:#4B5563;--muted:#9CA3AF;--bdr:#E5E7EB;
  --r:12px;--r2:16px;--orange:#EA580C;--purple:#7C3AED;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--txt);min-height:100vh;overflow-x:hidden}
.sbar{background:var(--navy);color:#fff;padding:6px 16px;font-size:10px;display:flex;justify-content:space-between;align-items:center}
.sbar-t{font-family:'JetBrains Mono',monospace;font-weight:600}
.hdr{background:#fff;padding:12px 16px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.hdr-l{display:flex;align-items:center;gap:10px}
.hdr-bk{width:34px;height:34px;border-radius:10px;border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--txt2);font-size:14px;background:#fff;text-decoration:none;transition:.15s}
.hdr-bk:hover{background:var(--bg);border-color:var(--navy);color:var(--navy)}
.hdr-tt{font-size:15px;font-weight:700}.hdr-sub{font-size:10px;color:var(--muted)}
.tabs{display:flex;background:#fff;border-bottom:2px solid var(--bdr);overflow-x:auto;-webkit-overflow-scrolling:touch}
.tab{flex:1;min-width:0;padding:12px 8px;text-align:center;font-size:11px;font-weight:600;color:var(--muted);cursor:pointer;border-bottom:2.5px solid transparent;transition:.2s;white-space:nowrap;display:flex;align-items:center;justify-content:center;gap:5px}
.tab.on{color:var(--navy);border-bottom-color:var(--blue);background:#F5F8FF}
.tab:hover{color:var(--navy);background:#FAFBFF}
.tab i{font-size:12px}
.main{padding:16px;max-width:1400px;margin:0 auto}
.section{display:none;animation:fi .3s ease}.section.on{display:block}
@keyframes fi{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
.stat{background:#fff;border-radius:var(--r2);padding:16px;border-left:4px solid transparent;box-shadow:0 1px 4px rgba(0,0,0,.04);position:relative;overflow:hidden}
.stat::after{content:'';position:absolute;top:-20px;right:-20px;width:60px;height:60px;border-radius:50%;opacity:.06}
.stat-num{font-size:28px;font-weight:900;letter-spacing:-1px;line-height:1}
.stat-label{font-size:10px;color:var(--txt2);margin-top:4px;font-weight:500}
.stat-trend{font-size:9px;font-weight:700;margin-top:6px;display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:20px}
.stat.s-out{border-left-color:var(--red)}.stat.s-out .stat-num{color:var(--red)}.stat.s-out::after{background:var(--red)}
.stat.s-in{border-left-color:var(--blue)}.stat.s-in .stat-num{color:var(--blue)}.stat.s-in::after{background:var(--blue)}
.stat.s-ok{border-left-color:var(--green)}.stat.s-ok .stat-num{color:var(--green)}.stat.s-ok::after{background:var(--green)}
.stat.s-exc{border-left-color:var(--orange)}.stat.s-exc .stat-num{color:var(--orange)}.stat.s-exc::after{background:var(--orange)}
.stat.s-rej{border-left-color:var(--red)}.stat.s-rej .stat-num{color:var(--red)}
.stat.s-pen{border-left-color:var(--gold)}.stat.s-pen .stat-num{color:var(--gold)}
.cd{background:#fff;border-radius:var(--r2);border:1.5px solid var(--bdr);overflow:hidden;margin-bottom:14px;box-shadow:0 1px 4px rgba(0,0,0,.03)}
.cd-h{padding:12px 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--bdr);background:#FAFBFC}
.cd-t{font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px}
.cd-t i{font-size:14px}
.cd-b{padding:14px 16px}
.chart-wrap{position:relative;width:100%;height:220px;margin:8px 0}
.tbl-wrap{overflow-x:auto;border:1px solid var(--bdr);border-radius:10px;margin-top:8px}
table{width:100%;border-collapse:collapse;font-size:11px;min-width:700px}
th{background:#F3F4F6;padding:10px 12px;text-align:left;font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:.5px;color:var(--txt2);border-bottom:2px solid var(--bdr);position:sticky;top:0}
td{padding:9px 12px;border-bottom:1px solid #F3F4F6;vertical-align:top}
tr:hover td{background:#F8FAFF}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:.3px}
.b-green{background:#D1FAE5;color:#065F46}.b-red{background:#FEE2E2;color:#991B1B}
.b-blue{background:#DBEAFE;color:#1E40AF}.b-orange{background:#FFEDD5;color:#9A3412}
.b-gold{background:#FEF3C7;color:#92400E}.b-purple{background:#EDE9FE;color:#5B21B6}
.b-gray{background:#F3F4F6;color:#4B5563}.b-teal{background:#CCFBF1;color:#0F766E}
.log-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid #F3F4F6;position:relative}
.log-item:last-child{border-bottom:none}
.log-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff;flex-shrink:0}
.log-content{flex:1;min-width:0}
.log-title{font-size:12px;font-weight:600;margin-bottom:2px}
.log-meta{font-size:10px;color:var(--muted);line-height:1.5}
.log-time{font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--muted);flex-shrink:0;text-align:right}
.fbar{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center}
.fbar select,.fbar input{padding:8px 12px;border:1.5px solid var(--bdr);border-radius:8px;font-family:'Outfit',sans-serif;font-size:11px;background:#fff;color:var(--txt);outline:none;transition:.2s}
.fbar select:focus,.fbar input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(0,88,163,.1)}
.fbar input{flex:1;min-width:120px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:8px;font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;cursor:pointer;border:none;transition:.2s}
.btn-primary{background:var(--navy);color:#fff}.btn-primary:hover{background:#0E2A4F}
.btn-export{background:#fff;color:var(--green);border:1.5px solid var(--green)}.btn-export:hover{background:#F0FDF4}
.btn-pdf{background:#fff;color:var(--red);border:1.5px solid var(--red)}.btn-pdf:hover{background:#FEF2F2}
.btn-sm{padding:6px 12px;font-size:10px;border-radius:6px}
.btn-teal{background:#fff;color:var(--teal);border:1.5px solid var(--teal)}.btn-teal:hover{background:#F0FDFA}
.pagi{display:flex;align-items:center;justify-content:space-between;margin-top:12px;font-size:11px;color:var(--txt2)}
.pagi-btns{display:flex;gap:4px}
.pagi-btn{width:30px;height:30px;border-radius:6px;border:1px solid var(--bdr);background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;font-weight:600;transition:.15s}
.pagi-btn.on{background:var(--navy);color:#fff;border-color:var(--navy)}
.pagi-btn:hover:not(.on){background:var(--bg)}
.summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.summary-box{background:#fff;border-radius:var(--r);padding:14px;text-align:center;border:1px solid var(--bdr)}
.summary-box-num{font-size:22px;font-weight:800;line-height:1.1}
.summary-box-label{font-size:9px;color:var(--txt2);margin-top:4px;text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.donut-wrap{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
.donut-chart{width:140px;height:140px;flex-shrink:0}
.donut-legend{flex:1;min-width:120px}
.donut-legend-item{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:11px}
.donut-legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

/* === MONTHLY REPORT STYLES === */
.upload-zone{border:2.5px dashed var(--bdr);border-radius:var(--r2);padding:40px 20px;text-align:center;cursor:pointer;transition:.2s;background:#FAFBFC;position:relative}
.upload-zone:hover,.upload-zone.drag{border-color:var(--blue);background:#F0F7FF}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-zone-icon{font-size:40px;color:var(--muted);margin-bottom:12px}
.upload-zone-title{font-size:14px;font-weight:700;color:var(--txt);margin-bottom:4px}
.upload-zone-sub{font-size:11px;color:var(--muted)}
.upload-zone.has-file{border-color:var(--green);background:#F0FDF4}
.upload-zone.has-file .upload-zone-icon{color:var(--green)}
.monthly-hist{display:flex;flex-direction:column;gap:10px;margin-top:16px}
.monthly-hist-item{background:#fff;border:1.5px solid var(--bdr);border-radius:var(--r);padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:.2s}
.monthly-hist-item:hover{border-color:var(--blue);box-shadow:0 2px 8px rgba(0,88,163,.08)}
.monthly-hist-item.active{border-color:var(--blue);background:#F0F7FF}
.hist-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--blue),var(--teal));display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;flex-shrink:0}
.hist-info{flex:1;min-width:0}
.hist-title{font-size:13px;font-weight:700}
.hist-meta{font-size:10px;color:var(--muted);margin-top:2px}
.hist-stats{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
.hist-stat{font-size:9px;font-weight:700;padding:2px 8px;border-radius:20px}
.hist-actions{display:flex;gap:6px;flex-shrink:0}
.monthly-detail{background:#fff;border-radius:var(--r2);border:1.5px solid var(--blue);padding:16px;margin-top:14px;display:none}
.monthly-detail.on{display:block}
.monthly-kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}
.kpi-box{background:var(--bg);border-radius:var(--r);padding:14px;text-align:center}
.kpi-num{font-size:24px;font-weight:900;line-height:1}
.kpi-label{font-size:10px;color:var(--txt2);margin-top:3px;font-weight:500}
.kpi-vs{font-size:9px;font-weight:700;margin-top:4px}
.empty-state{text-align:center;padding:48px 20px;color:var(--muted)}
.empty-state i{font-size:48px;margin-bottom:12px;display:block}
.empty-state p{font-size:13px;font-weight:600;margin-bottom:4px;color:var(--txt2)}
.empty-state span{font-size:11px}
.template-tip{background:#EFF6FF;border:1px solid #BFDBFE;border-radius:var(--r);padding:12px 16px;margin-bottom:16px;font-size:11px;color:#1E40AF;display:flex;gap:10px;align-items:flex-start}
.template-tip i{flex-shrink:0;margin-top:1px}

@media(min-width:768px){
  .stats{grid-template-columns:repeat(3,1fr)}
  .summary-grid{grid-template-columns:repeat(6,1fr)}
  .chart-wrap{height:300px}
  .main{padding:24px}
  .cd-b{padding:18px 20px}
  .hdr{padding:14px 24px}
  .tabs{justify-content:center}
  .tab{flex:none;padding:14px 24px;font-size:12px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .monthly-kpi{grid-template-columns:repeat(4,1fr)}
}
@media(min-width:1200px){
  .stats{grid-template-columns:repeat(6,1fr)}
  .stat-num{font-size:32px}
  .main{padding:28px 40px}
}
</style>
</head>
<body>

<div class="sbar">
  <span>MFPS Recording & Reporting</span>
  <span class="sbar-t" id="clock">--:--</span>
  <span>RU V Balikpapan</span>
</div>

<div class="hdr">
  <div class="hdr-l">
    <a class="hdr-bk" href="index.html"><i class="fas fa-arrow-left"></i></a>
    <div>
      <div class="hdr-tt"><i class="fas fa-chart-line" style="color:var(--blue);margin-right:4px"></i> Recording & Reporting</div>
      <div class="hdr-sub">ISO 31000:2018 Compliance · Dashboard Analitik</div>
    </div>
  </div>
  <div style="display:flex;gap:6px">
    <button class="btn btn-sm btn-export" onclick="exportAllExcel()"><i class="fas fa-file-excel"></i> Excel</button>
    <button class="btn btn-sm btn-pdf" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
  </div>
</div>

<div class="tabs">
  <div class="tab on" onclick="showTab('dashboard',this)"><i class="fas fa-chart-pie"></i> Dashboard</div>
  <div class="tab" onclick="showTab('audit',this)"><i class="fas fa-clipboard-list"></i> Audit Trail</div>
  <div class="tab" onclick="showTab('records',this)"><i class="fas fa-database"></i> Data Record</div>
  <div class="tab" onclick="showTab('trends',this)"><i class="fas fa-chart-area"></i> Tren & Grafik</div>
  <div class="tab" onclick="showTab('monthly',this)"><i class="fas fa-calendar-alt"></i> Monthly Report</div>
</div>

<div class="main">

<!-- ============== SECTION 1: DASHBOARD ============== -->
<div class="section on" id="sec-dashboard">
  <div class="stats" id="statCards">
    <div class="stat s-out">
      <div class="stat-num" id="totalOut">247</div>
      <div class="stat-label">Barang Keluar (MRA)</div>
      <div class="stat-trend" style="background:#FEE2E2;color:var(--red)"><i class="fas fa-arrow-up"></i> +12 hari ini</div>
    </div>
    <div class="stat s-in">
      <div class="stat-num" id="totalIn">183</div>
      <div class="stat-label">Barang Masuk (DO)</div>
      <div class="stat-trend" style="background:#DBEAFE;color:var(--blue)"><i class="fas fa-arrow-up"></i> +8 hari ini</div>
    </div>
    <div class="stat s-ok">
      <div class="stat-num" id="totalApproved">389</div>
      <div class="stat-label">Approved</div>
      <div class="stat-trend" style="background:#D1FAE5;color:var(--green)"><i class="fas fa-check"></i> 90.5%</div>
    </div>
    <div class="stat s-exc">
      <div class="stat-num" id="totalException">23</div>
      <div class="stat-label">Exception/Urgent</div>
      <div class="stat-trend" style="background:#FFEDD5;color:var(--orange)"><i class="fas fa-exclamation-triangle"></i> 5.3%</div>
    </div>
    <div class="stat s-rej">
      <div class="stat-num" id="totalRejected">11</div>
      <div class="stat-label">Rejected</div>
      <div class="stat-trend" style="background:#FEE2E2;color:var(--red)"><i class="fas fa-times"></i> 2.6%</div>
    </div>
    <div class="stat s-pen">
      <div class="stat-num" id="totalPending">7</div>
      <div class="stat-label">Pending Review</div>
      <div class="stat-trend" style="background:#FEF3C7;color:var(--gold)"><i class="fas fa-clock"></i> 1.6%</div>
    </div>
  </div>

  <div class="two-col">
    <div class="cd">
      <div class="cd-h">
        <div class="cd-t"><i class="fas fa-chart-bar" style="color:var(--blue)"></i> Pergerakan Harian (7 Hari)</div>
        <select id="chartPeriod" onchange="updateDailyChart()" style="padding:4px 8px;border:1px solid var(--bdr);border-radius:6px;font-size:10px;font-family:'Outfit',sans-serif">
          <option value="7">7 Hari</option>
          <option value="14">14 Hari</option>
          <option value="30">30 Hari</option>
        </select>
      </div>
      <div class="cd-b">
        <div class="chart-wrap"><canvas id="chartDaily"></canvas></div>
      </div>
    </div>
    <div class="cd">
      <div class="cd-h">
        <div class="cd-t"><i class="fas fa-chart-pie" style="color:var(--green)"></i> Status Approval</div>
      </div>
      <div class="cd-b">
        <div class="donut-wrap">
          <div class="donut-chart"><canvas id="chartDonut"></canvas></div>
          <div class="donut-legend" id="donutLegend"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="two-col">
    <div class="cd">
      <div class="cd-h">
        <div class="cd-t"><i class="fas fa-building" style="color:var(--teal)"></i> Top 5 Vendor / Perusahaan</div>
      </div>
      <div class="cd-b">
        <div id="topVendors"></div>
      </div>
    </div>
    <div class="cd">
      <div class="cd-h">
        <div class="cd-t"><i class="fas fa-door-open" style="color:var(--navy)"></i> Distribusi per Gate</div>
      </div>
      <div class="cd-b">
        <div class="chart-wrap" style="height:180px"><canvas id="chartGate"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- ============== SECTION 2: AUDIT TRAIL ============== -->
<div class="section" id="sec-audit">
  <div class="fbar">
    <select id="auditFilter" onchange="renderAudit()">
      <option value="">Semua Aktivitas</option>
      <option value="submit">MRA Submit</option>
      <option value="approve">Approved</option>
      <option value="reject">Rejected</option>
      <option value="verify">Verified</option>
      <option value="stamp">Stamp Applied</option>
      <option value="exception">Exception</option>
      <option value="gate_pass">Gate Pass</option>
    </select>
    <select id="auditRole" onchange="renderAudit()">
      <option value="">Semua Role</option>
      <option value="Creator">Creator</option>
      <option value="Section Head Area">Section Head Area</option>
      <option value="Legality Officer">Legality Officer</option>
      <option value="Gate Inspector">Gate Inspector</option>
      <option value="SSH">Security Section Head</option>
    </select>
    <input type="date" id="auditDate" onchange="renderAudit()">
    <input type="text" id="auditSearch" placeholder="Cari MRA ID, nama, vendor..." oninput="renderAudit()">
  </div>
  <div class="cd">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-clipboard-list" style="color:var(--purple)"></i> Audit Trail Log</div>
      <span class="badge b-purple" id="auditCount">0 record</span>
    </div>
    <div class="cd-b" id="auditList" style="max-height:600px;overflow-y:auto"></div>
    <div class="pagi" id="auditPagi"></div>
  </div>
</div>

<!-- ============== SECTION 3: DATA RECORDS ============== -->
<div class="section" id="sec-records">
  <div class="fbar">
    <select id="recType" onchange="renderRecords()">
      <option value="">Semua Tipe</option>
      <option value="keluar">Barang Keluar</option>
      <option value="masuk">Barang Masuk</option>
    </select>
    <select id="recStatus" onchange="renderRecords()">
      <option value="">Semua Status</option>
      <option value="Completed">Completed</option>
      <option value="Approved">Approved</option>
      <option value="Pending">Pending</option>
      <option value="Rejected">Rejected</option>
      <option value="Exception">Exception</option>
    </select>
    <input type="text" id="recSearch" placeholder="Cari No. MRA, vendor, material..." oninput="renderRecords()">
    <button class="btn btn-sm btn-export" onclick="exportRecordsCSV()"><i class="fas fa-download"></i> Export CSV</button>
  </div>
  <div class="cd">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-database" style="color:var(--blue)"></i> Data Pergerakan Barang</div>
      <span class="badge b-blue" id="recCount">0 record</span>
    </div>
    <div class="cd-b" style="padding:0">
      <div class="tbl-wrap" style="max-height:500px;overflow-y:auto">
        <table>
          <thead>
            <tr>
              <th>No</th><th>Tanggal</th><th>No. MRA/DO</th><th>Tipe</th>
              <th>Vendor / Perusahaan</th><th>Material</th><th>Qty</th>
              <th>Gate</th><th>No. Polisi</th><th>Status</th><th>Physical Check</th>
            </tr>
          </thead>
          <tbody id="recTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="pagi" id="recPagi" style="padding:10px 16px"></div>
  </div>
</div>

<!-- ============== SECTION 4: TRENDS ============== -->
<div class="section" id="sec-trends">
  <div class="summary-grid">
    <div class="summary-box"><div class="summary-box-num" style="color:var(--navy)">430</div><div class="summary-box-label">Total Transaksi</div></div>
    <div class="summary-box"><div class="summary-box-num" style="color:var(--red)">247</div><div class="summary-box-label">Outbound</div></div>
    <div class="summary-box"><div class="summary-box-num" style="color:var(--blue)">183</div><div class="summary-box-label">Inbound</div></div>
    <div class="summary-box"><div class="summary-box-num" style="color:var(--green)">90.5%</div><div class="summary-box-label">Approval Rate</div></div>
    <div class="summary-box"><div class="summary-box-num" style="color:var(--orange)">2.3 jam</div><div class="summary-box-label">Avg Process</div></div>
    <div class="summary-box"><div class="summary-box-num" style="color:var(--purple)">15</div><div class="summary-box-label">Unique Vendors</div></div>
  </div>
  <div class="two-col">
    <div class="cd">
      <div class="cd-h"><div class="cd-t"><i class="fas fa-chart-area" style="color:var(--teal)"></i> Tren Bulanan (6 Bulan)</div></div>
      <div class="cd-b"><div class="chart-wrap"><canvas id="chartMonthly"></canvas></div></div>
    </div>
    <div class="cd">
      <div class="cd-h"><div class="cd-t"><i class="fas fa-chart-line" style="color:var(--red)"></i> Rejection Rate Trend</div></div>
      <div class="cd-b"><div class="chart-wrap"><canvas id="chartRejection"></canvas></div></div>
    </div>
  </div>
  <div class="cd">
    <div class="cd-h"><div class="cd-t"><i class="fas fa-clock" style="color:var(--gold)"></i> Average Processing Time per Step</div></div>
    <div class="cd-b"><div class="chart-wrap" style="height:200px"><canvas id="chartProcessTime"></canvas></div></div>
  </div>
  <div class="cd">
    <div class="cd-h"><div class="cd-t"><i class="fas fa-boxes-stacked" style="color:var(--orange)"></i> Top Material Categories</div></div>
    <div class="cd-b"><div class="chart-wrap"><canvas id="chartMaterial"></canvas></div></div>
  </div>
</div>

<!-- ============== SECTION 5: MONTHLY REPORT ============== -->
<div class="section" id="sec-monthly">

  <!-- Upload Area -->
  <div class="cd">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-file-arrow-up" style="color:var(--teal)"></i> Upload Monthly Report</div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-sm btn-teal" onclick="downloadTemplate()"><i class="fas fa-download"></i> Template Excel</button>
      </div>
    </div>
    <div class="cd-b">
      <div class="template-tip">
        <i class="fas fa-info-circle"></i>
        <div>
          <b>Format Excel yang didukung:</b> Kolom wajib: <b>Bulan, Tahun, Barang Keluar, Barang Masuk, Approved, Rejected, Exception, Pending</b>.
          Download template untuk format yang benar.
        </div>
      </div>
      <div class="upload-zone" id="uploadZone" ondragover="onDrag(event,true)" ondragleave="onDrag(event,false)" ondrop="onDrop(event)">
        <input type="file" accept=".xlsx,.xls" onchange="handleFile(this.files[0])">
        <div class="upload-zone-icon"><i class="fas fa-file-excel"></i></div>
        <div class="upload-zone-title" id="uploadTitle">Drag & drop file Excel, atau klik untuk pilih</div>
        <div class="upload-zone-sub" id="uploadSub">Format: .xlsx · Maks. 5MB · Template tersedia di atas</div>
      </div>
    </div>
  </div>

  <!-- History List -->
  <div class="cd">
    <div class="cd-h">
      <div class="cd-t"><i class="fas fa-history" style="color:var(--navy)"></i> Riwayat Monthly Report</div>
      <span class="badge b-blue" id="monthlyCount">0 laporan</span>
    </div>
    <div class="cd-b" id="monthlyHistList">
      <div class="empty-state">
        <i class="fas fa-folder-open"></i>
        <p>Belum ada monthly report</p>
        <span>Upload file Excel laporan bulanan untuk mulai monitoring tren lalu lintas barang</span>
      </div>
    </div>
  </div>

  <!-- Detail Panel (muncul saat laporan dipilih) -->
  <div class="monthly-detail" id="monthlyDetail">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div>
        <div style="font-size:15px;font-weight:800" id="detailTitle">-</div>
        <div style="font-size:11px;color:var(--muted);margin-top:2px" id="detailMeta">-</div>
      </div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-sm btn-export" onclick="exportMonthlyExcel()"><i class="fas fa-file-excel"></i> Export</button>
        <button class="btn btn-sm" style="background:var(--bg);color:var(--txt2);border:1px solid var(--bdr)" onclick="closeDetail()"><i class="fas fa-times"></i></button>
      </div>
    </div>

    <!-- KPI Bulan Ini -->
    <div class="monthly-kpi" id="detailKpi"></div>

    <!-- Grafik Tren -->
    <div class="two-col">
      <div class="cd" style="margin-bottom:0">
        <div class="cd-h"><div class="cd-t"><i class="fas fa-chart-bar" style="color:var(--blue)"></i> Lalu Lintas Barang Bulanan</div></div>
        <div class="cd-b"><div class="chart-wrap"><canvas id="chartMonthlyTraffic"></canvas></div></div>
      </div>
      <div class="cd" style="margin-bottom:0">
        <div class="cd-h"><div class="cd-t"><i class="fas fa-chart-pie" style="color:var(--green)"></i> Distribusi Status</div></div>
        <div class="cd-b">
          <div class="donut-wrap">
            <div class="donut-chart"><canvas id="chartMonthlyStatus"></canvas></div>
            <div class="donut-legend" id="monthlyStatusLegend"></div>
          </div>
        </div>
      </div>
    </div>

    <div style="margin-top:14px">
      <div class="cd" style="margin-bottom:0">
        <div class="cd-h"><div class="cd-t"><i class="fas fa-chart-line" style="color:var(--orange)"></i> Tren Approval Rate & Exception Rate</div></div>
        <div class="cd-b"><div class="chart-wrap"><canvas id="chartMonthlyRate"></canvas></div></div>
      </div>
    </div>

    <!-- Tabel detail per bulan -->
    <div class="cd" style="margin-top:14px;margin-bottom:0">
      <div class="cd-h"><div class="cd-t"><i class="fas fa-table" style="color:var(--navy)"></i> Data Per Bulan</div></div>
      <div class="cd-b" style="padding:0">
        <div class="tbl-wrap">
          <table>
            <thead>
              <tr>
                <th>Bulan</th><th>Keluar (MRA)</th><th>Masuk (DO)</th><th>Total</th>
                <th>Approved</th><th>Rejected</th><th>Exception</th><th>Pending</th>
                <th>Approval Rate</th><th>vs Bulan Lalu</th>
              </tr>
            </thead>
            <tbody id="monthlyTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div><!-- /sec-monthly -->
</div><!-- /main -->

<script>
// ===== CLOCK =====
function uc(){const t=new Date().toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit',timeZone:'Asia/Makassar'})+' WITA';document.getElementById('clock').textContent=t}
uc();setInterval(uc,30000);

// ===== TABS =====
function showTab(id,el){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('on'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.getElementById('sec-'+id).classList.add('on');
  el.classList.add('on');
  if(id==='dashboard')initDashboardCharts();
  if(id==='trends')initTrendCharts();
  if(id==='audit')renderAudit();
  if(id==='records')renderRecords();
  if(id==='monthly')renderMonthlyList();
}

// ===== DUMMY DATA =====
const auditData=[
  {id:'MRA-2026-0217-001',type:'submit',role:'Creator',user:'Andi Pratama',vendor:'PT Sumber Makmur',time:'2026-02-17T08:32:00',desc:'MRA disubmit untuk persetujuan'},
  {id:'MRA-2026-0217-001',type:'approve',role:'Section Head Area',user:'Budi Santoso',vendor:'PT Sumber Makmur',time:'2026-02-17T09:15:00',desc:'Disetujui — Material scope valid'},
  {id:'MRA-2026-0217-002',type:'exception',role:'Creator',user:'Citra Dewi',vendor:'CV Maju Jaya',time:'2026-02-17T10:00:00',desc:'Exception urgent diajukan'},
  {id:'MRA-2026-0217-003',type:'reject',role:'Legality Officer',user:'Deni Kurniawan',vendor:'PT Teknindo',time:'2026-02-17T11:30:00',desc:'Ditolak — Dokumen tidak lengkap'},
  {id:'DO-2026-0217-001',type:'verify',role:'Gate Inspector',user:'Eko Prasetyo',vendor:'PT Logistik Prima',time:'2026-02-17T13:00:00',desc:'Physical check selesai — OK'},
  {id:'MRA-2026-0216-005',type:'stamp',role:'Legality Officer',user:'Fajar Rahman',vendor:'CV Berkah',time:'2026-02-16T15:20:00',desc:'Stamp Legality diterapkan'},
  {id:'DO-2026-0216-002',type:'gate_pass',role:'Gate Inspector',user:'Gunawan',vendor:'PT Bintang Mas',time:'2026-02-16T16:45:00',desc:'Gate pass diterbitkan'},
  {id:'MRA-2026-0215-010',type:'approve',role:'Section Head Area',user:'Hendra Wijaya',vendor:'PT Mitra Abadi',time:'2026-02-15T09:00:00',desc:'Approved — Prioritas tinggi'},
];

const recordData=[
  {tgl:'2026-02-17',no:'MRA-2026-0217-001',tipe:'keluar',vendor:'PT Sumber Makmur',material:'Pipa Baja DN200',qty:'12 pcs',gate:'Gate 1 Utara',polisi:'KT 4521 AB',status:'Approved',phys:'OK'},
  {tgl:'2026-02-17',no:'DO-2026-0217-001',tipe:'masuk',vendor:'PT Logistik Prima',material:'Valve Gate 8"',qty:'24 pcs',gate:'Gate 2 Selatan',polisi:'KT 7832 CD',status:'Completed',phys:'OK'},
  {tgl:'2026-02-17',no:'MRA-2026-0217-002',tipe:'keluar',vendor:'CV Maju Jaya',material:'Scaffolding Set',qty:'5 set',gate:'Gate 3 Timur',polisi:'KT 1234 EF',status:'Exception',phys:'Pending'},
  {tgl:'2026-02-16',no:'MRA-2026-0216-005',tipe:'keluar',vendor:'CV Berkah',material:'Cat Anti Karat',qty:'200 kg',gate:'Gate 1 Utara',polisi:'KT 5678 GH',status:'Completed',phys:'OK'},
  {tgl:'2026-02-16',no:'DO-2026-0216-002',tipe:'masuk',vendor:'PT Bintang Mas',material:'Pompa Centrifugal',qty:'2 unit',gate:'Gate 2 Selatan',polisi:'KT 9012 IJ',status:'Completed',phys:'OK'},
  {tgl:'2026-02-15',no:'MRA-2026-0215-010',tipe:'keluar',vendor:'PT Mitra Abadi',material:'Kabel Power 3x70mm',qty:'500 m',gate:'Gate 1 Utara',polisi:'KT 3456 KL',status:'Approved',phys:'OK'},
  {tgl:'2026-02-15',no:'MRA-2026-0215-011',tipe:'keluar',vendor:'PT Teknindo',material:'Sensor Flow',qty:'8 pcs',gate:'Gate 3 Timur',polisi:'KT 7890 MN',status:'Rejected',phys:'-'},
  {tgl:'2026-02-14',no:'DO-2026-0214-003',tipe:'masuk',vendor:'PT Sumber Makmur',material:'Elbow 90° DN150',qty:'48 pcs',gate:'Gate 2 Selatan',polisi:'KT 2345 OP',status:'Completed',phys:'OK'},
];

// ===== PAGINATION =====
let auditPage=1,recPage=1;
const PER=8;

function renderAudit(){
  const filt=document.getElementById('auditFilter').value;
  const role=document.getElementById('auditRole').value;
  const date=document.getElementById('auditDate').value;
  const srch=document.getElementById('auditSearch').value.toLowerCase();
  let d=auditData.filter(a=>{
    if(filt&&a.type!==filt)return false;
    if(role&&a.role!==role)return false;
    if(date&&!a.time.startsWith(date))return false;
    if(srch&&!(a.id.toLowerCase().includes(srch)||a.user.toLowerCase().includes(srch)||a.vendor.toLowerCase().includes(srch)))return false;
    return true;
  });
  document.getElementById('auditCount').textContent=d.length+' record';
  const start=(auditPage-1)*PER,end=Math.min(start+PER,d.length);
  const colors={submit:'#0058A3',approve:'#0D8048',reject:'#E21F26',verify:'#00838F',stamp:'#7C3AED',exception:'#EA580C',gate_pass:'#B8860B'};
  const icons={submit:'fa-paper-plane',approve:'fa-check',reject:'fa-times',verify:'fa-magnifying-glass',stamp:'fa-stamp',exception:'fa-bolt',gate_pass:'fa-door-open'};
  const labels={submit:'MRA Submit',approve:'Approved',reject:'Rejected',verify:'Verified',stamp:'Stamp Applied',exception:'Exception/Urgent',gate_pass:'Gate Pass'};
  let html=d.slice(start,end).map(a=>`
    <div class="log-item">
      <div class="log-icon" style="background:${colors[a.type]||'#9CA3AF'}"><i class="fas ${icons[a.type]||'fa-circle'}"></i></div>
      <div class="log-content">
        <div class="log-title">${labels[a.type]||a.type} — <span style="font-family:'JetBrains Mono',monospace;font-size:11px">${a.id}</span></div>
        <div class="log-meta">${a.user} · ${a.role} · ${a.vendor}<br>${a.desc}</div>
      </div>
      <div class="log-time">${a.time.substr(11,5)}<br>${a.time.substr(0,10)}</div>
    </div>`).join('');
  document.getElementById('auditList').innerHTML=html||'<div class="empty-state"><i class="fas fa-search"></i><p>Tidak ada data</p></div>';
  renderPagi('auditPagi',d.length,auditPage,p=>{auditPage=p;renderAudit();});
}

function renderRecords(){
  const tp=document.getElementById('recType').value;
  const st=document.getElementById('recStatus').value;
  const srch=document.getElementById('recSearch').value.toLowerCase();
  let d=recordData.filter(r=>{
    if(tp&&r.tipe!==tp)return false;
    if(st&&r.status!==st)return false;
    if(srch&&!(r.no.toLowerCase().includes(srch)||r.vendor.toLowerCase().includes(srch)||r.material.toLowerCase().includes(srch)))return false;
    return true;
  });
  document.getElementById('recCount').textContent=d.length+' record';
  const bmap={Completed:'b-green',Approved:'b-blue',Pending:'b-gold',Rejected:'b-red',Exception:'b-orange'};
  let html=d.slice((recPage-1)*PER,recPage*PER).map((r,i)=>`
    <tr>
      <td>${(recPage-1)*PER+i+1}</td>
      <td style="white-space:nowrap">${r.tgl}</td>
      <td><span style="font-family:'JetBrains Mono',monospace;font-size:10px">${r.no}</span></td>
      <td><span class="badge ${r.tipe==='keluar'?'b-red':'b-blue'}">${r.tipe==='keluar'?'KELUAR':'MASUK'}</span></td>
      <td>${r.vendor}</td>
      <td>${r.material}</td>
      <td style="text-align:center">${r.qty}</td>
      <td>${r.gate}</td>
      <td style="font-family:'JetBrains Mono',monospace;font-size:10px">${r.polisi}</td>
      <td><span class="badge ${bmap[r.status]||'b-gray'}">${r.status}</span></td>
      <td><span class="badge ${r.phys==='OK'?'b-green':'b-gold'}">${r.phys}</span></td>
    </tr>`).join('');
  document.getElementById('recTableBody').innerHTML=html||'<tr><td colspan="11" style="text-align:center;padding:24px;color:var(--muted)">Tidak ada data</td></tr>';
  renderPagi('recPagi',d.length,recPage,p=>{recPage=p;renderRecords();});
}

function renderPagi(id,total,cur,cb){
  const pages=Math.ceil(total/PER);
  if(pages<=1){document.getElementById(id).innerHTML='';return;}
  let html=`<span>${(cur-1)*PER+1}–${Math.min(cur*PER,total)} dari ${total}</span><div class="pagi-btns">`;
  for(let i=1;i<=pages;i++)html+=`<div class="pagi-btn${i===cur?' on':''}" onclick="(${cb})(${i})">${i}</div>`;
  html+='</div>';
  document.getElementById(id).innerHTML=html;
}

// ===== DASHBOARD CHARTS =====
let charts={};
function destroyChart(id){if(charts[id]){charts[id].destroy();delete charts[id];}}

function initDashboardCharts(){
  setTimeout(()=>{
    destroyChart('daily');destroyChart('donut');destroyChart('gate');
    updateDailyChart();
    const donutCtx=document.getElementById('chartDonut').getContext('2d');
    charts['donut']=new Chart(donutCtx,{type:'doughnut',data:{labels:['Approved','Exception','Rejected','Pending'],datasets:[{data:[389,23,11,7],backgroundColor:['#0D8048','#EA580C','#E21F26','#B8860B'],borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false}}}});
    const leg=document.getElementById('donutLegend');
    const cols=['#0D8048','#EA580C','#E21F26','#B8860B'];
    const labs=[['Approved','389','90.5%'],['Exception','23','5.3%'],['Rejected','11','2.6%'],['Pending','7','1.6%']];
    leg.innerHTML=labs.map((l,i)=>`<div class="donut-legend-item"><div class="donut-legend-dot" style="background:${cols[i]}"></div><div><div style="font-weight:700;font-size:12px">${l[0]}</div><div style="font-size:10px;color:var(--muted)">${l[1]} transaksi · ${l[2]}</div></div></div>`).join('');
    const gateCtx=document.getElementById('chartGate').getContext('2d');
    charts['gate']=new Chart(gateCtx,{type:'bar',data:{labels:['Gate 1\nUtara','Gate 2\nSelatan','Gate 3\nTimur','Gate 4\nBarat'],datasets:[{label:'Keluar',data:[98,67,52,30],backgroundColor:'#E21F26'},{label:'Masuk',data:[72,55,38,18],backgroundColor:'#0058A3'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10}}}},scales:{x:{ticks:{font:{size:9}}},y:{ticks:{font:{size:9}}}}}});
    const tv=document.getElementById('topVendors');
    const vendors=[{n:'PT Sumber Makmur',v:87,c:'#E21F26'},{n:'PT Logistik Prima',v:64,c:'#0058A3'},{n:'CV Maju Jaya',v:52,c:'#0D8048'},{n:'PT Teknindo',v:43,c:'#EA580C'},{n:'PT Mitra Abadi',v:38,c:'#7C3AED'}];
    tv.innerHTML=vendors.map(v=>`<div style="margin-bottom:10px"><div style="display:flex;justify-content:space-between;font-size:11px;font-weight:600;margin-bottom:4px"><span>${v.n}</span><span>${v.v}</span></div><div style="height:6px;background:#F3F4F6;border-radius:4px"><div style="width:${v.v/87*100}%;height:100%;background:${v.c};border-radius:4px"></div></div></div>`).join('');
  },100);
}

function updateDailyChart(){
  const p=parseInt(document.getElementById('chartPeriod').value);
  const labels=[],dataOut=[],dataIn=[];
  for(let i=p-1;i>=0;i--){
    const d=new Date();d.setDate(d.getDate()-i);
    labels.push(d.toLocaleDateString('id-ID',{day:'2-digit',month:'short'}));
    dataOut.push(Math.floor(Math.random()*8+8));
    dataIn.push(Math.floor(Math.random()*6+5));
  }
  destroyChart('daily');
  const ctx=document.getElementById('chartDaily').getContext('2d');
  charts['daily']=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Keluar',data:dataOut,backgroundColor:'rgba(226,31,38,.75)',borderRadius:4},{label:'Masuk',data:dataIn,backgroundColor:'rgba(0,88,163,.75)',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10}}}},scales:{x:{ticks:{font:{size:9},maxRotation:45}},y:{ticks:{font:{size:9}}}}}});
}

function initTrendCharts(){
  setTimeout(()=>{
    destroyChart('monthly');destroyChart('rejection');destroyChart('process');destroyChart('material');
    const months=['Sep','Okt','Nov','Des','Jan','Feb'];
    const mCtx=document.getElementById('chartMonthly').getContext('2d');
    charts['monthly']=new Chart(mCtx,{type:'line',data:{labels:months,datasets:[{label:'Keluar',data:[198,212,225,238,243,247],borderColor:'#E21F26',backgroundColor:'rgba(226,31,38,.1)',fill:true,tension:.4},{label:'Masuk',data:[145,158,162,175,179,183],borderColor:'#0058A3',backgroundColor:'rgba(0,88,163,.1)',fill:true,tension:.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10}}}},scales:{x:{ticks:{font:{size:10}}},y:{ticks:{font:{size:10}}}}}});
    const rCtx=document.getElementById('chartRejection').getContext('2d');
    charts['rejection']=new Chart(rCtx,{type:'line',data:{labels:months,datasets:[{label:'Rejection Rate (%)',data:[3.8,3.2,2.9,2.7,2.6,2.6],borderColor:'#E21F26',backgroundColor:'rgba(226,31,38,.1)',fill:true,tension:.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10}}}},scales:{x:{ticks:{font:{size:10}}},y:{ticks:{font:{size:10},callback:v=>v+'%'}}}}});
    const pCtx=document.getElementById('chartProcessTime').getContext('2d');
    charts['process']=new Chart(pCtx,{type:'bar',data:{labels:['Creator→SHA','SHA→Legality','Legality→Gate','Gate Check'],datasets:[{label:'Rata-rata (jam)',data:[1.2,0.8,0.5,0.3],backgroundColor:['#0058A3','#0D8048','#EA580C','#7C3AED'],borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,indexAxis:'y',plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:9},callback:v=>v+'j'}},y:{ticks:{font:{size:9}}}}}});
    const matCtx=document.getElementById('chartMaterial').getContext('2d');
    charts['material']=new Chart(matCtx,{type:'bar',data:{labels:['Pipa & Fitting','Valve & Instrumen','Kabel & Elektrik','Scaffolding','Chemical','Mechanical','Lainnya'],datasets:[{label:'Qty Transaksi',data:[87,64,52,43,38,29,24],backgroundColor:'rgba(0,88,163,.7)',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:9},maxRotation:30}},y:{ticks:{font:{size:9}}}}}});
  },100);
}

// ===== MONTHLY REPORT =====
const MONTHLY_KEY='mfps_monthly_reports';

function loadMonthlyReports(){
  try{return JSON.parse(localStorage.getItem(MONTHLY_KEY)||'[]');}catch{return[];}
}
function saveMonthlyReports(d){localStorage.setItem(MONTHLY_KEY,JSON.stringify(d));}

function onDrag(e,on){e.preventDefault();document.getElementById('uploadZone').classList.toggle('drag',on);}
function onDrop(e){e.preventDefault();onDrag(e,false);if(e.dataTransfer.files[0])handleFile(e.dataTransfer.files[0]);}

function handleFile(file){
  if(!file)return;
  if(!file.name.match(/\.(xlsx|xls)$/i)){alert('⚠ Format tidak didukung. Gunakan file .xlsx atau .xls');return;}
  if(file.size>10*1024*1024){alert('⚠ File terlalu besar. Maksimum 10MB');return;}
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const wb=XLSX.read(e.target.result,{type:'array'});
      // Deteksi tipe file: rekap bulanan atau data harian
      parseExcelAuto(wb,file.name);
    }catch(err){alert('⚠ Gagal membaca file: '+err.message);}
  };
  reader.readAsArrayBuffer(file);
}

function parseExcelAuto(wb,filename){
  // Deteksi apakah ini file harian (ada kolom tanggal/hari) atau rekap bulanan
  let allSheetData=[];

  wb.SheetNames.forEach(sheetName=>{
    const ws=wb.Sheets[sheetName];
    // Coba baca mulai dari baris 1, 8, atau 9 (handle header di tengah)
    let rows=null;
    for(let startRow of [1,7,8,9]){
      const r=XLSX.utils.sheet_to_json(ws,{range:startRow-1,defval:'',raw:false});
      if(r.length>0){
        // Cek apakah header bermakna (bukan judul)
        const firstKey=Object.keys(r[0]||{})[0]||'';
        if(firstKey.toLowerCase().includes('no')||firstKey.toLowerCase().includes('hari')||
           firstKey.toLowerCase().includes('bulan')||firstKey.toLowerCase().includes('tanggal')){
          rows=r;break;
        }
      }
    }
    if(!rows||!rows.length)return;

    // Normalisasi keys
    const norm=rows.map(r=>{
      const out={};
      Object.keys(r).forEach(k=>out[k.toLowerCase().trim().replace(/\s+/g,'_')]=r[k]);
      return out;
    });
    allSheetData.push({sheet:sheetName,rows:norm});
  });

  if(!allSheetData.length){alert('⚠ Tidak ada data yang bisa dibaca dari file ini.');return;}

  // Deteksi apakah data harian atau rekap
  const sample=allSheetData[0].rows[0]||{};
  const keys=Object.keys(sample).join(' ').toLowerCase();
  const isHarian=keys.includes('hari')||keys.includes('tanggal')||keys.includes('manifest')||keys.includes('kontrak')||keys.includes('waktu');

  if(isHarian){
    processHarianData(allSheetData,filename);
  } else {
    processRekapData(allSheetData,filename);
  }
}

// Ekstrak bulan dari string tanggal seperti "Senin, 19/01/2026" atau "19/01/2026"
function extractBulan(tglStr){
  if(!tglStr)return null;
  const s=String(tglStr);
  // Format DD/MM/YYYY
  const m=s.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
  if(m)return{bulan:parseInt(m[2]),tahun:parseInt(m[3]),tgl:parseInt(m[1])};
  return null;
}

const NAMA_BULAN=['','Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];

function processHarianData(allSheetData,filename){
  // Agregasi per bulan dari data harian
  // Bisa multi-sheet (Barang Masuk, Barang Keluar)
  const byMonth={}; // key: "YYYY-MM"

  allSheetData.forEach(({sheet,rows})=>{
    const sheetLower=sheet.toLowerCase();
    const isMasuk=sheetLower.includes('masuk');
    const isKeluar=sheetLower.includes('keluar');

    rows.forEach(r=>{
      // Cari kolom tanggal
      const tglVal=r['hari/tanggal']||r['hari_/_tanggal']||r['tanggal']||r['hari']||r[' hari_/_tanggal']||'';
      const parsed=extractBulan(String(tglVal));
      if(!parsed)return;

      const key=`${parsed.tahun}-${String(parsed.bulan).padStart(2,'0')}`;
      if(!byMonth[key])byMonth[key]={bulan:parsed.bulan,tahun:parsed.tahun,masuk:0,keluar:0,vendors:new Set(),barangs:new Set(),gates:new Set()};

      if(isMasuk||(!isKeluar&&!isMasuk)){
        // Untuk file yang hanya MASUK
        byMonth[key].masuk++;
        const vendor=r['perusahaan']||r['vendor']||r['nama_perusahaan']||'';
        const barang=r['nama_barang']||r['barang']||r['material']||'';
        const gate=r['tujuan']||r['dari']||'';
        if(vendor)byMonth[key].vendors.add(String(vendor));
        if(barang)byMonth[key].barangs.add(String(barang));
        if(gate)byMonth[key].gates.add(String(gate));
      }
      if(isKeluar){
        byMonth[key].keluar++;
        const vendor=r['vendor']||r['perusahaan']||r['vendor_']||'';
        const barang=r['nama_barang']||r['barang']||'';
        if(vendor)byMonth[key].vendors.add(String(vendor));
        if(barang)byMonth[key].barangs.add(String(barang));
      }
    });
  });

  // Kalau file hanya Masuk atau hanya Keluar — deteksi dari nama file
  const fLower=filename.toLowerCase();
  const fileIsMasuk=fLower.includes('masuk');
  const fileIsKeluar=fLower.includes('keluar');
  if(fileIsMasuk||fileIsKeluar){
    Object.values(byMonth).forEach(m=>{
      if(fileIsMasuk&&m.keluar===0&&m.masuk>0){/* ok */}
      if(fileIsKeluar&&m.masuk===0){m.keluar=m.masuk;m.masuk=0;}
      // Handle file keluar yang counter-nya masuk
      if(fileIsKeluar){const tmp=m.masuk;m.masuk=0;m.keluar=tmp>0?tmp:m.keluar;}
    });
  }

  // Sort by bulan
  const sorted=Object.entries(byMonth).sort((a,b)=>a[0].localeCompare(b[0])).map(([,v])=>v);

  // Build rows untuk detail table
  const rows=sorted.map(m=>({
    bulan:NAMA_BULAN[m.bulan]||m.bulan,
    tahun:m.tahun,
    'barang_keluar':fileIsMasuk?0:m.keluar||m.masuk,
    'barang_masuk':fileIsKeluar?0:m.masuk||m.keluar,
    approved:0,rejected:0,exception:0,pending:0,
    _vendors:m.vendors.size,
    _barangs:m.barangs.size
  }));

  // Kalau multi-sheet (kedua ada), gabungkan
  if(allSheetData.length>1){
    rows.forEach(r=>{
      const key=`${r.tahun}-${String(NAMA_BULAN.indexOf(r.bulan)).padStart(2,'0')}`;
      const m=byMonth[key];
      if(m){r['barang_masuk']=m.masuk;r['barang_keluar']=m.keluar;}
    });
  }

  buildAndSaveReport(rows,filename,true);
}

function processRekapData(allSheetData,filename){
  // Format rekap bulanan (template)
  const rows=allSheetData[0].rows.filter(r=>{
    const b=r['bulan']||r['month']||'';
    return b&&String(b).length>0;
  });
  if(!rows.length){alert('⚠ Tidak ada data bulan yang ditemukan.');return;}
  buildAndSaveReport(rows,filename,false);
}

function buildAndSaveReport(rows,filename,isHarian){
  const reports=loadMonthlyReports();
  const id='RPT-'+Date.now();
  const uploadedAt=new Date().toISOString();

  let totalKeluar=0,totalMasuk=0,totalApproved=0,totalRejected=0,totalException=0,totalPending=0;
  rows.forEach(r=>{
    totalKeluar+=Number(r['barang_keluar']||r['barang_keluar']||r['barang keluar']||r['keluar']||r['mra']||0);
    totalMasuk+=Number(r['barang_masuk']||r['barang_masuk']||r['barang masuk']||r['masuk']||r['do']||0);
    totalApproved+=Number(r['approved']||r['approve']||0);
    totalRejected+=Number(r['rejected']||r['reject']||0);
    totalException+=Number(r['exception']||r['urgent']||0);
    totalPending+=Number(r['pending']||0);
  });

  const total=totalKeluar+totalMasuk;
  const report={
    id,filename,uploadedAt,rows,isHarian,
    summary:{totalKeluar,totalMasuk,totalApproved,totalRejected,totalException,totalPending,
      total,approvalRate:totalApproved+totalRejected>0?((totalApproved/(totalApproved+totalRejected))*100).toFixed(1):'-'}
  };

  reports.unshift(report);
  if(reports.length>24)reports.pop();
  saveMonthlyReports(reports);

  // Update UI
  const uz=document.getElementById('uploadZone');
  uz.classList.add('has-file');
  document.getElementById('uploadTitle').textContent='✅ '+filename+' berhasil diupload';
  document.getElementById('uploadSub').textContent='Data diproses — '+norm.length+' bulan data ditemukan';
  setTimeout(()=>{uz.classList.remove('has-file');document.getElementById('uploadTitle').textContent='Drag & drop file Excel, atau klik untuk pilih';document.getElementById('uploadSub').textContent='Format: .xlsx · Maks. 5MB · Template tersedia di atas';},3000);

  renderMonthlyList();
  showMonthlyDetail(report);
}

function renderMonthlyList(){
  const reports=loadMonthlyReports();
  document.getElementById('monthlyCount').textContent=reports.length+' laporan';
  if(!reports.length){
    document.getElementById('monthlyHistList').innerHTML=`<div class="empty-state"><i class="fas fa-folder-open"></i><p>Belum ada monthly report</p><span>Upload file Excel laporan bulanan untuk mulai monitoring tren lalu lintas barang</span></div>`;
    return;
  }
  const html=reports.map(r=>`
    <div class="monthly-hist-item" id="hist-${r.id}" onclick="showMonthlyDetail(loadReportById('${r.id}'))">
      <div class="hist-icon"><i class="fas fa-file-excel"></i></div>
      <div class="hist-info">
        <div class="hist-title">${r.filename}</div>
        <div class="hist-meta">Diupload: ${new Date(r.uploadedAt).toLocaleString('id-ID')} · ${r.rows.length} bulan data</div>
        <div class="hist-stats">
          <span class="hist-stat" style="background:#FEE2E2;color:#991B1B">↑ ${r.summary.totalKeluar} Keluar</span>
          <span class="hist-stat" style="background:#DBEAFE;color:#1E40AF">↓ ${r.summary.totalMasuk} Masuk</span>
          <span class="hist-stat" style="background:#D1FAE5;color:#065F46">✓ ${r.summary.approvalRate}% Approved</span>
        </div>
      </div>
      <div class="hist-actions">
        <button class="btn btn-sm" style="background:var(--bg);color:var(--red);border:1px solid var(--bdr)" onclick="event.stopPropagation();deleteReport('${r.id}')"><i class="fas fa-trash"></i></button>
      </div>
    </div>`).join('');
  document.getElementById('monthlyHistList').innerHTML=`<div class="monthly-hist">${html}</div>`;
}

function loadReportById(id){
  return loadMonthlyReports().find(r=>r.id===id);
}

function deleteReport(id){
  if(!confirm('Hapus laporan ini?'))return;
  const reports=loadMonthlyReports().filter(r=>r.id!==id);
  saveMonthlyReports(reports);
  document.getElementById('monthlyDetail').classList.remove('on');
  renderMonthlyList();
}

let monthlyCharts={};
function destroyMonthlyChart(id){if(monthlyCharts[id]){monthlyCharts[id].destroy();delete monthlyCharts[id];}}

function showMonthlyDetail(report){
  if(!report)return;
  // Highlight aktif
  document.querySelectorAll('.monthly-hist-item').forEach(el=>el.classList.remove('active'));
  const el=document.getElementById('hist-'+report.id);
  if(el)el.classList.add('active');

  const det=document.getElementById('monthlyDetail');
  det.classList.add('on');
  document.getElementById('detailTitle').textContent='📊 '+report.filename;
  document.getElementById('detailMeta').textContent=report.rows.length+' bulan · '+new Date(report.uploadedAt).toLocaleString('id-ID');

  // KPI
  const s=report.summary;
  const kpis=[
    {num:s.totalKeluar,label:'Total Keluar (MRA)',color:'var(--red)',icon:'fa-arrow-up'},
    {num:s.totalMasuk,label:'Total Masuk (DO)',color:'var(--blue)',icon:'fa-arrow-down'},
    {num:s.totalApproved,label:'Total Approved',color:'var(--green)',icon:'fa-check-circle'},
    {num:s.approvalRate+'%',label:'Approval Rate',color:'var(--teal)',icon:'fa-chart-pie'},
    {num:s.totalRejected,label:'Total Rejected',color:'var(--red)',icon:'fa-times-circle'},
    {num:s.totalException,label:'Exception/Urgent',color:'var(--orange)',icon:'fa-bolt'},
    {num:s.totalPending,label:'Pending Review',color:'var(--gold)',icon:'fa-clock'},
    {num:s.total,label:'Total Transaksi',color:'var(--navy)',icon:'fa-layer-group'},
  ];
  document.getElementById('detailKpi').innerHTML=kpis.map(k=>`
    <div class="kpi-box">
      <div class="kpi-num" style="color:${k.color}">${k.num}</div>
      <div class="kpi-label"><i class="fas ${k.icon}" style="margin-right:3px"></i>${k.label}</div>
    </div>`).join('');

  // Labels & data dari rows
  const rows=report.rows;
  const labels=rows.map(r=>{
    const b=r['bulan']||r['month']||'';
    const t=r['tahun']||r['year']||'';
    return b&&t?`${b} ${t}`:b||String(t)||'-';
  });
  const dataKeluar=rows.map(r=>Number(r['barang_keluar']||r['barang keluar']||r['keluar']||r['mra']||0));
  const dataMasuk=rows.map(r=>Number(r['barang_masuk']||r['barang masuk']||r['masuk']||r['do']||0));
  const dataApproved=rows.map(r=>Number(r['approved']||r['approve']||0));
  const dataRejected=rows.map(r=>Number(r['rejected']||r['reject']||0));
  const dataException=rows.map(r=>Number(r['exception']||r['urgent']||0));
  const dataPending=rows.map(r=>Number(r['pending']||0));
  const dataApprRate=dataApproved.map((a,i)=>{
    const tot=a+(dataRejected[i]||0);
    return tot>0?((a/tot)*100).toFixed(1):0;
  });
  const dataExcRate=rows.map((r,i)=>{
    const tot=dataKeluar[i]+dataMasuk[i];
    return tot>0?((dataException[i]/tot)*100).toFixed(1):0;
  });

  setTimeout(()=>{
    // Chart traffic
    destroyMonthlyChart('traffic');
    const tCtx=document.getElementById('chartMonthlyTraffic').getContext('2d');
    monthlyCharts['traffic']=new Chart(tCtx,{type:'bar',data:{labels,datasets:[{label:'Keluar (MRA)',data:dataKeluar,backgroundColor:'rgba(226,31,38,.75)',borderRadius:4},{label:'Masuk (DO)',data:dataMasuk,backgroundColor:'rgba(0,88,163,.75)',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10}}}},scales:{x:{ticks:{font:{size:9},maxRotation:45}},y:{ticks:{font:{size:9}}}}}});

    // Chart status donut
    destroyMonthlyChart('status');
    const sCtx=document.getElementById('chartMonthlyStatus').getContext('2d');
    monthlyCharts['status']=new Chart(sCtx,{type:'doughnut',data:{labels:['Approved','Rejected','Exception','Pending'],datasets:[{data:[s.totalApproved,s.totalRejected,s.totalException,s.totalPending],backgroundColor:['#0D8048','#E21F26','#EA580C','#B8860B'],borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false}}}});
    const mLeg=document.getElementById('monthlyStatusLegend');
    const mCols=['#0D8048','#E21F26','#EA580C','#B8860B'];
    const mLabs=[['Approved',s.totalApproved],['Rejected',s.totalRejected],['Exception',s.totalException],['Pending',s.totalPending]];
    mLeg.innerHTML=mLabs.map((l,i)=>`<div class="donut-legend-item"><div class="donut-legend-dot" style="background:${mCols[i]}"></div><div><div style="font-weight:700;font-size:12px">${l[0]}</div><div style="font-size:10px;color:var(--muted)">${l[1]} transaksi</div></div></div>`).join('');

    // Chart rate trend
    destroyMonthlyChart('rate');
    const rCtx=document.getElementById('chartMonthlyRate').getContext('2d');
    monthlyCharts['rate']=new Chart(rCtx,{type:'line',data:{labels,datasets:[{label:'Approval Rate (%)',data:dataApprRate,borderColor:'#0D8048',backgroundColor:'rgba(13,128,72,.08)',fill:true,tension:.4,yAxisID:'y'},{label:'Exception Rate (%)',data:dataExcRate,borderColor:'#EA580C',backgroundColor:'rgba(234,88,12,.08)',fill:true,tension:.4,yAxisID:'y'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{font:{size:10}}}},scales:{x:{ticks:{font:{size:9},maxRotation:45}},y:{ticks:{font:{size:9},callback:v=>v+'%'}}}}});
  },150);

  // Tabel per bulan
  let prev=null;
  const tbody=rows.map((r,i)=>{
    const keluar=dataKeluar[i],masuk=dataMasuk[i],tot=keluar+masuk;
    const appr=dataApproved[i],rej=dataRejected[i],exc=dataException[i],pen=dataPending[i];
    const rate=appr+rej>0?((appr/(appr+rej))*100).toFixed(1)+' %':'-';
    let vs='-';
    if(prev!==null){const d=tot-prev;vs=`<span style="color:${d>=0?'var(--green)':'var(--red)'};font-weight:700">${d>=0?'+':''}${d}</span>`;}
    prev=tot;
    return`<tr>
      <td><b>${labels[i]}</b></td>
      <td style="text-align:center;color:var(--red);font-weight:700">${keluar}</td>
      <td style="text-align:center;color:var(--blue);font-weight:700">${masuk}</td>
      <td style="text-align:center;font-weight:800">${tot}</td>
      <td style="text-align:center"><span class="badge b-green">${appr}</span></td>
      <td style="text-align:center"><span class="badge b-red">${rej}</span></td>
      <td style="text-align:center"><span class="badge b-orange">${exc}</span></td>
      <td style="text-align:center"><span class="badge b-gold">${pen}</span></td>
      <td style="text-align:center;font-weight:700;color:var(--green)">${rate}</td>
      <td style="text-align:center">${vs}</td>
    </tr>`;
  }).join('');
  document.getElementById('monthlyTableBody').innerHTML=tbody;
  det.scrollIntoView({behavior:'smooth',block:'start'});
}

function closeDetail(){
  document.getElementById('monthlyDetail').classList.remove('on');
  document.querySelectorAll('.monthly-hist-item').forEach(el=>el.classList.remove('active'));
}

function exportMonthlyExcel(){
  const reports=loadMonthlyReports();
  if(!reports.length)return;
  const det=document.getElementById('monthlyDetail');
  if(!det.classList.contains('on')){alert('Pilih laporan terlebih dahulu');return;}
  // Export simple
  const active=reports.find(r=>document.getElementById('hist-'+r.id)&&document.getElementById('hist-'+r.id).classList.contains('active'));
  if(!active)return;
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.json_to_sheet(active.rows);
  XLSX.utils.book_append_sheet(wb,'Monthly Report',ws);
  XLSX.writeFile(wb,'MFPS_Monthly_'+active.uploadedAt.substr(0,10)+'.xlsx');
}

function downloadTemplate(){
  const wb=XLSX.utils.book_new();
  const data=[
    {Bulan:'Januari',Tahun:2026,'Barang Keluar':45,'Barang Masuk':32,Approved:70,Rejected:3,Exception:2,Pending:1},
    {Bulan:'Februari',Tahun:2026,'Barang Keluar':52,'Barang Masuk':38,Approved:82,Rejected:4,Exception:3,Pending:1},
    {Bulan:'Maret',Tahun:2026,'Barang Keluar':0,'Barang Masuk':0,Approved:0,Rejected:0,Exception:0,Pending:0},
  ];
  const ws=XLSX.utils.json_to_sheet(data);
  ws['!cols']=[{wch:12},{wch:8},{wch:15},{wch:14},{wch:12},{wch:12},{wch:12},{wch:10}];
  XLSX.utils.book_append_sheet(wb,'Template',ws);
  XLSX.writeFile(wb,'MFPS_Monthly_Template.xlsx');
}

// ===== EXPORT FUNCTIONS =====
function exportAllExcel(){alert('📊 Export Excel — fitur ekspor komprehensif tersedia di versi enterprise');}
function exportPDF(){alert('📄 Export PDF — fitur cetak laporan tersedia di versi enterprise');}
function exportRecordsCSV(){
  let csv='No,Tanggal,No MRA/DO,Tipe,Vendor,Material,Qty,Gate,No Polisi,Status,Physical Check\n';
  recordData.forEach((r,i)=>{csv+=`${i+1},${r.tgl},${r.no},${r.tipe},${r.vendor},${r.material},${r.qty},${r.gate},${r.polisi},${r.status},${r.phys}\n`;});
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);a.download='MFPS_Records_'+new Date().toISOString().substr(0,10)+'.csv';a.click();
}

// Init
initDashboardCharts();
renderAudit();
renderRecords();
renderMonthlyList();
</script>
</body>
</html>
